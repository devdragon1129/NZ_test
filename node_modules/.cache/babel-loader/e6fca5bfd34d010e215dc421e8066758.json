{"ast":null,"code":"import _regeneratorRuntime from \"/opt/work/NZ_test/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";\nimport _objectSpread from \"/opt/work/NZ_test/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread\";\nimport _asyncToGenerator from \"/opt/work/NZ_test/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport { Vector3, WebGLRenderer, LoadingManager, Mesh, Scene, Box3, OrthographicCamera, Geometry, BufferGeometry, DirectionalLight, AmbientLight, RectAreaLight, MeshStandardMaterial } from 'three';\nimport { basename } from 'path';\nimport { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader';\nimport { EMOTE_ERROR, getScreenshot } from './getScreenshot';\nimport { ItemType } from 'modules/item/types'; // transparent 1x1 pixel\n\nexport var TRANSPARENT_PIXEL = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNiYAAAAAkAAxkR2eQAAAAASUVORK5CYII=';\nexport var ThumbnailType;\n\n(function (ThumbnailType) {\n  ThumbnailType[\"DEFAULT\"] = \"default\";\n  ThumbnailType[\"TOP\"] = \"top\";\n  ThumbnailType[\"FRONT\"] = \"front\";\n})(ThumbnailType || (ThumbnailType = {}));\n\nexport var EngineType;\n\n(function (EngineType) {\n  EngineType[\"THREE\"] = \"three\";\n  EngineType[\"BABYLON\"] = \"babylon\";\n})(EngineType || (EngineType = {}));\n\nexport var defaults = {\n  width: 1024,\n  height: 1024,\n  extension: '.glb',\n  engine: EngineType.THREE,\n  thumbnailType: ThumbnailType.DEFAULT\n};\nexport function getModelData(_x) {\n  return _getModelData.apply(this, arguments);\n}\n\nfunction _getModelData() {\n  _getModelData = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(url) {\n    var options,\n        _defaults$options,\n        width,\n        height,\n        mappings,\n        engine,\n        thumbnailType,\n        renderer,\n        manager,\n        materials,\n        bodies,\n        colliderTriangles,\n        loader,\n        gltf,\n        root,\n        scene,\n        camera,\n        size,\n        center,\n        ambient,\n        directional,\n        _directional,\n        _directional2,\n        rectarea,\n        info,\n        image,\n        _info,\n        _image,\n        type,\n        _args = arguments;\n\n    return _regeneratorRuntime.wrap(function _callee$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            options = _args.length > 1 && _args[1] !== undefined ? _args[1] : {};\n            // add defaults to options\n            _defaults$options = _objectSpread({}, defaults, options), width = _defaults$options.width, height = _defaults$options.height, mappings = _defaults$options.mappings, engine = _defaults$options.engine, thumbnailType = _defaults$options.thumbnailType; // setup renderer\n\n            renderer = new WebGLRenderer({\n              alpha: true\n            });\n            renderer.setSize(width, height, false);\n            renderer.domElement.style.visibility = 'hidden';\n            document.body.appendChild(renderer.domElement); // configure mappings\n\n            if (mappings) {\n              manager = new LoadingManager();\n              manager.setURLModifier(function (url) {\n                var path = basename(new URL(url.replace('blob:', '')).pathname.slice(1));\n                var key = Object.keys(mappings).find(function (key) {\n                  return key.endsWith(path);\n                });\n\n                if (key) {\n                  return mappings[key];\n                }\n\n                return url;\n              });\n            }\n\n            _context.prev = 7;\n            // load model\n            materials = 0;\n            bodies = 0;\n            colliderTriangles = 0;\n            loader = new GLTFLoader(manager);\n            _context.next = 14;\n            return new Promise(function (resolve, reject) {\n              return loader.load(url, resolve, undefined, reject);\n            });\n\n          case 14:\n            gltf = _context.sent;\n            gltf.scene.traverse(function (node) {\n              if (node instanceof Mesh) {\n                bodies++;\n\n                if (node.material) {\n                  materials++;\n                }\n\n                if (node.name.includes('_collider')) {\n                  if (node.geometry instanceof Geometry) {\n                    colliderTriangles += node.geometry.faces.length;\n                  } else if (node.geometry instanceof BufferGeometry) {\n                    var geometry = new Geometry().fromBufferGeometry(node.geometry);\n                    colliderTriangles += geometry.faces.length;\n                  }\n\n                  node.visible = false;\n                } else if (node.material instanceof MeshStandardMaterial && node.material.name.toLowerCase().includes('hair_mat')) {\n                  node.visible = false;\n                }\n              }\n            });\n            root = gltf.scene; // create scene\n\n            scene = new Scene();\n            scene.add(root); // center camera\n\n            size = new Box3().setFromObject(root).getSize(new Vector3()).length();\n            root.scale.multiplyScalar(1 / size);\n            center = new Box3().setFromObject(root).getCenter(new Vector3());\n            _context.t0 = thumbnailType;\n            _context.next = _context.t0 === ThumbnailType.FRONT ? 25 : _context.t0 === ThumbnailType.TOP ? 28 : 31;\n            break;\n\n          case 25:\n            camera = new OrthographicCamera(-0.5, 0.5, 0.5, -0.5, 0, 1000);\n            camera.position.set(center.x + 0, center.y + 0, center.z + 1);\n            return _context.abrupt(\"break\", 34);\n\n          case 28:\n            camera = new OrthographicCamera(-0.25, 0.25, 0.25, -0.25, 0, 1000);\n            camera.position.set(center.x + 0, center.y + 1, center.z + 0);\n            return _context.abrupt(\"break\", 34);\n\n          case 31:\n            camera = new OrthographicCamera(-0.5, 0.5, 0.5, -0.5, 0, 1000);\n            camera.position.set(center.x + 1, center.y + 1, center.z + 1);\n            return _context.abrupt(\"break\", 34);\n\n          case 34:\n            camera.lookAt(center);\n            camera.updateProjectionMatrix(); // light\n\n            ambient = new AmbientLight(0xffffff, 1.2);\n            scene.add(ambient);\n            _context.t1 = thumbnailType;\n            _context.next = _context.t1 === ThumbnailType.FRONT ? 41 : _context.t1 === ThumbnailType.FRONT ? 46 : 51;\n            break;\n\n          case 41:\n            directional = new DirectionalLight(0xffffff, 0.8);\n            directional.position.set(center.x + 1, center.y + 1, center.z);\n            directional.lookAt(center);\n            scene.add(directional);\n            return _context.abrupt(\"break\", 60);\n\n          case 46:\n            _directional = new DirectionalLight(0xffffff, 1);\n\n            _directional.position.set(center.x + 0, center.y + 1, center.z + 0);\n\n            _directional.lookAt(center);\n\n            scene.add(_directional);\n            return _context.abrupt(\"break\", 60);\n\n          case 51:\n            _directional2 = new DirectionalLight(0xffffff, 0.8);\n\n            _directional2.position.set(center.x + 1, center.y + 1, center.z - 1);\n\n            _directional2.lookAt(center);\n\n            scene.add(_directional2);\n            rectarea = new RectAreaLight(0xffffff, 0.5, width, height);\n            rectarea.position.set(-3, 0, 0);\n            rectarea.lookAt(center);\n            scene.add(rectarea);\n            return _context.abrupt(\"break\", 60);\n\n          case 60:\n            // render scenes\n            renderer.render(scene, camera); // remove dom element\n\n            document.body.removeChild(renderer.domElement); // return data\n\n            info = {\n              triangles: renderer.info.render.triangles + colliderTriangles,\n              materials: materials,\n              textures: renderer.info.memory.textures,\n              meshes: renderer.info.memory.geometries,\n              bodies: bodies,\n              entities: 1\n            };\n\n            if (!(engine === EngineType.THREE)) {\n              _context.next = 67;\n              break;\n            }\n\n            _context.t2 = renderer.domElement.toDataURL();\n            _context.next = 70;\n            break;\n\n          case 67:\n            _context.next = 69;\n            return getScreenshot(url, options);\n\n          case 69:\n            _context.t2 = _context.sent;\n\n          case 70:\n            image = _context.t2;\n            return _context.abrupt(\"return\", {\n              info: info,\n              image: image,\n              type: ItemType.WEARABLE\n            });\n\n          case 74:\n            _context.prev = 74;\n            _context.t3 = _context[\"catch\"](7);\n            // could not render model, default to 0 metrics and default thumnail\n            _info = {\n              triangles: 0,\n              materials: 0,\n              textures: 0,\n              meshes: 0,\n              bodies: 0,\n              entities: 1\n            };\n            _image = TRANSPARENT_PIXEL;\n            type = ItemType.WEARABLE;\n\n            if (_context.t3 instanceof Error && _context.t3.message === EMOTE_ERROR) {\n              type = ItemType.EMOTE;\n            }\n\n            return _context.abrupt(\"return\", {\n              info: _info,\n              image: _image,\n              type: type\n            });\n\n          case 81:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, _callee, null, [[7, 74]]);\n  }));\n  return _getModelData.apply(this, arguments);\n}","map":{"version":3,"sources":["/opt/work/NZ_test/src/lib/getModelData.ts"],"names":["Vector3","WebGLRenderer","LoadingManager","Mesh","Scene","Box3","OrthographicCamera","Geometry","BufferGeometry","DirectionalLight","AmbientLight","RectAreaLight","MeshStandardMaterial","basename","GLTFLoader","EMOTE_ERROR","getScreenshot","ItemType","TRANSPARENT_PIXEL","ThumbnailType","EngineType","defaults","width","height","extension","engine","THREE","thumbnailType","DEFAULT","getModelData","url","options","mappings","renderer","alpha","setSize","domElement","style","visibility","document","body","appendChild","manager","setURLModifier","path","URL","replace","pathname","slice","key","Object","keys","find","endsWith","materials","bodies","colliderTriangles","loader","Promise","resolve","reject","load","undefined","gltf","scene","traverse","node","material","name","includes","geometry","faces","length","fromBufferGeometry","visible","toLowerCase","root","add","size","setFromObject","getSize","scale","multiplyScalar","center","getCenter","FRONT","TOP","camera","position","set","x","y","z","lookAt","updateProjectionMatrix","ambient","directional","rectarea","render","removeChild","info","triangles","textures","memory","meshes","geometries","entities","toDataURL","image","type","WEARABLE","Error","message","EMOTE"],"mappings":"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","sourcesContent":["import {\n  Vector3,\n  WebGLRenderer,\n  LoadingManager,\n  Mesh,\n  Scene,\n  Box3,\n  OrthographicCamera,\n  Geometry,\n  BufferGeometry,\n  DirectionalLight,\n  AmbientLight,\n  RectAreaLight,\n  MeshStandardMaterial\n} from 'three'\nimport { basename } from 'path'\nimport { GLTFLoader, GLTF } from 'three/examples/jsm/loaders/GLTFLoader'\nimport { ModelMetrics } from 'modules/models/types'\nimport { EMOTE_ERROR, getScreenshot } from './getScreenshot'\nimport { ItemType } from 'modules/item/types'\n\n// transparent 1x1 pixel\nexport const TRANSPARENT_PIXEL =\n  'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNiYAAAAAkAAxkR2eQAAAAASUVORK5CYII='\n\nexport enum ThumbnailType {\n  DEFAULT = 'default',\n  TOP = 'top',\n  FRONT = 'front'\n}\n\nexport enum EngineType {\n  THREE = 'three',\n  BABYLON = 'babylon'\n}\n\nexport type Options = {\n  width: number\n  height: number\n  extension: string\n  engine: EngineType\n  thumbnailType: ThumbnailType\n  mappings?: Record<string, string>\n}\n\nexport const defaults: Options = {\n  width: 1024,\n  height: 1024,\n  extension: '.glb',\n  engine: EngineType.THREE,\n  thumbnailType: ThumbnailType.DEFAULT\n}\n\nexport async function getModelData(url: string, options: Partial<Options> = {}) {\n  // add defaults to options\n  const { width, height, mappings, engine, thumbnailType } = {\n    ...defaults,\n    ...options\n  }\n\n  // setup renderer\n  const renderer = new WebGLRenderer({ alpha: true })\n  renderer.setSize(width, height, false)\n  renderer.domElement.style.visibility = 'hidden'\n  document.body.appendChild(renderer.domElement)\n\n  // configure mappings\n  let manager\n  if (mappings) {\n    manager = new LoadingManager()\n    manager.setURLModifier(url => {\n      const path = basename(new URL(url.replace('blob:', '')).pathname.slice(1))\n      const key = Object.keys(mappings).find(key => key.endsWith(path))\n      if (key) {\n        return mappings[key]\n      }\n\n      return url\n    })\n  }\n\n  try {\n    // load model\n    let materials = 0\n    let bodies = 0\n    let colliderTriangles = 0\n    const loader = new GLTFLoader(manager)\n    const gltf = await new Promise<GLTF>((resolve, reject) => loader.load(url, resolve, undefined, reject))\n    gltf.scene.traverse(node => {\n      if (node instanceof Mesh) {\n        bodies++\n        if (node.material) {\n          materials++\n        }\n        if (node.name.includes('_collider')) {\n          if (node.geometry instanceof Geometry) {\n            colliderTriangles += node.geometry.faces.length\n          } else if (node.geometry instanceof BufferGeometry) {\n            const geometry = new Geometry().fromBufferGeometry(node.geometry)\n            colliderTriangles += geometry.faces.length\n          }\n          node.visible = false\n        } else if (node.material instanceof MeshStandardMaterial && node.material.name.toLowerCase().includes('hair_mat')) {\n          node.visible = false\n        }\n      }\n    })\n    const root = gltf.scene\n\n    // create scene\n    const scene = new Scene()\n    scene.add(root)\n\n    // center camera\n    let camera: OrthographicCamera\n    const size = new Box3()\n      .setFromObject(root)\n      .getSize(new Vector3())\n      .length()\n    root.scale.multiplyScalar(1 / size)\n    const center = new Box3().setFromObject(root).getCenter(new Vector3())\n    switch (thumbnailType) {\n      case ThumbnailType.FRONT: {\n        camera = new OrthographicCamera(-0.5, 0.5, 0.5, -0.5, 0, 1000)\n        camera.position.set(center.x + 0, center.y + 0, center.z + 1)\n        break\n      }\n      case ThumbnailType.TOP: {\n        camera = new OrthographicCamera(-0.25, 0.25, 0.25, -0.25, 0, 1000)\n        camera.position.set(center.x + 0, center.y + 1, center.z + 0)\n        break\n      }\n      default: {\n        camera = new OrthographicCamera(-0.5, 0.5, 0.5, -0.5, 0, 1000)\n        camera.position.set(center.x + 1, center.y + 1, center.z + 1)\n        break\n      }\n    }\n    camera.lookAt(center)\n    camera.updateProjectionMatrix()\n\n    // light\n    const ambient = new AmbientLight(0xffffff, 1.2)\n    scene.add(ambient)\n\n    switch (thumbnailType) {\n      case ThumbnailType.FRONT: {\n        const directional = new DirectionalLight(0xffffff, 0.8)\n        directional.position.set(center.x + 1, center.y + 1, center.z)\n        directional.lookAt(center)\n        scene.add(directional)\n        break\n      }\n      case ThumbnailType.FRONT: {\n        const directional = new DirectionalLight(0xffffff, 1)\n        directional.position.set(center.x + 0, center.y + 1, center.z + 0)\n        directional.lookAt(center)\n        scene.add(directional)\n        break\n      }\n      default: {\n        const directional = new DirectionalLight(0xffffff, 0.8)\n        directional.position.set(center.x + 1, center.y + 1, center.z - 1)\n        directional.lookAt(center)\n        scene.add(directional)\n        const rectarea = new RectAreaLight(0xffffff, 0.5, width, height)\n        rectarea.position.set(-3, 0, 0)\n        rectarea.lookAt(center)\n        scene.add(rectarea)\n        break\n      }\n    }\n\n    // render scenes\n    renderer.render(scene, camera)\n\n    // remove dom element\n    document.body.removeChild(renderer.domElement)\n\n    // return data\n    const info: ModelMetrics = {\n      triangles: renderer.info.render.triangles + colliderTriangles,\n      materials,\n      textures: renderer.info.memory.textures,\n      meshes: renderer.info.memory.geometries,\n      bodies,\n      entities: 1\n    }\n    const image = engine === EngineType.THREE ? renderer.domElement.toDataURL() : await getScreenshot(url, options)\n\n    return { info, image, type: ItemType.WEARABLE }\n  } catch (error) {\n    // could not render model, default to 0 metrics and default thumnail\n    const info: ModelMetrics = {\n      triangles: 0,\n      materials: 0,\n      textures: 0,\n      meshes: 0,\n      bodies: 0,\n      entities: 1\n    }\n    const image = TRANSPARENT_PIXEL\n    let type = ItemType.WEARABLE\n    if (error instanceof Error && error.message === EMOTE_ERROR) {\n      type = ItemType.EMOTE\n    }\n    return { info, image, type }\n  }\n}\n"]},"metadata":{},"sourceType":"module"}