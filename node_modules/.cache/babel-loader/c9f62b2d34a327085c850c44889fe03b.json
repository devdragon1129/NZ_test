{"ast":null,"code":"import _slicedToArray from \"/opt/work/NZ_test/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";\nimport _objectSpread from \"/opt/work/NZ_test/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread\";\nimport _regeneratorRuntime from \"/opt/work/NZ_test/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";\n\nfunction _createForOfIteratorHelper(o, allowArrayLike) { var it = typeof Symbol !== \"undefined\" && o[Symbol.iterator] || o[\"@@iterator\"]; if (!it) { if (Array.isArray(o) || (it = _unsupportedIterableToArray(o)) || allowArrayLike && o && typeof o.length === \"number\") { if (it) o = it; var i = 0; var F = function F() {}; return { s: F, n: function n() { if (i >= o.length) return { done: true }; return { done: false, value: o[i++] }; }, e: function e(_e) { throw _e; }, f: F }; } throw new TypeError(\"Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\"); } var normalCompletion = true, didErr = false, err; return { s: function s() { it = it.call(o); }, n: function n() { var step = it.next(); normalCompletion = step.done; return step; }, e: function e(_e2) { didErr = true; err = _e2; }, f: function f() { try { if (!normalCompletion && it.return != null) it.return(); } finally { if (didErr) throw err; } } }; }\n\nfunction _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === \"string\") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === \"Object\" && o.constructor) n = o.constructor.name; if (n === \"Map\" || n === \"Set\") return Array.from(o); if (n === \"Arguments\" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }\n\nfunction _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }\n\nvar _marked = /*#__PURE__*/_regeneratorRuntime.mark(editorSaga),\n    _marked2 = /*#__PURE__*/_regeneratorRuntime.mark(pollEditor),\n    _marked3 = /*#__PURE__*/_regeneratorRuntime.mark(handleEditorReady),\n    _marked4 = /*#__PURE__*/_regeneratorRuntime.mark(handleBindEditorKeyboardShortcuts),\n    _marked5 = /*#__PURE__*/_regeneratorRuntime.mark(handleUnbindEditorKeyboardShortcuts),\n    _marked6 = /*#__PURE__*/_regeneratorRuntime.mark(handleCreateEditorScene),\n    _marked7 = /*#__PURE__*/_regeneratorRuntime.mark(createNewEditorScene),\n    _marked8 = /*#__PURE__*/_regeneratorRuntime.mark(handleProvisionScene),\n    _marked9 = /*#__PURE__*/_regeneratorRuntime.mark(handleHistory),\n    _marked10 = /*#__PURE__*/_regeneratorRuntime.mark(renderScene),\n    _marked11 = /*#__PURE__*/_regeneratorRuntime.mark(handleOpenEditor),\n    _marked12 = /*#__PURE__*/_regeneratorRuntime.mark(handleCloseEditor),\n    _marked13 = /*#__PURE__*/_regeneratorRuntime.mark(handleSetGizmo),\n    _marked14 = /*#__PURE__*/_regeneratorRuntime.mark(handleTogglePreview),\n    _marked15 = /*#__PURE__*/_regeneratorRuntime.mark(handleSetEditorReady),\n    _marked16 = /*#__PURE__*/_regeneratorRuntime.mark(changeEditorState),\n    _marked17 = /*#__PURE__*/_regeneratorRuntime.mark(handleResetCamera),\n    _marked18 = /*#__PURE__*/_regeneratorRuntime.mark(handleDropItem),\n    _marked19 = /*#__PURE__*/_regeneratorRuntime.mark(handleScreenshot),\n    _marked20 = /*#__PURE__*/_regeneratorRuntime.mark(handleSetSelectEntities),\n    _marked21 = /*#__PURE__*/_regeneratorRuntime.mark(handleToggleSnapToGrid),\n    _marked22 = /*#__PURE__*/_regeneratorRuntime.mark(handlePrefetchAsset),\n    _marked23 = /*#__PURE__*/_regeneratorRuntime.mark(handleSetBodyShape),\n    _marked24 = /*#__PURE__*/_regeneratorRuntime.mark(handleFetchBaseWearables);\n\nimport { takeLatest, select, put, call, delay, take } from 'redux-saga/effects';\nimport { isLoadingType } from 'decentraland-dapps/dist/modules/loading/selectors';\nimport { updateEditor, BIND_EDITOR_KEYBOARD_SHORTCUTS, UNBIND_EDITOR_KEYBOARD_SHORTCUTS, CLOSE_EDITOR, SET_GIZMO, TOGGLE_PREVIEW, ZOOM_IN, ZOOM_OUT, RESET_CAMERA, OPEN_EDITOR, setEditorReady, setGizmo, setSelectedEntities, EDITOR_REDO, EDITOR_UNDO, TAKE_SCREENSHOT, takeScreenshot, unbindEditorKeyboardShortcuts, bindEditorKeyboardShortcuts, SET_EDITOR_READY, SET_SELECTED_ENTITIES, TOGGLE_SNAP_TO_GRID, toggleSnapToGrid, PREFETCH_ASSET, setEntitiesOutOfBoundaries, closeEditor, setEditorLoading, CREATE_EDITOR_SCENE, SET_EDITOR_LOADING, setScriptUrl, setScreenshotReady, setEditorReadOnly, setItems, SET_BODY_SHAPE, FETCH_BASE_WEARABLES_REQUEST, fetchBaseWearablesSuccess, fetchBaseWearablesFailure } from 'modules/editor/actions';\nimport { PROVISION_SCENE, updateMetrics, updateTransform, DROP_ITEM, addItem, setGround, fixLegacyNamespacesRequest, syncSceneAssetsRequest, FIX_LEGACY_NAMESPACES_SUCCESS, SYNC_SCENE_ASSETS_SUCCESS } from 'modules/scene/actions';\nimport { bindKeyboardShortcuts, unbindKeyboardShortcuts } from 'modules/keyboard/actions';\nimport { editProjectThumbnail } from 'modules/project/actions';\nimport { getCurrentScene, getEntityComponentsByType, getCurrentMetrics, getComponents } from 'modules/scene/selectors';\nimport { getCurrentProject, getCurrentBounds } from 'modules/project/selectors';\nimport { ComponentType } from 'modules/scene/types';\nimport { Gizmo, PreviewType } from 'modules/editor/types';\nimport { getLoading } from 'modules/assetPack/selectors';\nimport { GROUND_CATEGORY } from 'modules/asset/types';\nimport { store } from 'modules/common/store';\nimport { PARCEL_SIZE } from 'modules/project/constants';\nimport { snapToBounds, getSceneByProjectId } from 'modules/scene/utils';\nimport { getEditorShortcuts } from 'modules/keyboard/utils';\nimport { THUMBNAIL_PATH } from 'modules/assetPack/utils';\nimport { getCurrentPool } from 'modules/pool/selectors';\nimport { loadAssetPacksRequest, LOAD_ASSET_PACKS_SUCCESS, LOAD_ASSET_PACKS_REQUEST } from 'modules/assetPack/actions';\nimport { getContentsStorageUrl } from 'lib/api/builder';\nimport { PEER_URL } from 'lib/api/peer';\nimport { getGizmo, getSelectedEntityIds, getSceneMappings, isLoading, isReady, isPreviewing, isReadOnly, getEntitiesOutOfBoundaries, hasLoadedAssetPacks, isMultiselectEnabled, getVisibleItems } from './selectors';\nimport { getNewEditorScene, resizeScreenshot, snapScale, createReadyOnlyScene, areEqualTransforms, THUMBNAIL_WIDTH, THUMBNAIL_HEIGHT, POSITION_GRID_RESOLUTION, SCALE_GRID_RESOLUTION, ROTATION_GRID_RESOLUTION, fromCatalystWearableToWearable } from './utils';\nvar editorWindow = window;\nexport function editorSaga() {\n  return _regeneratorRuntime.wrap(function editorSaga$(_context) {\n    while (1) {\n      switch (_context.prev = _context.next) {\n        case 0:\n          _context.next = 2;\n          return takeLatest(BIND_EDITOR_KEYBOARD_SHORTCUTS, handleBindEditorKeyboardShortcuts);\n\n        case 2:\n          _context.next = 4;\n          return takeLatest(UNBIND_EDITOR_KEYBOARD_SHORTCUTS, handleUnbindEditorKeyboardShortcuts);\n\n        case 4:\n          _context.next = 6;\n          return takeLatest(OPEN_EDITOR, handleOpenEditor);\n\n        case 6:\n          _context.next = 8;\n          return takeLatest(CLOSE_EDITOR, handleCloseEditor);\n\n        case 8:\n          _context.next = 10;\n          return takeLatest(PROVISION_SCENE, handleProvisionScene);\n\n        case 10:\n          _context.next = 12;\n          return takeLatest(EDITOR_REDO, handleHistory);\n\n        case 12:\n          _context.next = 14;\n          return takeLatest(EDITOR_UNDO, handleHistory);\n\n        case 14:\n          _context.next = 16;\n          return takeLatest(SET_GIZMO, handleSetGizmo);\n\n        case 16:\n          _context.next = 18;\n          return takeLatest(TOGGLE_PREVIEW, handleTogglePreview);\n\n        case 18:\n          _context.next = 20;\n          return takeLatest(ZOOM_IN, handleZoomIn);\n\n        case 20:\n          _context.next = 22;\n          return takeLatest(ZOOM_OUT, handleZoomOut);\n\n        case 22:\n          _context.next = 24;\n          return takeLatest(RESET_CAMERA, handleResetCamera);\n\n        case 24:\n          _context.next = 26;\n          return takeLatest(DROP_ITEM, handleDropItem);\n\n        case 26:\n          _context.next = 28;\n          return takeLatest(TAKE_SCREENSHOT, handleScreenshot);\n\n        case 28:\n          _context.next = 30;\n          return takeLatest(SET_EDITOR_READY, handleSetEditorReady);\n\n        case 30:\n          _context.next = 32;\n          return takeLatest(SET_SELECTED_ENTITIES, handleSetSelectEntities);\n\n        case 32:\n          _context.next = 34;\n          return takeLatest(TOGGLE_SNAP_TO_GRID, handleToggleSnapToGrid);\n\n        case 34:\n          _context.next = 36;\n          return takeLatest(PREFETCH_ASSET, handlePrefetchAsset);\n\n        case 36:\n          _context.next = 38;\n          return takeLatest(CREATE_EDITOR_SCENE, handleCreateEditorScene);\n\n        case 38:\n          _context.next = 40;\n          return takeLatest(SET_BODY_SHAPE, handleSetBodyShape);\n\n        case 40:\n          _context.next = 42;\n          return takeLatest(FETCH_BASE_WEARABLES_REQUEST, handleFetchBaseWearables);\n\n        case 42:\n        case \"end\":\n          return _context.stop();\n      }\n    }\n  }, _marked);\n}\n\nfunction pollEditor(scene) {\n  var metrics, entities;\n  return _regeneratorRuntime.wrap(function pollEditor$(_context2) {\n    while (1) {\n      switch (_context2.prev = _context2.next) {\n        case 0:\n          entities = Object.values(scene.entities).length;\n          _context2.next = 3;\n          return select(getCurrentMetrics);\n\n        case 3:\n          metrics = _context2.sent;\n          _context2.next = 6;\n          return delay(300);\n\n        case 6:\n          if (entities > 0 && metrics.entities === 0) {\n            _context2.next = 0;\n            break;\n          }\n\n        case 7:\n          if (!(editorWindow.editor.getLoadingEntities() !== null)) {\n            _context2.next = 12;\n            break;\n          }\n\n          _context2.next = 10;\n          return delay(500);\n\n        case 10:\n          _context2.next = 7;\n          break;\n\n        case 12:\n        case \"end\":\n          return _context2.stop();\n      }\n    }\n  }, _marked2);\n}\n\nfunction handleEditorReady(scene) {\n  return _regeneratorRuntime.wrap(function handleEditorReady$(_context3) {\n    while (1) {\n      switch (_context3.prev = _context3.next) {\n        case 0:\n          _context3.next = 2;\n          return pollEditor(scene);\n\n        case 2:\n          _context3.next = 4;\n          return put(setEditorLoading(false));\n\n        case 4:\n        case \"end\":\n          return _context3.stop();\n      }\n    }\n  }, _marked3);\n}\n\nfunction handleBindEditorKeyboardShortcuts() {\n  var shortcuts;\n  return _regeneratorRuntime.wrap(function handleBindEditorKeyboardShortcuts$(_context4) {\n    while (1) {\n      switch (_context4.prev = _context4.next) {\n        case 0:\n          shortcuts = getEditorShortcuts(store);\n          _context4.next = 3;\n          return put(bindKeyboardShortcuts(shortcuts));\n\n        case 3:\n        case \"end\":\n          return _context4.stop();\n      }\n    }\n  }, _marked4);\n}\n\nfunction handleUnbindEditorKeyboardShortcuts() {\n  var shortcuts;\n  return _regeneratorRuntime.wrap(function handleUnbindEditorKeyboardShortcuts$(_context5) {\n    while (1) {\n      switch (_context5.prev = _context5.next) {\n        case 0:\n          shortcuts = getEditorShortcuts(store);\n          _context5.next = 3;\n          return put(unbindKeyboardShortcuts(shortcuts));\n\n        case 3:\n        case \"end\":\n          return _context5.stop();\n      }\n    }\n  }, _marked5);\n}\n\nfunction handleCreateEditorScene(action) {\n  return _regeneratorRuntime.wrap(function handleCreateEditorScene$(_context6) {\n    while (1) {\n      switch (_context6.prev = _context6.next) {\n        case 0:\n          _context6.next = 2;\n          return createNewEditorScene(action.payload.project);\n\n        case 2:\n        case \"end\":\n          return _context6.stop();\n      }\n    }\n  }, _marked6);\n}\n\nfunction createNewEditorScene(project) {\n  var newScene, msg;\n  return _regeneratorRuntime.wrap(function createNewEditorScene$(_context7) {\n    while (1) {\n      switch (_context7.prev = _context7.next) {\n        case 0:\n          newScene = getNewEditorScene(project);\n          msg = {\n            type: 'update',\n            payload: {\n              scene: newScene\n            }\n          }; // @ts-ignore: Client api\n\n          _context7.next = 4;\n          return call([editorWindow.editor, 'handleMessage'], msg);\n\n        case 4:\n          _context7.next = 6;\n          return handleResetCamera();\n\n        case 6:\n        case \"end\":\n          return _context7.stop();\n      }\n    }\n  }, _marked7);\n}\n\nfunction handleProvisionScene(action) {\n  var _action$payload, scene, init;\n\n  return _regeneratorRuntime.wrap(function handleProvisionScene$(_context8) {\n    while (1) {\n      switch (_context8.prev = _context8.next) {\n        case 0:\n          _action$payload = action.payload, scene = _action$payload.scene, init = _action$payload.init;\n          _context8.next = 3;\n          return renderScene(scene);\n\n        case 3:\n          if (init) {\n            _context8.next = 6;\n            break;\n          }\n\n          _context8.next = 6;\n          return put(takeScreenshot());\n\n        case 6:\n        case \"end\":\n          return _context8.stop();\n      }\n    }\n  }, _marked8);\n}\n\nfunction handleHistory() {\n  var scene;\n  return _regeneratorRuntime.wrap(function handleHistory$(_context9) {\n    while (1) {\n      switch (_context9.prev = _context9.next) {\n        case 0:\n          _context9.next = 2;\n          return select(getCurrentScene);\n\n        case 2:\n          scene = _context9.sent;\n          _context9.next = 5;\n          return renderScene(scene);\n\n        case 5:\n          _context9.next = 7;\n          return put(takeScreenshot());\n\n        case 7:\n        case \"end\":\n          return _context9.stop();\n      }\n    }\n  }, _marked9);\n}\n\nfunction renderScene(scene) {\n  var mappings, isReadOnlyResult;\n  return _regeneratorRuntime.wrap(function renderScene$(_context10) {\n    while (1) {\n      switch (_context10.prev = _context10.next) {\n        case 0:\n          if (!scene) {\n            _context10.next = 10;\n            break;\n          }\n\n          _context10.next = 3;\n          return select(getSceneMappings);\n\n        case 3:\n          mappings = _context10.sent;\n          _context10.next = 6;\n          return select(isReadOnly);\n\n        case 6:\n          isReadOnlyResult = _context10.sent;\n\n          if (isReadOnlyResult) {\n            scene = createReadyOnlyScene(scene);\n          }\n\n          _context10.next = 10;\n          return call(function () {\n            return editorWindow.editor.sendExternalAction(updateEditor(scene.id, _objectSpread({}, scene), mappings));\n          });\n\n        case 10:\n        case \"end\":\n          return _context10.stop();\n      }\n    }\n  }, _marked10);\n}\n\nfunction handleMetricsChange(args) {\n  var metrics = args.metrics,\n      limits = args.limits;\n  var scene = getCurrentScene(store.getState());\n\n  if (scene) {\n    store.dispatch(updateMetrics(scene.id, metrics, limits));\n  }\n}\n\nfunction handleTransformChange(args) {\n  var bounds = getCurrentBounds(store.getState());\n  var project = getCurrentProject(store.getState());\n  if (!project) return;\n  var scene = getCurrentScene(store.getState());\n  if (!scene) return;\n  var entityComponents = getEntityComponentsByType(store.getState());\n  var transformData = [];\n\n  var _iterator = _createForOfIteratorHelper(args.transforms),\n      _step;\n\n  try {\n    for (_iterator.s(); !(_step = _iterator.n()).done;) {\n      var transformPayload = _step.value;\n      var position = {\n        x: 0,\n        y: 0,\n        z: 0\n      };\n      var transform = entityComponents[transformPayload.entityId][ComponentType.Transform];\n      if (!transform) continue;\n\n      if (bounds) {\n        position = snapToBounds(transformPayload.position, bounds);\n      }\n\n      var scale = snapScale(transformPayload.scale);\n\n      if (transform) {\n        var newTransformData = {\n          position: position,\n          rotation: transformPayload.rotation,\n          scale: scale\n        };\n        if (areEqualTransforms(transform.data, newTransformData)) continue;\n        transformData.push({\n          componentId: transform.id,\n          data: newTransformData\n        });\n      } else {\n        console.warn(\"Unable to find Transform component for \".concat(transformPayload.entityId));\n      }\n    }\n  } catch (err) {\n    _iterator.e(err);\n  } finally {\n    _iterator.f();\n  }\n\n  if (transformData.length > 0) {\n    store.dispatch(updateTransform(scene.id, transformData));\n  }\n}\n\nfunction handleGizmoSelected(args) {\n  var gizmoType = args.gizmoType,\n      entities = args.entities;\n  var state = store.getState();\n  var currentGizmo = getGizmo(state);\n  var multiselectionEnabled = isMultiselectEnabled(state);\n\n  if (currentGizmo !== gizmoType) {\n    store.dispatch(setGizmo(gizmoType));\n  }\n\n  var selectedEntityId = getSelectedEntityIds(state);\n  var newSelectedEntities = selectedEntityId;\n\n  if (entities.length === 0) {\n    if (!multiselectionEnabled && selectedEntityId.length > 0) {\n      newSelectedEntities = [];\n    }\n  } else {\n    if (!multiselectionEnabled) {\n      newSelectedEntities = entities;\n    } else {\n      var _iterator2 = _createForOfIteratorHelper(entities),\n          _step2;\n\n      try {\n        var _loop = function _loop() {\n          var entityId = _step2.value;\n\n          if (!newSelectedEntities.includes(entityId)) {\n            newSelectedEntities.push(entityId);\n          } else {\n            newSelectedEntities = newSelectedEntities.filter(function (id) {\n              return id !== entityId;\n            });\n          }\n        };\n\n        for (_iterator2.s(); !(_step2 = _iterator2.n()).done;) {\n          _loop();\n        }\n      } catch (err) {\n        _iterator2.e(err);\n      } finally {\n        _iterator2.f();\n      }\n    }\n  }\n\n  store.dispatch(setSelectedEntities(newSelectedEntities));\n}\n\nfunction handleEditorReadyChange() {\n  store.dispatch(setEditorReady(true));\n}\n\nfunction handleOpenEditor(action) {\n  var _action$payload2, isReadOnly, type, project, areLoaded, scene, fixSuccessAction, loading, syncSuccessAction;\n\n  return _regeneratorRuntime.wrap(function handleOpenEditor$(_context11) {\n    while (1) {\n      switch (_context11.prev = _context11.next) {\n        case 0:\n          _action$payload2 = action.payload, isReadOnly = _action$payload2.isReadOnly, type = _action$payload2.type; // Handles subscriptions to metrics\n\n          _context11.next = 3;\n          return call([editorWindow.editor, 'on'], 'metrics', handleMetricsChange);\n\n        case 3:\n          _context11.next = 5;\n          return call([editorWindow.editor, 'on'], 'transform', handleTransformChange);\n\n        case 5:\n          _context11.next = 7;\n          return call([editorWindow.editor, 'on'], 'ready', handleEditorReadyChange);\n\n        case 7:\n          _context11.next = 9;\n          return call([editorWindow.editor, 'on'], 'gizmoSelected', handleGizmoSelected);\n\n        case 9:\n          _context11.next = 11;\n          return call([editorWindow.editor, 'on'], 'entitiesOutOfBoundaries', handleEntitiesOutOfBoundaries);\n\n        case 11:\n          _context11.next = 13;\n          return type === PreviewType.POOL ? select(getCurrentPool) : select(getCurrentProject);\n\n        case 13:\n          project = _context11.sent;\n\n          if (!project) {\n            _context11.next = 56;\n            break;\n          }\n\n          _context11.next = 17;\n          return select(hasLoadedAssetPacks);\n\n        case 17:\n          areLoaded = _context11.sent;\n\n          if (areLoaded) {\n            _context11.next = 21;\n            break;\n          }\n\n          _context11.next = 21;\n          return put(loadAssetPacksRequest());\n\n        case 21:\n          _context11.next = 23;\n          return getSceneByProjectId(project.id, type);\n\n        case 23:\n          scene = _context11.sent;\n          _context11.next = 26;\n          return put(fixLegacyNamespacesRequest(scene));\n\n        case 26:\n          _context11.next = 28;\n          return take(FIX_LEGACY_NAMESPACES_SUCCESS);\n\n        case 28:\n          fixSuccessAction = _context11.sent;\n          scene = fixSuccessAction.payload.scene; // if assets packs are being loaded wait for them to finish\n\n          _context11.next = 32;\n          return select(getLoading);\n\n        case 32:\n          loading = _context11.sent;\n\n          if (!isLoadingType(loading, LOAD_ASSET_PACKS_REQUEST)) {\n            _context11.next = 36;\n            break;\n          }\n\n          _context11.next = 36;\n          return take(LOAD_ASSET_PACKS_SUCCESS);\n\n        case 36:\n          _context11.next = 38;\n          return put(syncSceneAssetsRequest(scene));\n\n        case 38:\n          _context11.next = 40;\n          return take(SYNC_SCENE_ASSETS_SUCCESS);\n\n        case 40:\n          syncSuccessAction = _context11.sent;\n          scene = syncSuccessAction.payload.scene;\n          _context11.next = 44;\n          return put(setEditorReadOnly(isReadOnly));\n\n        case 44:\n          _context11.next = 46;\n          return createNewEditorScene(project);\n\n        case 46:\n          _context11.next = 48;\n          return call(function () {\n            return editorWindow.editor.sendExternalAction(setScriptUrl(getContentsStorageUrl()));\n          });\n\n        case 48:\n          _context11.next = 50;\n          return renderScene(scene);\n\n        case 50:\n          _context11.next = 52;\n          return handleToggleSnapToGrid(toggleSnapToGrid(true));\n\n        case 52:\n          _context11.next = 54;\n          return call(function () {\n            return editorWindow.editor.selectGizmo(Gizmo.NONE);\n          });\n\n        case 54:\n          _context11.next = 57;\n          break;\n\n        case 56:\n          console.error(\"Unable to Open Editor: Invalid \".concat(type));\n\n        case 57:\n        case \"end\":\n          return _context11.stop();\n      }\n    }\n  }, _marked11);\n}\n\nfunction handleCloseEditor() {\n  var isReadyResult;\n  return _regeneratorRuntime.wrap(function handleCloseEditor$(_context12) {\n    while (1) {\n      switch (_context12.prev = _context12.next) {\n        case 0:\n          _context12.next = 2;\n          return call(function () {\n            return editorWindow.editor.off('metrics', handleMetricsChange);\n          });\n\n        case 2:\n          _context12.next = 4;\n          return call(function () {\n            return editorWindow.editor.off('transform', handleTransformChange);\n          });\n\n        case 4:\n          _context12.next = 6;\n          return call(function () {\n            return editorWindow.editor.off('ready', handleEditorReadyChange);\n          });\n\n        case 6:\n          _context12.next = 8;\n          return call(function () {\n            return editorWindow.editor.off('gizmoSelected', handleGizmoSelected);\n          });\n\n        case 8:\n          _context12.next = 10;\n          return call(function () {\n            return editorWindow.editor.off('entitiesOutOfBoundaries', handleEntitiesOutOfBoundaries);\n          });\n\n        case 10:\n          _context12.next = 12;\n          return select(isReady);\n\n        case 12:\n          isReadyResult = _context12.sent;\n\n          if (!isReadyResult) {\n            _context12.next = 16;\n            break;\n          }\n\n          _context12.next = 16;\n          return call(function () {\n            return editorWindow.editor.sendExternalAction(closeEditor());\n          });\n\n        case 16:\n          _context12.next = 18;\n          return put(unbindEditorKeyboardShortcuts());\n\n        case 18:\n        case \"end\":\n          return _context12.stop();\n      }\n    }\n  }, _marked12);\n}\n\nfunction handleSetGizmo(action) {\n  var isReadyResult;\n  return _regeneratorRuntime.wrap(function handleSetGizmo$(_context13) {\n    while (1) {\n      switch (_context13.prev = _context13.next) {\n        case 0:\n          _context13.next = 2;\n          return select(isReady);\n\n        case 2:\n          isReadyResult = _context13.sent;\n\n          if (!isReadyResult) {\n            _context13.next = 6;\n            break;\n          }\n\n          _context13.next = 6;\n          return call(function () {\n            return editorWindow.editor.selectGizmo(action.payload.gizmo);\n          });\n\n        case 6:\n        case \"end\":\n          return _context13.stop();\n      }\n    }\n  }, _marked13);\n}\n\nfunction handleTogglePreview(action) {\n  var editor, isEnabled, gizmo, project, x, z, components, hasScript, scene;\n  return _regeneratorRuntime.wrap(function handleTogglePreview$(_context14) {\n    while (1) {\n      switch (_context14.prev = _context14.next) {\n        case 0:\n          editor = editorWindow.editor;\n          isEnabled = action.payload.isEnabled;\n          _context14.next = 4;\n          return select(getGizmo);\n\n        case 4:\n          gizmo = _context14.sent;\n          _context14.next = 7;\n          return select(getCurrentProject);\n\n        case 7:\n          project = _context14.sent;\n\n          if (project) {\n            _context14.next = 10;\n            break;\n          }\n\n          return _context14.abrupt(\"return\");\n\n        case 10:\n          x = project.layout.rows * PARCEL_SIZE / 2;\n          z = -1;\n          _context14.next = 14;\n          return call(function () {\n            editor.setPlayMode(isEnabled);\n            editor.sendExternalAction(action);\n            editor.selectGizmo(isEnabled ? Gizmo.NONE : gizmo);\n          });\n\n        case 14:\n          if (isEnabled) {\n            _context14.next = 33;\n            break;\n          }\n\n          _context14.next = 17;\n          return select(getComponents);\n\n        case 17:\n          components = _context14.sent;\n          hasScript = Object.values(components).some(function (component) {\n            return component.type === ComponentType.Script;\n          });\n\n          if (!hasScript) {\n            _context14.next = 24;\n            break;\n          }\n\n          _context14.next = 22;\n          return createNewEditorScene(project);\n\n        case 22:\n          _context14.next = 24;\n          return call(function () {\n            return editorWindow.editor.sendExternalAction(setScriptUrl(getContentsStorageUrl()));\n          });\n\n        case 24:\n          _context14.next = 26;\n          return handleResetCamera();\n\n        case 26:\n          _context14.next = 28;\n          return select(getCurrentScene);\n\n        case 28:\n          scene = _context14.sent;\n          _context14.next = 31;\n          return renderScene(scene);\n\n        case 31:\n          _context14.next = 35;\n          break;\n\n        case 33:\n          editor.setCameraPosition({\n            x: x,\n            y: 1.5,\n            z: z\n          });\n          editor.setCameraRotation(0, 0);\n\n        case 35:\n          _context14.next = 37;\n          return changeEditorState(!isEnabled);\n\n        case 37:\n        case \"end\":\n          return _context14.stop();\n      }\n    }\n  }, _marked14);\n}\n\nfunction handleZoomIn() {\n  editorWindow.editor.setCameraZoomDelta(-5);\n}\n\nfunction handleZoomOut() {\n  editorWindow.editor.setCameraZoomDelta(5);\n}\n\nfunction handleSetEditorReady(action) {\n  var isReady, project, scene;\n  return _regeneratorRuntime.wrap(function handleSetEditorReady$(_context15) {\n    while (1) {\n      switch (_context15.prev = _context15.next) {\n        case 0:\n          isReady = action.payload.isReady;\n          _context15.next = 3;\n          return select(getCurrentProject);\n\n        case 3:\n          project = _context15.sent;\n\n          if (!project) {\n            _context15.next = 19;\n            break;\n          }\n\n          if (!isReady) {\n            _context15.next = 17;\n            break;\n          }\n\n          _context15.prev = 6;\n          _context15.next = 9;\n          return getSceneByProjectId(project.id);\n\n        case 9:\n          scene = _context15.sent;\n          _context15.next = 12;\n          return handleEditorReady(scene);\n\n        case 12:\n          _context15.next = 17;\n          break;\n\n        case 14:\n          _context15.prev = 14;\n          _context15.t0 = _context15[\"catch\"](6);\n          console.error(_context15.t0);\n\n        case 17:\n          _context15.next = 19;\n          return changeEditorState(isReady);\n\n        case 19:\n        case \"end\":\n          return _context15.stop();\n      }\n    }\n  }, _marked15, null, [[6, 14]]);\n}\n\nfunction changeEditorState(isReady) {\n  return _regeneratorRuntime.wrap(function changeEditorState$(_context16) {\n    while (1) {\n      switch (_context16.prev = _context16.next) {\n        case 0:\n          if (!isReady) {\n            _context16.next = 5;\n            break;\n          }\n\n          _context16.next = 3;\n          return put(bindEditorKeyboardShortcuts());\n\n        case 3:\n          _context16.next = 7;\n          break;\n\n        case 5:\n          _context16.next = 7;\n          return put(unbindEditorKeyboardShortcuts());\n\n        case 7:\n        case \"end\":\n          return _context16.stop();\n      }\n    }\n  }, _marked16);\n}\n\nfunction handleResetCamera() {\n  var project, x, z;\n  return _regeneratorRuntime.wrap(function handleResetCamera$(_context17) {\n    while (1) {\n      switch (_context17.prev = _context17.next) {\n        case 0:\n          _context17.next = 2;\n          return select(getCurrentProject);\n\n        case 2:\n          project = _context17.sent;\n\n          if (project) {\n            _context17.next = 5;\n            break;\n          }\n\n          return _context17.abrupt(\"return\");\n\n        case 5:\n          x = project.layout.rows * PARCEL_SIZE / 2;\n          z = project.layout.cols * PARCEL_SIZE / 2;\n          editorWindow.editor.resetCameraZoom();\n          editorWindow.editor.setCameraPosition({\n            x: x,\n            y: 0,\n            z: z\n          });\n          editorWindow.editor.setCameraRotation(7 * Math.PI / 4, Math.PI / 6);\n\n        case 10:\n        case \"end\":\n          return _context17.stop();\n      }\n    }\n  }, _marked17);\n}\n\nfunction handleDropItem(action) {\n  var _action$payload3, asset, x, y, project, position;\n\n  return _regeneratorRuntime.wrap(function handleDropItem$(_context18) {\n    while (1) {\n      switch (_context18.prev = _context18.next) {\n        case 0:\n          _action$payload3 = action.payload, asset = _action$payload3.asset, x = _action$payload3.x, y = _action$payload3.y;\n\n          if (!(asset.category === GROUND_CATEGORY)) {\n            _context18.next = 11;\n            break;\n          }\n\n          _context18.next = 4;\n          return select(getCurrentProject);\n\n        case 4:\n          project = _context18.sent;\n\n          if (project) {\n            _context18.next = 7;\n            break;\n          }\n\n          return _context18.abrupt(\"return\");\n\n        case 7:\n          _context18.next = 9;\n          return put(setGround(project.id, asset));\n\n        case 9:\n          _context18.next = 16;\n          break;\n\n        case 11:\n          _context18.next = 13;\n          return call(function () {\n            return editorWindow.editor.getMouseWorldPosition(x, y);\n          });\n\n        case 13:\n          position = _context18.sent;\n          _context18.next = 16;\n          return put(addItem(asset, position));\n\n        case 16:\n        case \"end\":\n          return _context18.stop();\n      }\n    }\n  }, _marked18);\n}\n\nfunction handleScreenshot(_) {\n  var currentProject, ready, readyAction, loading, loadingAction, screenshot, thumbnail;\n  return _regeneratorRuntime.wrap(function handleScreenshot$(_context19) {\n    while (1) {\n      switch (_context19.prev = _context19.next) {\n        case 0:\n          _context19.next = 2;\n          return put(setScreenshotReady(false));\n\n        case 2:\n          _context19.prev = 2;\n          _context19.next = 5;\n          return select(getCurrentProject);\n\n        case 5:\n          currentProject = _context19.sent;\n\n          if (currentProject) {\n            _context19.next = 8;\n            break;\n          }\n\n          return _context19.abrupt(\"return\");\n\n        case 8:\n          _context19.next = 10;\n          return select(isReady);\n\n        case 10:\n          ready = _context19.sent;\n\n        case 11:\n          if (ready) {\n            _context19.next = 18;\n            break;\n          }\n\n          _context19.next = 14;\n          return take(SET_EDITOR_READY);\n\n        case 14:\n          readyAction = _context19.sent;\n          ready = readyAction.payload.isReady;\n          _context19.next = 11;\n          break;\n\n        case 18:\n          _context19.next = 20;\n          return select(isLoading);\n\n        case 20:\n          loading = _context19.sent;\n\n        case 21:\n          if (!loading) {\n            _context19.next = 28;\n            break;\n          }\n\n          _context19.next = 24;\n          return take(SET_EDITOR_LOADING);\n\n        case 24:\n          loadingAction = _context19.sent;\n          loading = loadingAction.payload.isLoading;\n          _context19.next = 21;\n          break;\n\n        case 28:\n          _context19.next = 30;\n          return delay(2000);\n\n        case 30:\n          _context19.next = 32;\n          return call(function () {\n            return editorWindow.editor.takeScreenshot();\n          });\n\n        case 32:\n          screenshot = _context19.sent;\n\n          if (screenshot) {\n            _context19.next = 35;\n            break;\n          }\n\n          return _context19.abrupt(\"return\");\n\n        case 35:\n          _context19.next = 37;\n          return call(function () {\n            return resizeScreenshot(screenshot, THUMBNAIL_WIDTH, THUMBNAIL_HEIGHT);\n          });\n\n        case 37:\n          thumbnail = _context19.sent;\n\n          if (thumbnail) {\n            _context19.next = 40;\n            break;\n          }\n\n          return _context19.abrupt(\"return\");\n\n        case 40:\n          _context19.next = 42;\n          return put(editProjectThumbnail(currentProject.id, thumbnail));\n\n        case 42:\n          _context19.next = 46;\n          break;\n\n        case 44:\n          _context19.prev = 44;\n          _context19.t0 = _context19[\"catch\"](2);\n\n        case 46:\n          _context19.next = 48;\n          return put(setScreenshotReady(true));\n\n        case 48:\n        case \"end\":\n          return _context19.stop();\n      }\n    }\n  }, _marked19, null, [[2, 44]]);\n}\n\nfunction handleSetSelectEntities(action) {\n  return _regeneratorRuntime.wrap(function handleSetSelectEntities$(_context20) {\n    while (1) {\n      switch (_context20.prev = _context20.next) {\n        case 0:\n          _context20.next = 2;\n          return call(function () {\n            try {\n              // this could throw if the entity does not exist, due to some race condition or the scene is not synced\n              editorWindow.editor.setSelectedEntities(action.payload.entityIds);\n            } catch (e) {// noop\n            }\n          });\n\n        case 2:\n        case \"end\":\n          return _context20.stop();\n      }\n    }\n  }, _marked20);\n}\n\nfunction handleToggleSnapToGrid(action) {\n  return _regeneratorRuntime.wrap(function handleToggleSnapToGrid$(_context21) {\n    while (1) {\n      switch (_context21.prev = _context21.next) {\n        case 0:\n          _context21.next = 2;\n          return call(function () {\n            if (action.payload.enabled) {\n              editorWindow.editor.setGridResolution(POSITION_GRID_RESOLUTION, ROTATION_GRID_RESOLUTION, SCALE_GRID_RESOLUTION);\n            } else {\n              editorWindow.editor.setGridResolution(0, 0, 0);\n            }\n          });\n\n        case 2:\n        case \"end\":\n          return _context21.stop();\n      }\n    }\n  }, _marked21);\n}\n\nfunction handlePrefetchAsset(action) {\n  return _regeneratorRuntime.wrap(function handlePrefetchAsset$(_context22) {\n    while (1) {\n      switch (_context22.prev = _context22.next) {\n        case 0:\n          _context22.next = 2;\n          return call(function () {\n            var contentEntries = Object.entries(action.payload.asset.contents);\n\n            for (var _i = 0, _contentEntries = contentEntries; _i < _contentEntries.length; _i++) {\n              var _ref3 = _contentEntries[_i];\n\n              var _ref2 = _slicedToArray(_ref3, 2);\n\n              var file = _ref2[0];\n              var hash = _ref2[1];\n\n              if ((file.endsWith('.png') || file.endsWith('.glb') || file.endsWith('.gltf')) && !file.endsWith(THUMBNAIL_PATH)) {\n                editorWindow.editor.preloadFile(\"\".concat(hash, \"\\t\").concat(action.payload.asset.id, \"/\").concat(file));\n              }\n            }\n          });\n\n        case 2:\n        case \"end\":\n          return _context22.stop();\n      }\n    }\n  }, _marked22);\n}\n\nfunction handleEntitiesOutOfBoundaries(args) {\n  var entities = args.entities;\n  var state = store.getState();\n  var entitiesInState = getEntitiesOutOfBoundaries(state);\n\n  if (entities.length === 0 && entitiesInState.length === 0) {\n    return;\n  }\n\n  var previewMode = isPreviewing(state);\n\n  if (!previewMode) {\n    store.dispatch(setEntitiesOutOfBoundaries(entities));\n  }\n}\n\nfunction handleSetBodyShape(_action) {\n  var visibleItems;\n  return _regeneratorRuntime.wrap(function handleSetBodyShape$(_context23) {\n    while (1) {\n      switch (_context23.prev = _context23.next) {\n        case 0:\n          _context23.next = 2;\n          return select(getVisibleItems);\n\n        case 2:\n          visibleItems = _context23.sent;\n          _context23.next = 5;\n          return put(setItems(visibleItems));\n\n        case 5:\n        case \"end\":\n          return _context23.stop();\n      }\n    }\n  }, _marked23);\n}\n\nfunction handleFetchBaseWearables() {\n  var response, json, wearables;\n  return _regeneratorRuntime.wrap(function handleFetchBaseWearables$(_context24) {\n    while (1) {\n      switch (_context24.prev = _context24.next) {\n        case 0:\n          _context24.prev = 0;\n          _context24.next = 3;\n          return call(fetch, \"\".concat(PEER_URL, \"/lambdas/collections/wearables?collectionId=urn:decentraland:off-chain:base-avatars\"));\n\n        case 3:\n          response = _context24.sent;\n\n          if (response.ok) {\n            _context24.next = 6;\n            break;\n          }\n\n          throw new Error('Failed to fetch base wearables');\n\n        case 6:\n          _context24.next = 8;\n          return response.json();\n\n        case 8:\n          json = _context24.sent;\n          // Filter wearables that hide or replace others, preventing issues with the previewed\n          wearables = json.wearables.filter(function (wearable) {\n            var hidesWearables = wearable.data.hides && wearable.data.hides.length > 0;\n            var replacesWearables = wearable.data.replaces && wearable.data.replaces.length > 0;\n            return !hidesWearables && !replacesWearables;\n          }).map(fromCatalystWearableToWearable);\n          _context24.next = 12;\n          return put(fetchBaseWearablesSuccess(wearables));\n\n        case 12:\n          _context24.next = 18;\n          break;\n\n        case 14:\n          _context24.prev = 14;\n          _context24.t0 = _context24[\"catch\"](0);\n          _context24.next = 18;\n          return put(fetchBaseWearablesFailure(_context24.t0.message));\n\n        case 18:\n        case \"end\":\n          return _context24.stop();\n      }\n    }\n  }, _marked24, null, [[0, 14]]);\n}","map":{"version":3,"sources":["/opt/work/NZ_test/src/modules/editor/sagas.ts"],"names":["editorSaga","pollEditor","handleEditorReady","handleBindEditorKeyboardShortcuts","handleUnbindEditorKeyboardShortcuts","handleCreateEditorScene","createNewEditorScene","handleProvisionScene","handleHistory","renderScene","handleOpenEditor","handleCloseEditor","handleSetGizmo","handleTogglePreview","handleSetEditorReady","changeEditorState","handleResetCamera","handleDropItem","handleScreenshot","handleSetSelectEntities","handleToggleSnapToGrid","handlePrefetchAsset","handleSetBodyShape","handleFetchBaseWearables","takeLatest","select","put","call","delay","take","isLoadingType","updateEditor","BIND_EDITOR_KEYBOARD_SHORTCUTS","UNBIND_EDITOR_KEYBOARD_SHORTCUTS","CLOSE_EDITOR","SET_GIZMO","TOGGLE_PREVIEW","ZOOM_IN","ZOOM_OUT","RESET_CAMERA","OPEN_EDITOR","setEditorReady","setGizmo","setSelectedEntities","EDITOR_REDO","EDITOR_UNDO","TAKE_SCREENSHOT","takeScreenshot","unbindEditorKeyboardShortcuts","bindEditorKeyboardShortcuts","SET_EDITOR_READY","SET_SELECTED_ENTITIES","TOGGLE_SNAP_TO_GRID","toggleSnapToGrid","PREFETCH_ASSET","setEntitiesOutOfBoundaries","closeEditor","setEditorLoading","CREATE_EDITOR_SCENE","SET_EDITOR_LOADING","setScriptUrl","setScreenshotReady","setEditorReadOnly","setItems","SET_BODY_SHAPE","FETCH_BASE_WEARABLES_REQUEST","fetchBaseWearablesSuccess","fetchBaseWearablesFailure","PROVISION_SCENE","updateMetrics","updateTransform","DROP_ITEM","addItem","setGround","fixLegacyNamespacesRequest","syncSceneAssetsRequest","FIX_LEGACY_NAMESPACES_SUCCESS","SYNC_SCENE_ASSETS_SUCCESS","bindKeyboardShortcuts","unbindKeyboardShortcuts","editProjectThumbnail","getCurrentScene","getEntityComponentsByType","getCurrentMetrics","getComponents","getCurrentProject","getCurrentBounds","ComponentType","Gizmo","PreviewType","getLoading","GROUND_CATEGORY","store","PARCEL_SIZE","snapToBounds","getSceneByProjectId","getEditorShortcuts","THUMBNAIL_PATH","getCurrentPool","loadAssetPacksRequest","LOAD_ASSET_PACKS_SUCCESS","LOAD_ASSET_PACKS_REQUEST","getContentsStorageUrl","PEER_URL","getGizmo","getSelectedEntityIds","getSceneMappings","isLoading","isReady","isPreviewing","isReadOnly","getEntitiesOutOfBoundaries","hasLoadedAssetPacks","isMultiselectEnabled","getVisibleItems","getNewEditorScene","resizeScreenshot","snapScale","createReadyOnlyScene","areEqualTransforms","THUMBNAIL_WIDTH","THUMBNAIL_HEIGHT","POSITION_GRID_RESOLUTION","SCALE_GRID_RESOLUTION","ROTATION_GRID_RESOLUTION","fromCatalystWearableToWearable","editorWindow","window","handleZoomIn","handleZoomOut","scene","entities","Object","values","length","metrics","editor","getLoadingEntities","shortcuts","action","payload","project","newScene","msg","type","init","mappings","isReadOnlyResult","sendExternalAction","id","handleMetricsChange","args","limits","getState","dispatch","handleTransformChange","bounds","entityComponents","transformData","transforms","transformPayload","position","x","y","z","transform","entityId","Transform","scale","newTransformData","rotation","data","push","componentId","console","warn","handleGizmoSelected","gizmoType","state","currentGizmo","multiselectionEnabled","selectedEntityId","newSelectedEntities","includes","filter","handleEditorReadyChange","handleEntitiesOutOfBoundaries","POOL","areLoaded","fixSuccessAction","loading","syncSuccessAction","selectGizmo","NONE","error","off","isReadyResult","gizmo","isEnabled","layout","rows","setPlayMode","components","hasScript","some","component","Script","setCameraPosition","setCameraRotation","setCameraZoomDelta","cols","resetCameraZoom","Math","PI","asset","category","getMouseWorldPosition","_","currentProject","ready","readyAction","loadingAction","screenshot","thumbnail","entityIds","e","enabled","setGridResolution","contentEntries","entries","contents","file","hash","endsWith","preloadFile","entitiesInState","previewMode","_action","visibleItems","fetch","response","ok","Error","json","wearables","wearable","hidesWearables","hides","replacesWearables","replaces","map","message"],"mappings":"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","sourcesContent":["import { Wearable } from 'decentraland-ecs'\nimport { takeLatest, select, put, call, delay, take } from 'redux-saga/effects'\nimport { isLoadingType } from 'decentraland-dapps/dist/modules/loading/selectors'\nimport {\n  updateEditor,\n  BIND_EDITOR_KEYBOARD_SHORTCUTS,\n  UNBIND_EDITOR_KEYBOARD_SHORTCUTS,\n  CLOSE_EDITOR,\n  SET_GIZMO,\n  SetGizmoAction,\n  TogglePreviewAction,\n  TOGGLE_PREVIEW,\n  ZOOM_IN,\n  ZOOM_OUT,\n  RESET_CAMERA,\n  OPEN_EDITOR,\n  setEditorReady,\n  setGizmo,\n  setSelectedEntities,\n  EDITOR_REDO,\n  EDITOR_UNDO,\n  TAKE_SCREENSHOT,\n  TakeScreenshotAction,\n  takeScreenshot,\n  unbindEditorKeyboardShortcuts,\n  bindEditorKeyboardShortcuts,\n  SET_EDITOR_READY,\n  SET_SELECTED_ENTITIES,\n  TOGGLE_SNAP_TO_GRID,\n  ToggleSnapToGridAction,\n  toggleSnapToGrid,\n  PREFETCH_ASSET,\n  PrefetchAssetAction,\n  SetEditorReadyAction,\n  setEntitiesOutOfBoundaries,\n  closeEditor,\n  setEditorLoading,\n  CREATE_EDITOR_SCENE,\n  CreateEditorSceneAction,\n  SET_EDITOR_LOADING,\n  SetEditorLoadingAction,\n  setScriptUrl,\n  setScreenshotReady,\n  OpenEditorAction,\n  setEditorReadOnly,\n  SetSelectedEntitiesAction,\n  setItems,\n  SET_BODY_SHAPE,\n  SetBodyShapeAction,\n  FETCH_BASE_WEARABLES_REQUEST,\n  fetchBaseWearablesSuccess,\n  fetchBaseWearablesFailure\n} from 'modules/editor/actions'\nimport {\n  PROVISION_SCENE,\n  updateMetrics,\n  updateTransform,\n  DROP_ITEM,\n  DropItemAction,\n  addItem,\n  setGround,\n  ProvisionSceneAction,\n  fixLegacyNamespacesRequest,\n  syncSceneAssetsRequest,\n  FIX_LEGACY_NAMESPACES_SUCCESS,\n  FixLegacyNamespacesSuccessAction,\n  SYNC_SCENE_ASSETS_SUCCESS,\n  syncSceneAssetsSuccess\n} from 'modules/scene/actions'\nimport { bindKeyboardShortcuts, unbindKeyboardShortcuts } from 'modules/keyboard/actions'\nimport { editProjectThumbnail } from 'modules/project/actions'\nimport { getCurrentScene, getEntityComponentsByType, getCurrentMetrics, getComponents } from 'modules/scene/selectors'\nimport { getCurrentProject, getCurrentBounds } from 'modules/project/selectors'\nimport { Scene, ComponentType, ComponentDefinition, ComponentData } from 'modules/scene/types'\nimport { ModelMetrics, Vector3, Quaternion } from 'modules/models/types'\nimport { Project } from 'modules/project/types'\nimport { CatalystWearable, EditorScene, Gizmo, PreviewType } from 'modules/editor/types'\nimport { getLoading } from 'modules/assetPack/selectors'\nimport { GROUND_CATEGORY } from 'modules/asset/types'\nimport { RootState } from 'modules/common/types'\nimport { EditorWindow } from 'components/Preview/Preview.types'\nimport { store } from 'modules/common/store'\nimport { PARCEL_SIZE } from 'modules/project/constants'\nimport { snapToBounds, getSceneByProjectId } from 'modules/scene/utils'\nimport { getEditorShortcuts } from 'modules/keyboard/utils'\nimport { THUMBNAIL_PATH } from 'modules/assetPack/utils'\nimport { getCurrentPool } from 'modules/pool/selectors'\nimport { Pool } from 'modules/pool/types'\nimport { loadAssetPacksRequest, LOAD_ASSET_PACKS_SUCCESS, LOAD_ASSET_PACKS_REQUEST } from 'modules/assetPack/actions'\nimport { Item } from 'modules/item/types'\nimport { AssetPackState } from 'modules/assetPack/reducer'\nimport { getContentsStorageUrl } from 'lib/api/builder'\nimport { PEER_URL } from 'lib/api/peer'\nimport {\n  getGizmo,\n  getSelectedEntityIds,\n  getSceneMappings,\n  isLoading,\n  isReady,\n  isPreviewing,\n  isReadOnly,\n  getEntitiesOutOfBoundaries,\n  hasLoadedAssetPacks,\n  isMultiselectEnabled,\n  getVisibleItems\n} from './selectors'\nimport {\n  getNewEditorScene,\n  resizeScreenshot,\n  snapScale,\n  createReadyOnlyScene,\n  areEqualTransforms,\n  THUMBNAIL_WIDTH,\n  THUMBNAIL_HEIGHT,\n  POSITION_GRID_RESOLUTION,\n  SCALE_GRID_RESOLUTION,\n  ROTATION_GRID_RESOLUTION,\n  fromCatalystWearableToWearable\n} from './utils'\nconst editorWindow = window as EditorWindow\n\nexport function* editorSaga() {\n  yield takeLatest(BIND_EDITOR_KEYBOARD_SHORTCUTS, handleBindEditorKeyboardShortcuts)\n  yield takeLatest(UNBIND_EDITOR_KEYBOARD_SHORTCUTS, handleUnbindEditorKeyboardShortcuts)\n  yield takeLatest(OPEN_EDITOR, handleOpenEditor)\n  yield takeLatest(CLOSE_EDITOR, handleCloseEditor)\n  yield takeLatest(PROVISION_SCENE, handleProvisionScene)\n  yield takeLatest(EDITOR_REDO, handleHistory)\n  yield takeLatest(EDITOR_UNDO, handleHistory)\n  yield takeLatest(SET_GIZMO, handleSetGizmo)\n  yield takeLatest(TOGGLE_PREVIEW, handleTogglePreview)\n  yield takeLatest(ZOOM_IN, handleZoomIn)\n  yield takeLatest(ZOOM_OUT, handleZoomOut)\n  yield takeLatest(RESET_CAMERA, handleResetCamera)\n  yield takeLatest(DROP_ITEM, handleDropItem)\n  yield takeLatest(TAKE_SCREENSHOT, handleScreenshot)\n  yield takeLatest(SET_EDITOR_READY, handleSetEditorReady)\n  yield takeLatest(SET_SELECTED_ENTITIES, handleSetSelectEntities)\n  yield takeLatest(TOGGLE_SNAP_TO_GRID, handleToggleSnapToGrid)\n  yield takeLatest(PREFETCH_ASSET, handlePrefetchAsset)\n  yield takeLatest(CREATE_EDITOR_SCENE, handleCreateEditorScene)\n  yield takeLatest(SET_BODY_SHAPE, handleSetBodyShape)\n  yield takeLatest(FETCH_BASE_WEARABLES_REQUEST, handleFetchBaseWearables)\n}\n\nfunction* pollEditor(scene: Scene) {\n  let metrics: ModelMetrics\n  let entities: number\n\n  do {\n    entities = Object.values(scene.entities).length\n    metrics = yield select(getCurrentMetrics)\n    yield delay(300)\n  } while (entities > 0 && metrics.entities === 0)\n\n  while (editorWindow.editor.getLoadingEntities() !== null) {\n    yield delay(500)\n  }\n}\n\nfunction* handleEditorReady(scene: Scene) {\n  yield pollEditor(scene)\n  yield put(setEditorLoading(false))\n}\n\nfunction* handleBindEditorKeyboardShortcuts() {\n  const shortcuts = getEditorShortcuts(store)\n  yield put(bindKeyboardShortcuts(shortcuts))\n}\n\nfunction* handleUnbindEditorKeyboardShortcuts() {\n  const shortcuts = getEditorShortcuts(store)\n  yield put(unbindKeyboardShortcuts(shortcuts))\n}\n\nfunction* handleCreateEditorScene(action: CreateEditorSceneAction) {\n  yield createNewEditorScene(action.payload.project)\n}\n\nfunction* createNewEditorScene(project: Project) {\n  const newScene: EditorScene = getNewEditorScene(project)\n\n  const msg = {\n    type: 'update',\n    payload: {\n      scene: newScene\n    }\n  }\n\n  // @ts-ignore: Client api\n  yield call([editorWindow.editor, 'handleMessage'], msg)\n  yield handleResetCamera()\n}\n\nfunction* handleProvisionScene(action: ProvisionSceneAction) {\n  const { scene, init } = action.payload\n  yield renderScene(scene)\n  if (!init) {\n    yield put(takeScreenshot())\n  }\n}\n\nfunction* handleHistory() {\n  const scene: Scene = yield select(getCurrentScene)\n  yield renderScene(scene)\n  yield put(takeScreenshot())\n}\n\nfunction* renderScene(scene: Scene) {\n  if (scene) {\n    const mappings: ReturnType<typeof getSceneMappings> = yield select(getSceneMappings)\n    const isReadOnlyResult: boolean = yield select(isReadOnly)\n    if (isReadOnlyResult) {\n      scene = createReadyOnlyScene(scene)\n    }\n    yield call(() => editorWindow.editor.sendExternalAction(updateEditor(scene.id, { ...scene }, mappings)))\n  }\n}\n\nfunction handleMetricsChange(args: { metrics: ModelMetrics; limits: ModelMetrics }) {\n  const { metrics, limits } = args\n  const scene = getCurrentScene(store.getState() as RootState)\n  if (scene) {\n    store.dispatch(updateMetrics(scene.id, metrics, limits))\n  }\n}\n\nfunction handleTransformChange(args: { transforms: { entityId: string; position: Vector3; rotation: Quaternion; scale: Vector3 }[] }) {\n  const bounds: ReturnType<typeof getCurrentBounds> = getCurrentBounds(store.getState() as RootState)\n  const project: ReturnType<typeof getCurrentProject> = getCurrentProject(store.getState() as RootState)\n\n  if (!project) return\n\n  const scene: ReturnType<typeof getCurrentScene> = getCurrentScene(store.getState() as RootState)\n  if (!scene) return\n\n  const entityComponents = getEntityComponentsByType(store.getState() as RootState)\n  const transformData: { componentId: string; data: ComponentData[ComponentType.Transform] }[] = []\n\n  for (let transformPayload of args.transforms) {\n    let position: Vector3 = { x: 0, y: 0, z: 0 }\n    const transform = entityComponents[transformPayload.entityId][ComponentType.Transform] as\n      | ComponentDefinition<ComponentType.Transform>\n      | undefined\n\n    if (!transform) continue\n\n    if (bounds) {\n      position = snapToBounds(transformPayload.position, bounds)\n    }\n\n    const scale = snapScale(transformPayload.scale)\n\n    if (transform) {\n      const newTransformData = { position, rotation: transformPayload.rotation, scale }\n      if (areEqualTransforms(transform.data, newTransformData)) continue\n      transformData.push({ componentId: transform.id, data: newTransformData })\n    } else {\n      console.warn(`Unable to find Transform component for ${transformPayload.entityId}`)\n    }\n  }\n  if (transformData.length > 0) {\n    store.dispatch(updateTransform(scene.id, transformData))\n  }\n}\n\nfunction handleGizmoSelected(args: { gizmoType: Gizmo; entities: string[] }) {\n  const { gizmoType, entities } = args\n  const state = store.getState() as RootState\n  const currentGizmo = getGizmo(state)\n  const multiselectionEnabled = isMultiselectEnabled(state)\n\n  if (currentGizmo !== gizmoType) {\n    store.dispatch(setGizmo(gizmoType))\n  }\n  const selectedEntityId = getSelectedEntityIds(state)\n  let newSelectedEntities = selectedEntityId\n\n  if (entities.length === 0) {\n    if (!multiselectionEnabled && selectedEntityId.length > 0) {\n      newSelectedEntities = []\n    }\n  } else {\n    if (!multiselectionEnabled) {\n      newSelectedEntities = entities\n    } else {\n      for (let entityId of entities) {\n        if (!newSelectedEntities.includes(entityId)) {\n          newSelectedEntities.push(entityId)\n        } else {\n          newSelectedEntities = newSelectedEntities.filter(id => id !== entityId)\n        }\n      }\n    }\n  }\n  store.dispatch(setSelectedEntities(newSelectedEntities))\n}\n\nfunction handleEditorReadyChange() {\n  store.dispatch(setEditorReady(true))\n}\n\nfunction* handleOpenEditor(action: OpenEditorAction) {\n  const { isReadOnly, type } = action.payload\n  // Handles subscriptions to metrics\n  yield call([editorWindow.editor, 'on'], 'metrics', handleMetricsChange)\n\n  // The client will report the deltas when the transform of an entity has changed (gizmo movement)\n  yield call([editorWindow.editor, 'on'], 'transform', handleTransformChange)\n\n  // The client will report when the internal api is ready\n  yield call([editorWindow.editor, 'on'], 'ready', handleEditorReadyChange)\n\n  // The client will report the deltas when the transform of an entity has changed (gizmo movement)\n  yield call([editorWindow.editor, 'on'], 'gizmoSelected', handleGizmoSelected)\n\n  // The client will report when an entity goes out of bounds\n  yield call([editorWindow.editor, 'on'], 'entitiesOutOfBoundaries', handleEntitiesOutOfBoundaries)\n\n  // Creates a new scene in the dcl client's side\n  const project: Project | Pool | null = yield type === PreviewType.POOL ? select(getCurrentPool) : select(getCurrentProject)\n\n  if (project) {\n    // load asset packs\n    const areLoaded: boolean = yield select(hasLoadedAssetPacks)\n    if (!areLoaded) {\n      yield put(loadAssetPacksRequest())\n    }\n\n    // fix legacy stuff\n    let scene: Scene = yield getSceneByProjectId(project.id, type)\n    yield put(fixLegacyNamespacesRequest(scene))\n    const fixSuccessAction: FixLegacyNamespacesSuccessAction = yield take(FIX_LEGACY_NAMESPACES_SUCCESS)\n    scene = fixSuccessAction.payload.scene\n\n    // if assets packs are being loaded wait for them to finish\n    const loading: AssetPackState['loading'] = yield select(getLoading)\n    if (isLoadingType(loading, LOAD_ASSET_PACKS_REQUEST)) {\n      yield take(LOAD_ASSET_PACKS_SUCCESS)\n    }\n\n    // sync scene assets\n    yield put(syncSceneAssetsRequest(scene))\n    const syncSuccessAction: ReturnType<typeof syncSceneAssetsSuccess> = yield take(SYNC_SCENE_ASSETS_SUCCESS)\n    scene = syncSuccessAction.payload.scene\n\n    yield put(setEditorReadOnly(isReadOnly))\n    yield createNewEditorScene(project)\n\n    // Set the remote url for scripts\n    yield call(() => editorWindow.editor.sendExternalAction(setScriptUrl(getContentsStorageUrl())))\n\n    // Spawns the assets\n    yield renderScene(scene)\n\n    // Enable snap to grid\n    yield handleToggleSnapToGrid(toggleSnapToGrid(true))\n\n    // Select gizmo\n    yield call(() => editorWindow.editor.selectGizmo(Gizmo.NONE))\n  } else {\n    console.error(`Unable to Open Editor: Invalid ${type}`)\n  }\n}\n\nfunction* handleCloseEditor() {\n  yield call(() => editorWindow.editor.off('metrics', handleMetricsChange))\n  yield call(() => editorWindow.editor.off('transform', handleTransformChange))\n  yield call(() => editorWindow.editor.off('ready', handleEditorReadyChange))\n  yield call(() => editorWindow.editor.off('gizmoSelected', handleGizmoSelected))\n  yield call(() => editorWindow.editor.off('entitiesOutOfBoundaries', handleEntitiesOutOfBoundaries))\n  const isReadyResult: boolean = yield select(isReady)\n  if (isReadyResult) {\n    yield call(() => editorWindow.editor.sendExternalAction(closeEditor()))\n  }\n  yield put(unbindEditorKeyboardShortcuts())\n}\n\nfunction* handleSetGizmo(action: SetGizmoAction) {\n  const isReadyResult: boolean = yield select(isReady)\n  if (isReadyResult) {\n    yield call(() => editorWindow.editor.selectGizmo(action.payload.gizmo))\n  }\n}\n\nfunction* handleTogglePreview(action: TogglePreviewAction) {\n  const { editor } = editorWindow\n  const { isEnabled } = action.payload\n  const gizmo: ReturnType<typeof getGizmo> = yield select(getGizmo)\n  const project: Project | null = yield select(getCurrentProject)\n  if (!project) return\n\n  const x = (project.layout.rows * PARCEL_SIZE) / 2\n  const z = -1\n\n  yield call(() => {\n    editor.setPlayMode(isEnabled)\n    editor.sendExternalAction(action)\n    editor.selectGizmo(isEnabled ? Gizmo.NONE : gizmo)\n  })\n\n  if (!isEnabled) {\n    const components: Scene['components'] = yield select(getComponents)\n    const hasScript = Object.values(components).some(component => component.type === ComponentType.Script)\n\n    if (hasScript) {\n      // Reset scene\n      yield createNewEditorScene(project)\n      yield call(() => editorWindow.editor.sendExternalAction(setScriptUrl(getContentsStorageUrl())))\n    }\n\n    yield handleResetCamera()\n    const scene: Scene = yield select(getCurrentScene)\n    yield renderScene(scene)\n  } else {\n    editor.setCameraPosition({ x, y: 1.5, z })\n    editor.setCameraRotation(0, 0)\n  }\n\n  yield changeEditorState(!isEnabled)\n}\n\nfunction handleZoomIn() {\n  editorWindow.editor.setCameraZoomDelta(-5)\n}\n\nfunction handleZoomOut() {\n  editorWindow.editor.setCameraZoomDelta(5)\n}\n\nfunction* handleSetEditorReady(action: SetEditorReadyAction) {\n  const { isReady } = action.payload\n  const project: Project | null = yield select(getCurrentProject)\n  if (project) {\n    if (isReady) {\n      try {\n        let scene: Scene = yield getSceneByProjectId(project.id)\n        yield handleEditorReady(scene)\n      } catch (error) {\n        console.error(error)\n      }\n    }\n\n    yield changeEditorState(isReady)\n  }\n}\n\nfunction* changeEditorState(isReady: boolean) {\n  if (isReady) {\n    yield put(bindEditorKeyboardShortcuts())\n  } else {\n    yield put(unbindEditorKeyboardShortcuts())\n  }\n}\n\nfunction* handleResetCamera() {\n  const project: Project | null = yield select(getCurrentProject)\n  if (!project) return\n\n  const x = (project.layout.rows * PARCEL_SIZE) / 2\n  const z = (project.layout.cols * PARCEL_SIZE) / 2\n\n  editorWindow.editor.resetCameraZoom()\n  editorWindow.editor.setCameraPosition({ x, y: 0, z })\n  editorWindow.editor.setCameraRotation((7 * Math.PI) / 4, Math.PI / 6)\n}\n\nfunction* handleDropItem(action: DropItemAction) {\n  const { asset, x, y } = action.payload\n  if (asset.category === GROUND_CATEGORY) {\n    const project: ReturnType<typeof getCurrentProject> = yield select(getCurrentProject)\n    if (!project) return\n    yield put(setGround(project.id, asset))\n  } else {\n    const position: Vector3 = yield call(() => editorWindow.editor.getMouseWorldPosition(x, y))\n    yield put(addItem(asset, position))\n  }\n}\n\nfunction* handleScreenshot(_: TakeScreenshotAction) {\n  yield put(setScreenshotReady(false))\n  try {\n    const currentProject: Project | null = yield select(getCurrentProject)\n    if (!currentProject) return\n\n    // wait for editor to be ready\n    let ready: boolean = yield select(isReady)\n    while (!ready) {\n      const readyAction: SetEditorReadyAction = yield take(SET_EDITOR_READY)\n      ready = readyAction.payload.isReady\n    }\n\n    // wait for assets to load\n    let loading: boolean = yield select(isLoading)\n    while (loading) {\n      const loadingAction: SetEditorLoadingAction = yield take(SET_EDITOR_LOADING)\n      loading = loadingAction.payload.isLoading\n    }\n\n    // rendering leeway\n    yield delay(2000)\n\n    const screenshot: string = yield call(() => editorWindow.editor.takeScreenshot())\n    if (!screenshot) return\n\n    const thumbnail: string | null = yield call(() => resizeScreenshot(screenshot, THUMBNAIL_WIDTH, THUMBNAIL_HEIGHT))\n    if (!thumbnail) return\n\n    yield put(editProjectThumbnail(currentProject.id, thumbnail))\n  } catch (e) {\n    // skip screenshot\n  }\n  yield put(setScreenshotReady(true))\n}\n\nfunction* handleSetSelectEntities(action: SetSelectedEntitiesAction) {\n  yield call(() => {\n    try {\n      // this could throw if the entity does not exist, due to some race condition or the scene is not synced\n      editorWindow.editor.setSelectedEntities(action.payload.entityIds)\n    } catch (e) {\n      // noop\n    }\n  })\n}\n\nfunction* handleToggleSnapToGrid(action: ToggleSnapToGridAction) {\n  yield call(() => {\n    if (action.payload.enabled) {\n      editorWindow.editor.setGridResolution(POSITION_GRID_RESOLUTION, ROTATION_GRID_RESOLUTION, SCALE_GRID_RESOLUTION)\n    } else {\n      editorWindow.editor.setGridResolution(0, 0, 0)\n    }\n  })\n}\n\nfunction* handlePrefetchAsset(action: PrefetchAssetAction) {\n  yield call(() => {\n    const contentEntries = Object.entries(action.payload.asset.contents)\n    for (let [file, hash] of contentEntries) {\n      if ((file.endsWith('.png') || file.endsWith('.glb') || file.endsWith('.gltf')) && !file.endsWith(THUMBNAIL_PATH)) {\n        editorWindow.editor.preloadFile(`${hash}\\t${action.payload.asset.id}/${file}`)\n      }\n    }\n  })\n}\n\nfunction handleEntitiesOutOfBoundaries(args: { entities: string[] }) {\n  const { entities } = args\n  const state = store.getState() as RootState\n  const entitiesInState: string[] = getEntitiesOutOfBoundaries(state)\n  if (entities.length === 0 && entitiesInState.length === 0) {\n    return\n  }\n  const previewMode: boolean = isPreviewing(state)\n  if (!previewMode) {\n    store.dispatch(setEntitiesOutOfBoundaries(entities))\n  }\n}\n\nfunction* handleSetBodyShape(_action: SetBodyShapeAction) {\n  // this gets rid of items that don't have a representation for the current body shape\n  const visibleItems: Item[] = yield select(getVisibleItems)\n  yield put(setItems(visibleItems))\n}\n\nfunction* handleFetchBaseWearables() {\n  try {\n    const response: Response = yield call(\n      fetch,\n      `${PEER_URL}/lambdas/collections/wearables?collectionId=urn:decentraland:off-chain:base-avatars`\n    )\n    if (!response.ok) {\n      throw new Error('Failed to fetch base wearables')\n    }\n    const json: { wearables: CatalystWearable[] } = yield response.json()\n    // Filter wearables that hide or replace others, preventing issues with the previewed\n    const wearables: Wearable[] = json.wearables\n      .filter(wearable => {\n        const hidesWearables = wearable.data.hides && wearable.data.hides.length > 0\n        const replacesWearables = wearable.data.replaces && wearable.data.replaces.length > 0\n        return !hidesWearables && !replacesWearables\n      })\n      .map(fromCatalystWearableToWearable)\n    yield put(fetchBaseWearablesSuccess(wearables))\n  } catch (e) {\n    yield put(fetchBaseWearablesFailure(e.message))\n  }\n}\n"]},"metadata":{},"sourceType":"module"}