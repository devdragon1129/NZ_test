import { EventDispatcher } from '../core/EventDispatcher';
import { isPromiseLike } from '../core/isPromiseLike';
const errorColumns = { name: 1, message: 1, stack: 1, columnNumber: 1, fileName: 1, lineNumber: 1 };
function sanitizeError(error) {
    if (error instanceof Error) {
        const ret = Object.assign({}, error);
        for (let i in errorColumns) {
            ret[i] = error[i];
        }
        return ret;
    }
    else {
        return error;
    }
}
export class Server extends EventDispatcher {
    constructor(opts = {}) {
        super();
        this._exposedMethodsMap = new Map();
        this._consoleLog = false;
        this._isEnabled = false;
        this.setLogging(opts);
    }
    get isEnabled() {
        return this._isEnabled;
    }
    on(method, callback, once) {
        return super.on(method, callback, once);
    }
    once(method, callback) {
        return super.once(method, callback);
    }
    setLogging({ logConsole } = {}) {
        this._consoleLog = !!logConsole;
    }
    expose(method, handler) {
        this._exposedMethodsMap.set(method, handler);
    }
    notify(method, params) {
        if (typeof params !== 'undefined' && typeof params !== 'object') {
            throw new Error(`Server#notify Params must be structured data (Array | Object) got ${JSON.stringify(params)}`);
        }
        const clients = this.getAllClients();
        if (clients) {
            for (let client of clients) {
                this._send(client, { method, params, jsonrpc: '2.0' });
            }
        }
        else {
            throw new Error('Server does not support broadcasting. No "getAllClients: ClientType[]" returned null');
        }
    }
    enable() {
        if (!this._isEnabled) {
            this._isEnabled = true;
            this.notify('RPC.Enabled');
        }
    }
    disable() {
        if (this._isEnabled) {
            this._isEnabled = false;
        }
    }
    processMessage(from, messageStr) {
        this._logMessage(messageStr, 'receive');
        let request;
        try {
            if (typeof messageStr === 'string' && messageStr.charAt(0) === '{') {
                request = JSON.parse(messageStr);
            }
            else {
                throw new Error(`Unable to parse message ${JSON.stringify(messageStr)}`);
            }
        }
        catch (e) {
            return this._sendError(from, null, -32700, e);
        }
        if (request && request.method && typeof request.method === 'string') {
            if (request.id && typeof request.id === 'number') {
                const handler = this._exposedMethodsMap.get(request.method);
                if (handler) {
                    if (request.params && typeof request.params !== 'object') {
                        this._sendError(from, request, 32602, new Error('params is not an Array or Object'));
                    }
                    else {
                        try {
                            const result = request.params instanceof Array
                                ? handler.apply(this, request.params)
                                : handler.call(this, request.params);
                            if (isPromiseLike(result)) {
                                result
                                    .then((actualResult) => {
                                    this._send(from, {
                                        jsonrpc: '2.0',
                                        id: request.id,
                                        result: typeof actualResult === 'undefined' ? null : actualResult
                                    });
                                })
                                    .catch((error) => {
                                    this._sendError(from, request, -32603, error);
                                });
                            }
                            else {
                                this._send(from, {
                                    jsonrpc: '2.0',
                                    id: request.id,
                                    result: typeof result === 'undefined' ? null : result
                                });
                            }
                        }
                        catch (error) {
                            this._sendError(from, request, -32603, error);
                        }
                    }
                }
                else {
                    console.log(`Method ${request.method} not present in `, this._exposedMethodsMap);
                    this._sendError(from, request, -32601);
                }
            }
            else {
                this.emit(request.method, request.params);
            }
        }
        else {
            this._sendError(from, request, -32600);
        }
    }
    _logMessage(messageStr, direction) {
        if (this._consoleLog) {
            console.log(`${direction === 'send' ? 'Server > Client' : 'Server < Client'}`, messageStr);
        }
    }
    _send(receiver, message) {
        let messageStr;
        messageStr = JSON.stringify(message);
        this._logMessage(messageStr, 'send');
        this.sendMessage(receiver, messageStr);
    }
    _sendError(receiver, request, errorCode, error) {
        try {
            this._send(receiver, {
                jsonrpc: '2.0',
                id: (request && request.id) || -1,
                error: this._errorFromCode(errorCode, sanitizeError(error), request && request.method)
            });
        }
        catch (error) {
        }
    }
    _errorFromCode(code, data = null, method = null) {
        let message = '';
        switch (code) {
            case -32603:
                message = `InternalError: Internal Error when calling '${method}'`;
                break;
            case -32601:
                message = `MethodNotFound: '${method}' wasn't found`;
                break;
            case -32600:
                message = 'InvalidRequest: JSON sent is not a valid request object';
                break;
            case -32700:
                message = 'ParseError: invalid JSON received';
                break;
        }
        return { code, message, data };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2VydmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbW1vbi9qc29uLXJwYy9TZXJ2ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxFQUFFLGVBQWUsRUFBMEIsTUFBTSx5QkFBeUIsQ0FBQTtBQUNqRixPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sdUJBQXVCLENBQUE7QUFFckQsTUFBTSxZQUFZLEdBQUcsRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUFFLE9BQU8sRUFBRSxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxZQUFZLEVBQUUsQ0FBQyxFQUFFLFFBQVEsRUFBRSxDQUFDLEVBQUUsVUFBVSxFQUFFLENBQUMsRUFBRSxDQUFBO0FBRW5HLFNBQVMsYUFBYSxDQUFDLEtBQVU7SUFDL0IsSUFBSSxLQUFLLFlBQVksS0FBSyxFQUFFO1FBQzFCLE1BQU0sR0FBRyxHQUFRLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFBO1FBRXpDLEtBQUssSUFBSSxDQUFDLElBQUksWUFBWSxFQUFFO1lBQzFCLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBSSxLQUFhLENBQUMsQ0FBQyxDQUFDLENBQUE7U0FDM0I7UUFFRCxPQUFPLEdBQUcsQ0FBQTtLQUNYO1NBQU07UUFDTCxPQUFPLEtBQUssQ0FBQTtLQUNiO0FBQ0gsQ0FBQztBQU1ELE1BQU0sT0FBZ0IsTUFBeUIsU0FBUSxlQUFlO0lBU3BFLFlBQVksT0FBNkIsRUFBRTtRQUN6QyxLQUFLLEVBQUUsQ0FBQTtRQVRELHVCQUFrQixHQUE2RCxJQUFJLEdBQUcsRUFBRSxDQUFBO1FBQ3hGLGdCQUFXLEdBQVksS0FBSyxDQUFBO1FBQzVCLGVBQVUsR0FBRyxLQUFLLENBQUE7UUFReEIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUN2QixDQUFDO0lBUEQsSUFBSSxTQUFTO1FBQ1gsT0FBTyxJQUFJLENBQUMs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Q0FDaEIsUUFBb0IsRUFDcEIsT0FBaUMsRUFDakMsU0FBNkIsRUFDN0IsS0FBYTtRQUViLElBQUk7WUFDRixJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRTtnQkFDbkIsT0FBTyxFQUFFLEtBQUs7Z0JBQ2QsRUFBRSxFQUFFLENBQUMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ2pDLEtBQUssRUFBRSxJQUFJLENBQUMsY0FBYyxDQUFDLFNBQVMsRUFBRSxhQUFhLENBQUMsS0FBSyxDQUFDLEVBQUUsT0FBTyxJQUFJLE9BQU8sQ0FBQyxNQUFNLENBQUM7YUFDdkYsQ0FBQyxDQUFBO1NBQ0g7UUFBQyxPQUFPLEtBQUssRUFBRTtTQUVmO0lBQ0gsQ0FBQztJQUVPLGNBQWMsQ0FBQyxJQUF3QixFQUFFLE9BQVksSUFBSSxFQUFFLFNBQXdCLElBQUk7UUFDN0YsSUFBSSxPQUFPLEdBQUcsRUFBRSxDQUFBO1FBRWhCLFFBQVEsSUFBSSxFQUFFO1lBQ1o7Z0JBQ0UsT0FBTyxHQUFHLCtDQUErQyxNQUFNLEdBQUcsQ0FBQTtnQkFDbEUsTUFBSztZQUNQO2dCQUNFLE9BQU8sR0FBRyxvQkFBb0IsTUFBTSxnQkFBZ0IsQ0FBQTtnQkFDcEQsTUFBSztZQUNQO2dCQUNFLE9BQU8sR0FBRyx5REFBeUQsQ0FBQTtnQkFDbkUsTUFBSztZQUNQO2dCQUNFLE9BQU8sR0FBRyxtQ0FBbUMsQ0FBQTtnQkFDN0MsTUFBSztTQUNSO1FBRUQsT0FBTyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLENBQUE7SUFDaEMsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgSnNvblJwYzIgZnJvbSAnLi90eXBlcydcblxuaW1wb3J0IHsgRXZlbnREaXNwYXRjaGVyLCBFdmVudERpc3BhdGNoZXJCaW5kaW5nIH0gZnJvbSAnLi4vY29yZS9FdmVudERpc3BhdGNoZXInXG5pbXBvcnQgeyBpc1Byb21pc2VMaWtlIH0gZnJvbSAnLi4vY29yZS9pc1Byb21pc2VMaWtlJ1xuXG5jb25zdCBlcnJvckNvbHVtbnMgPSB7IG5hbWU6IDEsIG1lc3NhZ2U6IDEsIHN0YWNrOiAxLCBjb2x1bW5OdW1iZXI6IDEsIGZpbGVOYW1lOiAxLCBsaW5lTnVtYmVyOiAxIH1cblxuZnVuY3Rpb24gc2FuaXRpemVFcnJvcihlcnJvcjogYW55KSB7XG4gIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgY29uc3QgcmV0OiBhbnkgPSBPYmplY3QuYXNzaWduKHt9LCBlcnJvcilcblxuICAgIGZvciAobGV0IGkgaW4gZXJyb3JDb2x1bW5zKSB7XG4gICAgICByZXRbaV0gPSAoZXJyb3IgYXMgYW55KVtpXVxuICAgIH1cblxuICAgIHJldHVybiByZXRcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gZXJyb3JcbiAgfVxufVxuXG4vKipcbiAqIENyZWF0ZXMgYSBSUEMgU2VydmVyLlxuICogSXQgaXMgaW50ZW50aW9uYWwgdGhhdCBTZXJ2ZXIgZG9lcyBub3QgY3JlYXRlIGEgV29ya2VyIG9iamVjdCBzaW5jZSB3ZSBwcmVmZXIgY29tcG9zYWJpbGl0eVxuICovXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgU2VydmVyPENsaWVudFR5cGUgPSBhbnk+IGV4dGVuZHMgRXZlbnREaXNwYXRjaGVyIGltcGxlbWVudHMgSnNvblJwYzIuSVNlcnZlciB7XG4gIHByaXZhdGUgX2V4cG9zZWRNZXRob2RzTWFwOiBNYXA8c3RyaW5nLCAocGFyYW1zOiBhbnkpID0+IEpzb25ScGMyLlByb21pc2VPck5vdDxhbnk+PiA9IG5ldyBNYXAoKVxuICBwcml2YXRlIF9jb25zb2xlTG9nOiBib29sZWFuID0gZmFsc2VcbiAgcHJpdmF0ZSBfaXNFbmFibGVkID0gZmFsc2VcblxuICBnZXQgaXNFbmFibGVkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLl9pc0VuYWJsZWRcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKG9wdHM6IEpzb25ScGMyLklTZXJ2ZXJPcHRzID0ge30pIHtcbiAgICBzdXBlcigpXG4gICAgdGhpcy5zZXRMb2dnaW5nKG9wdHMpXG4gIH1cblxuICBhYnN0cmFjdCBzZW5kTWVzc2FnZSh0bzogQ2xpZW50VHlwZSwgbWVzc2FnZTogc3RyaW5nKTogdm9pZFxuICBhYnN0cmFjdCBnZXRBbGxDbGllbnRzKCk6IEl0ZXJhYmxlPENsaWVudFR5cGU+XG5cbiAgb24obWV0aG9kOiAnZXJyb3InLCBjYWxsYmFjazogKGVycm9yOiBhbnkpID0+IHZvaWQsIG9uY2U/OiBib29sZWFuKTogRXZlbnREaXNwYXRjaGVyQmluZGluZ1xuICBvbihtZXRob2Q6IHN0cmluZywgY2FsbGJhY2s6IChwYXJhbXM6IGFueSwgc2VuZGVyOiBDbGllbnRUeXBlKSA9PiB2b2lkLCBvbmNlPzogYm9vbGVhbik6IEV2ZW50RGlzcGF0Y2hlckJpbmRpbmdcbiAgb24obWV0aG9kOiBzdHJpbmcsIGNhbGxiYWNrOiAocGFyYW1zOiBhbnksIHNlbmRlcjogQ2xpZW50VHlwZSkgPT4gdm9pZCwgb25jZT86IGJvb2xlYW4pOiBFdmVudERpc3BhdGNoZXJCaW5kaW5nIHtcbiAgICByZXR1cm4gc3VwZXIub24obWV0aG9kLCBjYWxsYmFjaywgb25jZSlcbiAgfVxuXG4gIG9uY2UobWV0aG9kOiAnZXJyb3InLCBjYWxsYmFjazogKGVycm9yOiBhbnkpID0+IHZvaWQpOiBFdmVudERpc3BhdGNoZXJCaW5kaW5nXG4gIG9uY2UobWV0aG9kOiBzdHJpbmcsIGNhbGxiYWNrOiAocGFyYW1zOiBhbnksIHNlbmRlcjogQ2xpZW50VHlwZSkgPT4gdm9pZCk6IEV2ZW50RGlzcGF0Y2hlckJpbmRpbmdcbiAgb25jZShtZXRob2Q6IHN0cmluZywgY2FsbGJhY2s6IChwYXJhbXM6IGFueSwgc2VuZGVyOiBDbGllbnRUeXBlKSA9PiB2b2lkKTogRXZlbnREaXNwYXRjaGVyQmluZGluZyB7XG4gICAgcmV0dXJuIHN1cGVyLm9uY2UobWV0aG9kLCBjYWxsYmFjaylcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgbG9nZ2luZyBmb3IgYWxsIHJlY2VpdmVkIGFuZCBzZW50IG1lc3NhZ2VzXG4gICAqL1xuICBwdWJsaWMgc2V0TG9nZ2luZyh7IGxvZ0NvbnNvbGUgfTogSnNvblJwYzIuSUxvZ09wdHMgPSB7fSkge1xuICAgIHRoaXMuX2NvbnNvbGVMb2cgPSAhIWxvZ0NvbnNvbGVcbiAgfVxuXG4gIGV4cG9zZShtZXRob2Q6IHN0cmluZywgaGFuZGxlcjogKC4uLnBhcmFtczogYW55W10pID0+IFByb21pc2U8YW55Pik6IHZvaWQge1xuICAgIHRoaXMuX2V4cG9zZWRNZXRob2RzTWFwLnNldChtZXRob2QsIGhhbmRsZXIpXG4gIH1cblxuICBub3RpZnkobWV0aG9kOiBzdHJpbmcpOiB2b2lkXG4gIG5vdGlmeShtZXRob2Q6IHN0cmluZywgcGFyYW1zOiBzdHJpbmcpOiBuZXZlclxuICBub3RpZnkobWV0aG9kOiBzdHJpbmcsIHBhcmFtczogbnVtYmVyKTogbmV2ZXJcbiAgbm90aWZ5KG1ldGhvZDogc3RyaW5nLCBwYXJhbXM6IGJvb2xlYW4pOiBuZXZlclxuICBub3RpZnkobWV0aG9kOiBzdHJpbmcsIHBhcmFtczogbnVsbCk6IG5ldmVyXG4gIG5vdGlmeTxUPihtZXRob2Q6IHN0cmluZywgcGFyYW1zOiBJdGVyYWJsZTxUPik6IHZvaWRcbiAgbm90aWZ5KG1ldGhvZDogc3RyaW5nLCBwYXJhbXM/OiBPYmplY3QpOiB2b2lkXG4gIG5vdGlmeShtZXRob2Q6IHN0cmluZywgcGFyYW1zPzogYW55KTogdm9pZCB7XG4gICAgaWYgKHR5cGVvZiBwYXJhbXMgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZiBwYXJhbXMgIT09ICdvYmplY3QnKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFNlcnZlciNub3RpZnkgUGFyYW1zIG11c3QgYmUgc3RydWN0dXJlZCBkYXRhIChBcnJheSB8IE9iamVjdCkgZ290ICR7SlNPTi5zdHJpbmdpZnkocGFyYW1zKX1gKVxuICAgIH1cbiAgICAvLyBCcm9hZGNhc3QgbWVzc2FnZSB0byBhbGwgY2xpZW50c1xuICAgIGNvbnN0IGNsaWVudHMgPSB0aGlzLmdldEFsbENsaWVudHMoKVxuXG4gICAgaWYgKGNsaWVudHMpIHtcbiAgICAgIGZvciAobGV0IGNsaWVudCBvZiBjbGllbnRzKSB7XG4gICAgICAgIHRoaXMuX3NlbmQoY2xpZW50LCB7IG1ldGhvZCwgcGFyYW1zLCBqc29ucnBjOiAnMi4wJyB9KVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NlcnZlciBkb2VzIG5vdCBzdXBwb3J0IGJyb2FkY2FzdGluZy4gTm8gXCJnZXRBbGxDbGllbnRzOiBDbGllbnRUeXBlW11cIiByZXR1cm5lZCBudWxsJylcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRXhlY3V0ZSB0aGlzIG1ldGhvZCBhZnRlciBjb25maWd1cmluZyB0aGUgUlBDIG1ldGhvZHMgYW5kIGxpc3RlbmVycy5cbiAgICogSXQgd2lsbCBzZW5kIGFuIGVtcHR5IG5vdGlmaWNhdGlvbiB0byB0aGUgY2xpZW50LCB0aGVuIGl0ICh0aGUgY2xpZW50KSB3aWxsIHNlbmQgYWxsIHRoZSBlbnF1ZXVlZCBtZXNzYWdlcy5cbiAgICovXG4gIHByb3RlY3RlZCBlbmFibGUoKSB7XG4gICAgaWYgKCF0aGlzLl9pc0VuYWJsZWQpIHtcbiAgICAgIHRoaXMuX2lzRW5hYmxlZCA9IHRydWVcbiAgICAgIHRoaXMubm90aWZ5KCdSUEMuRW5hYmxlZCcpXG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIGRpc2FibGUoKSB7XG4gICAgaWYgKHRoaXMuX2lzRW5hYmxlZCkge1xuICAgICAgdGhpcy5faXNFbmFibGVkID0gZmFsc2VcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgcHJvY2Vzc01lc3NhZ2UoZnJvbTogQ2xpZW50VHlwZSwgbWVzc2FnZVN0cjogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy5fbG9nTWVzc2FnZShtZXNzYWdlU3RyLCAncmVjZWl2ZScpXG4gICAgbGV0IHJlcXVlc3Q6IEpzb25ScGMyLklSZXF1ZXN0XG5cbiAgICB0cnkge1xuICAgICAgaWYgKHR5cGVvZiAobWVzc2FnZVN0ciBhcyBhbnkpID09PSAnc3RyaW5nJyAmJiBtZXNzYWdlU3RyLmNoYXJBdCgwKSA9PT0gJ3snKSB7XG4gICAgICAgIC8vIEVuc3VyZSBKU09OIGlzIG5vdCBtYWxmb3JtZWRcbiAgICAgICAgcmVxdWVzdCA9IEpTT04ucGFyc2UobWVzc2FnZVN0cilcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5hYmxlIHRvIHBhcnNlIG1lc3NhZ2UgJHtKU09OLnN0cmluZ2lmeShtZXNzYWdlU3RyKX1gKVxuICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHJldHVybiB0aGlzLl9zZW5kRXJyb3IoZnJvbSwgbnVsbCwgSnNvblJwYzIuRXJyb3JDb2RlLlBhcnNlRXJyb3IsIGUpXG4gICAgfVxuXG4gICAgLy8gRW5zdXJlIG1ldGhvZCBpcyBhdGxlYXN0IGRlZmluZWRcbiAgICBpZiAocmVxdWVzdCAmJiByZXF1ZXN0Lm1ldGhvZCAmJiB0eXBlb2YgKHJlcXVlc3QubWV0aG9kIGFzIGFueSkgPT09ICdzdHJpbmcnKSB7XG4gICAgICBpZiAocmVxdWVzdC5pZCAmJiB0eXBlb2YgKHJlcXVlc3QuaWQgYXMgYW55KSA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgY29uc3QgaGFuZGxlciA9IHRoaXMuX2V4cG9zZWRNZXRob2RzTWFwLmdldChyZXF1ZXN0Lm1ldGhvZClcbiAgICAgICAgLy8gSGFuZGxlciBpcyBkZWZpbmVkIHNvIGxldHMgY2FsbCBpdFxuICAgICAgICBpZiAoaGFuZGxlcikge1xuICAgICAgICAgIGlmIChyZXF1ZXN0LnBhcmFtcyAmJiB0eXBlb2YgcmVxdWVzdC5wYXJhbXMgIT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICB0aGlzLl9zZW5kRXJyb3IoXG4gICAgICAgICAgICAgIGZyb20sXG4gICAgICAgICAgICAgIHJlcXVlc3QsXG4gICAgICAgICAgICAgIEpzb25ScGMyLkVycm9yQ29kZS5JbnZhbGlkUGFyYW1zLFxuICAgICAgICAgICAgICBuZXcgRXJyb3IoJ3BhcmFtcyBpcyBub3QgYW4gQXJyYXkgb3IgT2JqZWN0JylcbiAgICAgICAgICAgIClcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgY29uc3QgcmVzdWx0OiBKc29uUnBjMi5Qcm9taXNlT3JOb3Q8YW55PiA9XG4gICAgICAgICAgICAgICAgcmVxdWVzdC5wYXJhbXMgaW5zdGFuY2VvZiBBcnJheVxuICAgICAgICAgICAgICAgICAgPyBoYW5kbGVyLmFwcGx5KHRoaXMsIHJlcXVlc3QucGFyYW1zIGFzIGFueSlcbiAgICAgICAgICAgICAgICAgIDogaGFuZGxlci5jYWxsKHRoaXMsIHJlcXVlc3QucGFyYW1zKVxuXG4gICAgICAgICAgICAgIGlmIChpc1Byb21pc2VMaWtlKHJlc3VsdCkpIHtcbiAgICAgICAgICAgICAgICAvLyBSZXN1bHQgaXMgYSBwcm9taXNlLCBzbyBsZXRzIHdhaXQgZm9yIHRoZSByZXN1bHQgYW5kIGhhbmRsZSBhY2NvcmRpbmdseVxuICAgICAgICAgICAgICAgIHJlc3VsdFxuICAgICAgICAgICAgICAgICAgLnRoZW4oKGFjdHVhbFJlc3VsdDogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3NlbmQoZnJvbSwge1xuICAgICAgICAgICAgICAgICAgICAgIGpzb25ycGM6ICcyLjAnLFxuICAgICAgICAgICAgICAgICAgICAgIGlkOiByZXF1ZXN0LmlkLFxuICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDogdHlwZW9mIGFjdHVhbFJlc3VsdCA9PT0gJ3VuZGVmaW5lZCcgPyBudWxsIDogYWN0dWFsUmVzdWx0XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgLmNhdGNoKChlcnJvcjogRXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2VuZEVycm9yKGZyb20sIHJlcXVlc3QsIEpzb25ScGMyLkVycm9yQ29kZS5JbnRlcm5hbEVycm9yLCBlcnJvcilcbiAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gUmVzdWx0IGlzIG5vdCBhIHByb21pc2Ugc28gc2VuZCBpbW1lZGlhdGVseVxuICAgICAgICAgICAgICAgIHRoaXMuX3NlbmQoZnJvbSwge1xuICAgICAgICAgICAgICAgICAganNvbnJwYzogJzIuMCcsXG4gICAgICAgICAgICAgICAgICBpZDogcmVxdWVzdC5pZCxcbiAgICAgICAgICAgICAgICAgIHJlc3VsdDogdHlwZW9mIHJlc3VsdCA9PT0gJ3VuZGVmaW5lZCcgPyBudWxsIDogcmVzdWx0XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgdGhpcy5fc2VuZEVycm9yKGZyb20sIHJlcXVlc3QsIEpzb25ScGMyLkVycm9yQ29kZS5JbnRlcm5hbEVycm9yLCBlcnJvcilcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc29sZS5sb2coYE1ldGhvZCAke3JlcXVlc3QubWV0aG9kfSBub3QgcHJlc2VudCBpbiBgLCB0aGlzLl9leHBvc2VkTWV0aG9kc01hcClcbiAgICAgICAgICB0aGlzLl9zZW5kRXJyb3IoZnJvbSwgcmVxdWVzdCwgSnNvblJwYzIuRXJyb3JDb2RlLk1ldGhvZE5vdEZvdW5kKVxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBNZXNzYWdlIGlzIGEgbm90aWZpY2F0aW9uLCBzbyBqdXN0IGVtaXRcbiAgICAgICAgdGhpcy5lbWl0KHJlcXVlc3QubWV0aG9kLCByZXF1ZXN0LnBhcmFtcylcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgLy8gTm8gbWV0aG9kIHByb3BlcnR5LCBzZW5kIEludmFsaWRSZXF1ZXN0IGVycm9yXG4gICAgICB0aGlzLl9zZW5kRXJyb3IoZnJvbSwgcmVxdWVzdCwgSnNvblJwYzIuRXJyb3JDb2RlLkludmFsaWRSZXF1ZXN0KVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX2xvZ01lc3NhZ2UobWVzc2FnZVN0cjogc3RyaW5nLCBkaXJlY3Rpb246ICdzZW5kJyB8ICdyZWNlaXZlJykge1xuICAgIGlmICh0aGlzLl9jb25zb2xlTG9nKSB7XG4gICAgICBjb25zb2xlLmxvZyhgJHtkaXJlY3Rpb24gPT09ICdzZW5kJyA/ICdTZXJ2ZXIgPiBDbGllbnQnIDogJ1NlcnZlciA8IENsaWVudCd9YCwgbWVzc2FnZVN0cilcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF9zZW5kKHJlY2VpdmVyOiBDbGllbnRUeXBlLCBtZXNzYWdlOiBKc29uUnBjMi5JUmVzcG9uc2UgfCBKc29uUnBjMi5JTm90aWZpY2F0aW9uKSB7XG4gICAgbGV0IG1lc3NhZ2VTdHI6IHN0cmluZ1xuXG4gICAgbWVzc2FnZVN0ciA9IEpTT04uc3RyaW5naWZ5KG1lc3NhZ2UpXG5cbiAgICB0aGlzLl9sb2dNZXNzYWdlKG1lc3NhZ2VTdHIsICdzZW5kJylcbiAgICB0aGlzLnNlbmRNZXNzYWdlKHJlY2VpdmVyLCBtZXNzYWdlU3RyKVxuICB9XG5cbiAgcHJpdmF0ZSBfc2VuZEVycm9yKFxuICAgIHJlY2VpdmVyOiBDbGllbnRUeXBlLFxuICAgIHJlcXVlc3Q6IEpzb25ScGMyLklSZXF1ZXN0IHwgbnVsbCxcbiAgICBlcnJvckNvZGU6IEpzb25ScGMyLkVycm9yQ29kZSxcbiAgICBlcnJvcj86IEVycm9yXG4gICkge1xuICAgIHRyeSB7XG4gICAgICB0aGlzLl9zZW5kKHJlY2VpdmVyLCB7XG4gICAgICAgIGpzb25ycGM6ICcyLjAnLFxuICAgICAgICBpZDogKHJlcXVlc3QgJiYgcmVxdWVzdC5pZCkgfHwgLTEsXG4gICAgICAgIGVycm9yOiB0aGlzLl9lcnJvckZyb21Db2RlKGVycm9yQ29kZSwgc2FuaXRpemVFcnJvcihlcnJvciksIHJlcXVlc3QgJiYgcmVxdWVzdC5tZXRob2QpXG4gICAgICB9KVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAvLyBTaW5jZSB3ZSBjYW4ndCBldmVuIHNlbmQgZXJyb3JzLCBkbyBub3RoaW5nLiBUaGUgY29ubmVjdGlvbiB3YXMgcHJvYmFibHkgY2xvc2VkLlxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX2Vycm9yRnJvbUNvZGUoY29kZTogSnNvblJwYzIuRXJyb3JDb2RlLCBkYXRhOiBhbnkgPSBudWxsLCBtZXRob2Q6IHN0cmluZyB8IG51bGwgPSBudWxsKTogSnNvblJwYzIuSUVycm9yIHtcbiAgICBsZXQgbWVzc2FnZSA9ICcnXG5cbiAgICBzd2l0Y2ggKGNvZGUpIHtcbiAgICAgIGNhc2UgSnNvblJwYzIuRXJyb3JDb2RlLkludGVybmFsRXJyb3I6XG4gICAgICAgIG1lc3NhZ2UgPSBgSW50ZXJuYWxFcnJvcjogSW50ZXJuYWwgRXJyb3Igd2hlbiBjYWxsaW5nICcke21ldGhvZH0nYFxuICAgICAgICBicmVha1xuICAgICAgY2FzZSBKc29uUnBjMi5FcnJvckNvZGUuTWV0aG9kTm90Rm91bmQ6XG4gICAgICAgIG1lc3NhZ2UgPSBgTWV0aG9kTm90Rm91bmQ6ICcke21ldGhvZH0nIHdhc24ndCBmb3VuZGBcbiAgICAgICAgYnJlYWtcbiAgICAgIGNhc2UgSnNvblJwYzIuRXJyb3JDb2RlLkludmFsaWRSZXF1ZXN0OlxuICAgICAgICBtZXNzYWdlID0gJ0ludmFsaWRSZXF1ZXN0OiBKU09OIHNlbnQgaXMgbm90IGEgdmFsaWQgcmVxdWVzdCBvYmplY3QnXG4gICAgICAgIGJyZWFrXG4gICAgICBjYXNlIEpzb25ScGMyLkVycm9yQ29kZS5QYXJzZUVycm9yOlxuICAgICAgICBtZXNzYWdlID0gJ1BhcnNlRXJyb3I6IGludmFsaWQgSlNPTiByZWNlaXZlZCdcbiAgICAgICAgYnJlYWtcbiAgICB9XG5cbiAgICByZXR1cm4geyBjb2RlLCBtZXNzYWdlLCBkYXRhIH1cbiAgfVxufVxuIl19