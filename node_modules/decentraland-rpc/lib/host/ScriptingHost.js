import { TransportBasedServer } from './TransportBasedServer';
import { hasOwnSymbol } from '../common/core/SymbolShim';
const hasSymbol = typeof Symbol === 'function' && Symbol.for;
const apiNameSymbol = hasSymbol ? Symbol('pluginName') : 0xfea2;
const registeredAPIs = {};
var PrivateHelpers;
(function (PrivateHelpers) {
    function _registerAPI(apiName, api) {
        const hasName = hasOwnSymbol(api, apiNameSymbol);
        if (hasName) {
            throw new Error(`The API you are trying to register is already registered`);
        }
        if (apiName in registeredAPIs) {
            throw new Error(`The API ${apiName} is already registered`);
        }
        if (typeof api !== 'function') {
            throw new Error(`The API ${apiName} is not a class, it is of type ${typeof api}`);
        }
        ;
        api[apiNameSymbol] = apiName;
        registeredAPIs[apiName] = api;
    }
    PrivateHelpers._registerAPI = _registerAPI;
    function unmountAPI(api) {
        if (api.apiWillUnmount) {
            const promise = api.apiWillUnmount();
            if (promise && 'catch' in promise) {
                promise.catch(error => console.error('Error unmounting API', { api, error }));
            }
        }
    }
    PrivateHelpers.unmountAPI = unmountAPI;
    function mountAPI(api) {
        if (api.apiDidMount) {
            const promise = api.apiDidMount();
            if (promise && 'catch' in promise) {
                promise.catch(error => console.error('Error mounting API', { api, error }));
            }
        }
    }
    PrivateHelpers.mountAPI = mountAPI;
})(PrivateHelpers || (PrivateHelpers = {}));
export var ScriptingHostEvents;
(function (ScriptingHostEvents) {
    ScriptingHostEvents["systemWillUnmount"] = "systemWillUnmount";
    ScriptingHostEvents["systemWillEnable"] = "systemWillEnable";
    ScriptingHostEvents["systemDidUnmount"] = "systemDidUnmount";
})(ScriptingHostEvents || (ScriptingHostEvents = {}));
export function getAPIName(klass) {
    return klass[apiNameSymbol] || klass.name || null;
}
export function registerAPI(apiName) {
    return function (api) {
        PrivateHelpers._registerAPI(apiName, api);
    };
}
export class ScriptingHost extends TransportBasedServer {
    constructor(worker) {
        super(worker);
        this.unmounted = false;
        this.apiInstances = new Map();
        this.expose('LoadComponents', this.RPCLoadAPIs.bind(this));
    }
    static async fromTransport(transport) {
        return new ScriptingHost(transport);
    }
    enable() {
        this.emit(ScriptingHostEvents.systemWillEnable);
        this.apiInstances.forEach(PrivateHelpers.mountAPI);
        super.enable();
    }
    getAPIInstance(api) {
        if (typeof api === 'string') {
            if (this.apiInstances.has(api)) {
                return this.apiInstances.get(api);
            }
            if (api in registeredAPIs) {
                return this.initializeAPI(registeredAPIs[api]);
            }
            return null;
        }
        else if (typeof api === 'function') {
            const apiName = getAPIName(api);
            if (apiName !== null) {
                if (this.apiInstances.has(apiName)) {
                    return this.apiInstances.get(apiName);
                }
                return this.initializeAPI(api);
            }
        }
        throw Object.assign(new Error('Cannot get instance of the specified component'), { api });
    }
    unmount() {
        if (this.unmounted)
            return;
        this.notify('SIGKILL');
        this.emit(ScriptingHostEvents.systemWillUnmount);
        try {
            this.apiInstances.forEach(PrivateHelpers.unmountAPI);
            this.apiInstances.clear();
        }
        catch (e) {
            this.emit('error', e);
        }
        this.transport.close();
        this.emit(ScriptingHostEvents.systemDidUnmount);
        this.unmounted = true;
    }
    initializeAPI(ctor) {
        const apiName = getAPIName(ctor);
        if (apiName === null) {
            throw new Error('The plugin is not registered');
        }
        if (this.apiInstances.has(apiName)) {
            return this.apiInstances.get(apiName);
        }
        const apiOptions = {
            apiName,
            on: (event, handler) => this.on(`${apiName}.${event}`, handler),
            notify: (event, params) => this.notify(`${apiName}.${event}`, params),
            expose: (event, handler) => this.expose(`${apiName}.${event}`, handler),
            getAPIInstance: (name) => {
                return this.getAPIInstance(name);
            },
            system: this
        };
        const instance = ctor.factory ? ctor.factory(ctor, apiOptions) : new ctor(apiOptions);
        this.apiInstances.set(apiName, instance);
        if (this.isEnabled) {
            PrivateHelpers.mountAPI(instance);
        }
        return instance;
    }
    async RPCLoadAPIs(apiNames) {
        if (typeof apiNames !== 'object' || !(apiNames instanceof Array)) {
            throw new TypeError('RPCLoadComponents(names) name must be an array of strings');
        }
        const notFound = apiNames
            .map(name => ({ api: this.getAPIInstance(name), name }))
            .filter($ => $.api === null)
            .map($ => $.name);
        if (notFound.length) {
            const message = `Components not found ${notFound.join(',')}`;
            throw new TypeError(message);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2NyaXB0aW5nSG9zdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ob3N0L1NjcmlwdGluZ0hvc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sd0JBQXdCLENBQUE7QUFHN0QsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDJCQUEyQixDQUFBO0FBS3hELE1BQU0sU0FBUyxHQUFHLE9BQU8sTUFBTSxLQUFLLFVBQVUsSUFBSSxNQUFNLENBQUMsR0FBRyxDQUFBO0FBRTVELE1BQU0sYUFBYSxHQUFRLFNBQVMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUE7QUFFcEUsTUFBTSxjQUFjLEdBQThCLEVBQUUsQ0FBQTtBQUVwRCxJQUFVLGNBQWMsQ0F1Q3ZCO0FBdkNELFdBQVUsY0FBYztJQUN0QixTQUFnQixZQUFZLENBQUMsT0FBZSxFQUFFLEdBQWtCO1FBQzlELE1BQU0sT0FBTyxHQUFHLFlBQVksQ0FBQyxHQUFHLEVBQUUsYUFBYSxDQUFDLENBQUE7UUFDaEQsSUFBSSxPQUFPLEVBQUU7WUFDWCxNQUFNLElBQUksS0FBSyxDQUFDLDBEQUEwRCxDQUFDLENBQUE7U0FDNUU7UUFFRCxJQUFJLE9BQU8sSUFBSSxjQUFjLEVBQUU7WUFDN0IsTUFBTSxJQUFJLEtBQUssQ0FBQyxXQUFXLE9BQU8sd0JBQXdCLENBQUMsQ0FBQTtTQUM1RDtRQUVELElBQUksT0FBUSxHQUFXLEtBQUssVUFBVSxFQUFFO1lBQ3RDLE1BQU0sSUFBSSxLQUFLLENBQUMsV0FBVyxPQUFPLGtDQUFrQyxPQUFPLEdBQUcsRUFBRSxDQUFDLENBQUE7U0FDbEY7UUFJRCxDQUFDO1FBQUMsR0FBVyxDQUFDLGFBQWEsQ0FBQyxHQUFHLE9BQU8sQ0FBQTtRQUV0QyxjQUFjLENBQUMsT0FBTyxDQUFDLEdBQUcsR0FBRyxDQUFBO0lBQy9CLENBQUM7SUFu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UUFFckYsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFBO1FBRXhDLElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNsQixjQUFjLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFBO1NBQ2xDO1FBRUQsT0FBTyxRQUFRLENBQUE7SUFDakIsQ0FBQztJQUtPLEtBQUssQ0FBQyxXQUFXLENBQUMsUUFBa0I7UUFFMUMsSUFBSSxPQUFPLFFBQVEsS0FBSyxRQUFRLElBQUksQ0FBQyxDQUFDLFFBQVEsWUFBWSxLQUFLLENBQUMsRUFBRTtZQUNoRSxNQUFNLElBQUksU0FBUyxDQUFDLDJEQUEyRCxDQUFDLENBQUE7U0FDakY7UUFFRCxNQUFNLFFBQVEsR0FBRyxRQUFRO2FBQ3RCLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO2FBQ3ZELE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssSUFBSSxDQUFDO2FBQzNCLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUVuQixJQUFJLFFBQVEsQ0FBQyxNQUFNLEVBQUU7WUFDbkIsTUFBTSxPQUFPLEdBQUcsd0JBQXdCLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQTtZQUM1RCxNQUFNLElBQUksU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFBO1NBQzdCO0lBQ0gsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGljdGlvbmFyeSB9IGZyb20gJy4uL2NvbW1vbi9jb3JlL0V2ZW50RGlzcGF0Y2hlcidcbmltcG9ydCB7IFRyYW5zcG9ydEJhc2VkU2VydmVyIH0gZnJvbSAnLi9UcmFuc3BvcnRCYXNlZFNlcnZlcidcbmltcG9ydCB7IEFQSUNsYXNzLCBBUEksIEFQSU9wdGlvbnMgfSBmcm9tICcuL0FQSSdcbmltcG9ydCB7IFNjcmlwdGluZ1RyYW5zcG9ydCB9IGZyb20gJy4uL2NvbW1vbi9qc29uLXJwYy90eXBlcydcbmltcG9ydCB7IGhhc093blN5bWJvbCB9IGZyb20gJy4uL2NvbW1vbi9jb3JlL1N5bWJvbFNoaW0nXG5cbi8vIElmIHRoZXJlIGlzIG5vIG5hdGl2ZSBTeW1ib2xcbi8vIG5vciBwb2x5ZmlsbCwgdGhlbiBhIHBsYWluIG51bWJlciBpcyB1c2VkIGZvciBwZXJmb3JtYW5jZS5cbi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZVxuY29uc3QgaGFzU3ltYm9sID0gdHlwZW9mIFN5bWJvbCA9PT0gJ2Z1bmN0aW9uJyAmJiBTeW1ib2wuZm9yXG5cbmNvbnN0IGFwaU5hbWVTeW1ib2w6IGFueSA9IGhhc1N5bWJvbCA/IFN5bWJvbCgncGx1Z2luTmFtZScpIDogMHhmZWEyXG5cbmNvbnN0IHJlZ2lzdGVyZWRBUElzOiBEaWN0aW9uYXJ5PEFQSUNsYXNzPEFQST4+ID0ge31cblxubmFtZXNwYWNlIFByaXZhdGVIZWxwZXJzIHtcbiAgZXhwb3J0IGZ1bmN0aW9uIF9yZWdpc3RlckFQSShhcGlOYW1lOiBzdHJpbmcsIGFwaTogQVBJQ2xhc3M8QVBJPikge1xuICAgIGNvbnN0IGhhc05hbWUgPSBoYXNPd25TeW1ib2woYXBpLCBhcGlOYW1lU3ltYm9sKVxuICAgIGlmIChoYXNOYW1lKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBBUEkgeW91IGFyZSB0cnlpbmcgdG8gcmVnaXN0ZXIgaXMgYWxyZWFkeSByZWdpc3RlcmVkYClcbiAgICB9XG5cbiAgICBpZiAoYXBpTmFtZSBpbiByZWdpc3RlcmVkQVBJcykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgQVBJICR7YXBpTmFtZX0gaXMgYWxyZWFkeSByZWdpc3RlcmVkYClcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIChhcGkgYXMgYW55KSAhPT0gJ2Z1bmN0aW9uJykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgQVBJICR7YXBpTmFtZX0gaXMgbm90IGEgY2xhc3MsIGl0IGlzIG9mIHR5cGUgJHt0eXBlb2YgYXBpfWApXG4gICAgfVxuXG4gICAgLy8gc2F2ZSB0aGUgcmVnaXN0ZXJlZCBuYW1lXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnNlbWljb2xvblxuICAgIDsoYXBpIGFzIGFueSlbYXBpTmFtZVN5bWJvbF0gPSBhcGlOYW1lXG5cbiAgICByZWdpc3RlcmVkQVBJc1thcGlOYW1lXSA9IGFwaVxuICB9XG5cbiAgZXhwb3J0IGZ1bmN0aW9uIHVubW91bnRBUEkoYXBpOiBBUEkpIHtcbiAgICBpZiAoYXBpLmFwaVdpbGxVbm1vdW50KSB7XG4gICAgICBjb25zdCBwcm9taXNlID0gYXBpLmFwaVdpbGxVbm1vdW50KClcbiAgICAgIGlmIChwcm9taXNlICYmICdjYXRjaCcgaW4gcHJvbWlzZSkge1xuICAgICAgICBwcm9taXNlLmNhdGNoKGVycm9yID0+IGNvbnNvbGUuZXJyb3IoJ0Vycm9yIHVubW91bnRpbmcgQVBJJywgeyBhcGksIGVycm9yIH0pKVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGV4cG9ydCBmdW5jdGlvbiBtb3VudEFQSShhcGk6IEFQSSkge1xuICAgIGlmIChhcGkuYXBpRGlkTW91bnQpIHtcbiAgICAgIGNvbnN0IHByb21pc2UgPSBhcGkuYXBpRGlkTW91bnQoKVxuICAgICAgaWYgKHByb21pc2UgJiYgJ2NhdGNoJyBpbiBwcm9taXNlKSB7XG4gICAgICAgIHByb21pc2UuY2F0Y2goZXJyb3IgPT4gY29uc29sZS5lcnJvcignRXJyb3IgbW91bnRpbmcgQVBJJywgeyBhcGksIGVycm9yIH0pKVxuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG4vLyBIRVJFIFdFIFNUQVJUIFRIRSBFWFBPUlRTXG5cbmV4cG9ydCBlbnVtIFNjcmlwdGluZ0hvc3RFdmVudHMge1xuICBzeXN0ZW1XaWxsVW5tb3VudCA9ICdzeXN0ZW1XaWxsVW5tb3VudCcsXG4gIHN5c3RlbVdpbGxFbmFibGUgPSAnc3lzdGVtV2lsbEVuYWJsZScsXG4gIHN5c3RlbURpZFVubW91bnQgPSAnc3lzdGVtRGlkVW5tb3VudCdcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldEFQSU5hbWUoa2xhc3M6IEFQSUNsYXNzPEFQST4pOiBzdHJpbmcgfCBudWxsIHtcbiAgcmV0dXJuIChrbGFzcyBhcyBhbnkpW2FwaU5hbWVTeW1ib2xdIHx8IGtsYXNzLm5hbWUgfHwgbnVsbFxufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVnaXN0ZXJBUEkoYXBpTmFtZTogc3RyaW5nKTogKGtsYXNzOiBBUElDbGFzczxBUEk+KSA9PiB2b2lkIHtcbiAgcmV0dXJuIGZ1bmN0aW9uKGFwaTogQVBJQ2xhc3M8QVBJPikge1xuICAgIFByaXZhdGVIZWxwZXJzLl9yZWdpc3RlckFQSShhcGlOYW1lLCBhcGkpXG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFNjcmlwdGluZ0hvc3QgZXh0ZW5kcyBUcmFuc3BvcnRCYXNlZFNlcnZlciB7XG4gIHVubW91bnRlZCA9IGZhbHNlXG5cbiAgYXBpSW5zdGFuY2VzOiBNYXA8c3RyaW5nLCBBUEk+ID0gbmV3IE1hcCgpXG5cbiAgcHJpdmF0ZSBjb25zdHJ1Y3Rvcih3b3JrZXI6IFNjcmlwdGluZ1RyYW5zcG9ydCkge1xuICAgIHN1cGVyKHdvcmtlcilcblxuICAgIHRoaXMuZXhwb3NlKCdMb2FkQ29tcG9uZW50cycsIHRoaXMuUlBDTG9hZEFQSXMuYmluZCh0aGlzKSlcbiAgfVxuXG4gIHN0YXRpYyBhc3luYyBmcm9tVHJhbnNwb3J0KHRyYW5zcG9ydDogU2NyaXB0aW5nVHJhbnNwb3J0KSB7XG4gICAgcmV0dXJuIG5ldyBTY3JpcHRpbmdIb3N0KHRyYW5zcG9ydClcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGlzIG1ldGhkb2Qgc2hvdWxkIGJlIGNhbGxlZCBvbmx5IGZyb20gdGhlIGludGVyZmFjZSB0aGF0IG1hbmFnZXMgdGhlIFNjcmlwdGluZ0hvc3RzLlxuICAgKiBJdCBpbml0aWFsaXplcyB0aGUgc3lzdGVtIGFuZCBpdCdzIHF1ZXVlZCBjb21wb25lbnRzLiBJdCBhbHNvIHNlbmRzIGEgZmlyc3Qgbm90aWZpY2F0aW9uXG4gICAqIHRvIHRoZSBpbXBsZW1lbnRhdGlvbiBvZiB0aGUgc3lzdGVtIHRlbGxpbmcgaXQgaXMgbm93IGVuYWJsZWQuIEluIHRoYXQgbW9tZW50LCB0aGVcbiAgICogaW1wbGVtZW50YXRpb24gd2lsbCBzZW5kIHRoZSBxdWV1ZWQgbWVzc2FnZXMgYW5kIGV4ZWN1dGUgdGhlIHF1ZXVlZCBtZXRob2RzIGFnYWluc3QgdGhlXG4gICAqIG1hdGVyaWFsaXplZCBjb21wb25lbnRzLlxuICAgKlxuICAgKiBJdDpcbiAgICogIDEpIGVtaXRzIGEgQ29tcG9uZW50U3lzdGVtRXZlbnRzLnN5c3RlbVdpbGxFbmFibGUgZXZlbnRcbiAgICogIDIpIG1vdW50cyBhbGwgdGhlIGNvbXBvbmVudHNcbiAgICogIDMpIHNlbmRzIHRoZSBub3RpZmljYXRpb24gdG8gdGhlIGFjdHVhbCBzeXN0ZW0gaW1wbGVtZW50YXRpb25cbiAgICovXG4gIGVuYWJsZSgpIHtcbiAgICB0aGlzLmVtaXQoU2NyaXB0aW5nSG9zdEV2ZW50cy5zeXN0ZW1XaWxsRW5hYmxlKVxuICAgIHRoaXMuYXBpSW5zdGFuY2VzLmZvckVhY2goUHJpdmF0ZUhlbHBlcnMubW91bnRBUEkpXG4gICAgc3VwZXIuZW5hYmxlKClcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGlzIGlzIGEgc2VydmljZSBsb2NhdG9yLCBpdCBsb2NhdGVzIG9yIGluc3RhbnRpYXRlIHRoZSByZXF1ZXN0ZWQgY29tcG9uZW50XG4gICAqIGZvciB0aGlzIGluc3RhbmNlIG9mIENvbXBvbmVudFN5c3RlbS5cbiAgICpcbiAgICogQHBhcmFtIGFwaSBBIGNsYXNzIGNvbnN0cnVjdG9yXG4gICAqL1xuICBnZXRBUElJbnN0YW5jZTxYPihhcGk6IHsgbmV3IChvcHRpb25zOiBBUElPcHRpb25zKTogWCB9KTogWFxuXG4gIC8qKlxuICAgKiBUaGlzIGlzIGEgc2VydmljZSBsb2NhdG9yLCBpdCBsb2NhdGVzIG9yIGluc3RhbnRpYXRlIHRoZSByZXF1ZXN0ZWQgY29tcG9uZW50XG4gICAqIGZvciB0aGlzIGluc3RhbmNlIG9mIENvbXBvbmVudFN5c3RlbS5cbiAgICpcbiAgICogQHBhcmFtIG5hbWUgVGhlIG5hbWUgb2YgdXNlZCB0byByZWdpc3RlciB0aGUgY29tcG9uZW50XG4gICAqL1xuICBnZXRBUElJbnN0YW5jZShuYW1lOiBzdHJpbmcpOiBBUEkgfCBudWxsXG5cbiAgZ2V0QVBJSW5zdGFuY2UoYXBpOiBhbnkpIHtcbiAgICBpZiAodHlwZW9mIGFwaSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIGlmICh0aGlzLmFwaUluc3RhbmNlcy5oYXMoYXBpKSkge1xuICAgICAgICByZXR1cm4gdGhpcy5hcGlJbnN0YW5jZXMuZ2V0KGFwaSlcbiAgICAgIH1cbiAgICAgIGlmIChhcGkgaW4gcmVnaXN0ZXJlZEFQSXMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaW5pdGlhbGl6ZUFQSShyZWdpc3RlcmVkQVBJc1thcGldKVxuICAgICAgfVxuICAgICAgcmV0dXJuIG51bGxcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBhcGkgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIGNvbnN0IGFwaU5hbWUgPSBnZXRBUElOYW1lKGFwaSlcblxuICAgICAgLy8gaWYgaXQgaGFzIGEgbmFtZSwgdXNlIHRoYXQgaW5kaXJlY3Rpb24gdG8gZmluZCBpbiB0aGUgaW5zdGFuY2UncyBtYXBcbiAgICAgIGlmIChhcGlOYW1lICE9PSBudWxsKSB7XG4gICAgICAgIGlmICh0aGlzLmFwaUluc3RhbmNlcy5oYXMoYXBpTmFtZSkpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5hcGlJbnN0YW5jZXMuZ2V0KGFwaU5hbWUpXG4gICAgICAgIH1cblxuICAgICAgICAvLyBJZiB3ZSBkb24ndCBoYXZlIGEgbG9jYWwgaW5zdGFuY2UsIGNyZWF0ZSB0aGUgaW5zdGFuY2Ugb2YgdGhlIGNvbXBvbmVudFxuICAgICAgICByZXR1cm4gdGhpcy5pbml0aWFsaXplQVBJKGFwaSlcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aHJvdyBPYmplY3QuYXNzaWduKG5ldyBFcnJvcignQ2Fubm90IGdldCBpbnN0YW5jZSBvZiB0aGUgc3BlY2lmaWVkIGNvbXBvbmVudCcpLCB7IGFwaSB9KVxuICB9XG5cbiAgLyoqXG4gICAqIFRoaXMgbWV0aG9kIHVubW91bnRzIGFsbCB0aGUgY29tcG9uZW50cyBhbmQgcmVsZWFzZXMgdGhlIFdvcmtlclxuICAgKi9cbiAgdW5tb3VudCgpIHtcbiAgICBpZiAodGhpcy51bm1vdW50ZWQpIHJldHVyblxuICAgIHRoaXMubm90aWZ5KCdTSUdLSUxMJylcblxuICAgIHRoaXMuZW1pdChTY3JpcHRpbmdIb3N0RXZlbnRzLnN5c3RlbVdpbGxVbm1vdW50KVxuXG4gICAgdHJ5IHtcbiAgICAgIHRoaXMuYXBpSW5zdGFuY2VzLmZvckVhY2goUHJpdmF0ZUhlbHBlcnMudW5tb3VudEFQSSlcbiAgICAgIHRoaXMuYXBpSW5zdGFuY2VzLmNsZWFyKClcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aGlzLmVtaXQoJ2Vycm9yJywgZSlcbiAgICB9XG5cbiAgICB0aGlzLnRyYW5zcG9ydC5jbG9zZSgpXG5cbiAgICB0aGlzLmVtaXQoU2NyaXB0aW5nSG9zdEV2ZW50cy5zeXN0ZW1EaWRVbm1vdW50KVxuXG4gICAgdGhpcy51bm1vdW50ZWQgPSB0cnVlXG4gIH1cblxuICBwcm90ZWN0ZWQgaW5pdGlhbGl6ZUFQSTxYIGV4dGVuZHMgQVBJPihjdG9yOiB7XG4gICAgbmV3IChvcHRpb25zOiBBUElPcHRpb25zKTogWFxuICAgIGZhY3Rvcnk/KGN0b3I6IHsgbmV3IChvcHRpb25zOiBBUElPcHRpb25zKTogWCB9LCBvcHRpb25zOiBBUElPcHRpb25zKTogWFxuICB9KTogWCB7XG4gICAgY29uc3QgYXBpTmFtZSA9IGdldEFQSU5hbWUoY3RvcilcblxuICAgIGlmIChhcGlOYW1lID09PSBudWxsKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBwbHVnaW4gaXMgbm90IHJlZ2lzdGVyZWQnKVxuICAgIH1cblxuICAgIGlmICh0aGlzLmFwaUluc3RhbmNlcy5oYXMoYXBpTmFtZSkpIHtcbiAgICAgIHJldHVybiB0aGlzLmFwaUluc3RhbmNlcy5nZXQoYXBpTmFtZSkgYXMgWFxuICAgIH1cblxuICAgIGNvbnN0IGFwaU9wdGlvbnM6IEFQSU9wdGlvbnMgPSB7XG4gICAgICBhcGlOYW1lLFxuICAgICAgb246IChldmVudCwgaGFuZGxlcikgPT4gdGhpcy5vbihgJHthcGlOYW1lfS4ke2V2ZW50fWAsIGhhbmRsZXIpLFxuICAgICAgbm90aWZ5OiAoZXZlbnQsIHBhcmFtcz8pID0+IHRoaXMubm90aWZ5KGAke2FwaU5hbWV9LiR7ZXZlbnR9YCwgcGFyYW1zKSxcbiAgICAgIGV4cG9zZTogKGV2ZW50LCBoYW5kbGVyKSA9PiB0aGlzLmV4cG9zZShgJHthcGlOYW1lfS4ke2V2ZW50fWAsIGhhbmRsZXIpLFxuICAgICAgZ2V0QVBJSW5zdGFuY2U6IChuYW1lOiBhbnkpID0+IHtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lXG4gICAgICAgIHJldHVybiB0aGlzLmdldEFQSUluc3RhbmNlKG5hbWUpIGFzIGFueVxuICAgICAgfSxcbiAgICAgIHN5c3RlbTogdGhpc1xuICAgIH1cblxuICAgIGNvbnN0IGluc3RhbmNlID0gY3Rvci5mYWN0b3J5ID8gY3Rvci5mYWN0b3J5KGN0b3IsIGFwaU9wdGlvbnMpIDogbmV3IGN0b3IoYXBpT3B0aW9ucylcblxuICAgIHRoaXMuYXBpSW5zdGFuY2VzLnNldChhcGlOYW1lLCBpbnN0YW5jZSlcblxuICAgIGlmICh0aGlzLmlzRW5hYmxlZCkge1xuICAgICAgUHJpdmF0ZUhlbHBlcnMubW91bnRBUEkoaW5zdGFuY2UpXG4gICAgfVxuXG4gICAgcmV0dXJuIGluc3RhbmNlXG4gIH1cblxuICAvKipcbiAgICogUHJlbG9hZHMgYSBsaXN0IG9mIGNvbXBvbmVudHNcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgUlBDTG9hZEFQSXMoYXBpTmFtZXM6IHN0cmluZ1tdKSB7XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lXG4gICAgaWYgKHR5cGVvZiBhcGlOYW1lcyAhPT0gJ29iamVjdCcgfHwgIShhcGlOYW1lcyBpbnN0YW5jZW9mIEFycmF5KSkge1xuICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignUlBDTG9hZENvbXBvbmVudHMobmFtZXMpIG5hbWUgbXVzdCBiZSBhbiBhcnJheSBvZiBzdHJpbmdzJylcbiAgICB9XG5cbiAgICBjb25zdCBub3RGb3VuZCA9IGFwaU5hbWVzXG4gICAgICAubWFwKG5hbWUgPT4gKHsgYXBpOiB0aGlzLmdldEFQSUluc3RhbmNlKG5hbWUpLCBuYW1lIH0pKVxuICAgICAgLmZpbHRlcigkID0+ICQuYXBpID09PSBudWxsKVxuICAgICAgLm1hcCgkID0+ICQubmFtZSlcblxuICAgIGlmIChub3RGb3VuZC5sZW5ndGgpIHtcbiAgICAgIGNvbnN0IG1lc3NhZ2UgPSBgQ29tcG9uZW50cyBub3QgZm91bmQgJHtub3RGb3VuZC5qb2luKCcsJyl9YFxuICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihtZXNzYWdlKVxuICAgIH1cbiAgfVxufVxuIl19