import { Client } from '../common/json-rpc/Client';
import { getApi } from '../common/json-rpc/API';
import { isPromiseLike } from '../common/core/isPromiseLike';
import { hasOwnSymbol } from '../common/core/SymbolShim';
const loadAPIsNotificationName = 'LoadComponents';
const hasSymbol = typeof Symbol === 'function' && Symbol.for;
const injectedAPISymbol = hasSymbol ? Symbol('injectedAPIs') : 0xfea0;
export function inject(apiName) {
    if (apiName !== undefined && !apiName) {
        throw new TypeError('API name cannot be null / empty');
    }
    return function (target, propertyKey) {
        if (typeof propertyKey === 'string') {
            getInjectableMap(target).set(propertyKey, apiName || propertyKey);
        }
        else
            throw new TypeError('Cannot inject APIs with non-string names');
    };
}
export function getInjectedAPIs(instance) {
    const result = new Map();
    let currentPrototype = Object.getPrototypeOf(instance);
    while (!!currentPrototype) {
        if (hasOwnSymbol(currentPrototype, injectedAPISymbol)) {
            const currentList = currentPrototype[injectedAPISymbol];
            currentList.forEach((v, k) => result.set(k, v));
        }
        currentPrototype = Object.getPrototypeOf(currentPrototype);
    }
    return result;
}
function getInjectableMap(target) {
    const anyTarget = target;
    if (!hasOwnSymbol(target, injectedAPISymbol)) {
        anyTarget[injectedAPISymbol] = new Map();
    }
    return anyTarget[injectedAPISymbol];
}
async function _injectAPIs(target) {
    let injectedMap = getInjectedAPIs(target);
    if (injectedMap.size === 0)
        return;
    await target.loadAPIs(Array.from(injectedMap.values()));
    injectedMap.forEach(function (apiName, property) {
        target[property] = target.loadedAPIs[apiName];
    });
}
class Script extends Client {
    constructor(transport, opt) {
        super(opt);
        this.transport = transport;
        this.loadedAPIs = {};
        this.started = false;
        if (transport.onError) {
            transport.onError(e => {
                this.emit('error', e);
            });
        }
        if (transport.onClose) {
            transport.onClose(() => {
                this.emit('transportClosed');
            });
        }
        transport.onMessage(message => {
            this.processMessage(message);
        });
        if (transport.onConnect) {
            transport.onConnect(() => {
                this.didConnect();
            });
        }
        else {
            this.didConnect();
        }
    }
    sendMessage(message) {
        this.transport.sendMessage(message);
    }
    async loadAPIs(apiName) {
        const loadedKeys = Object.keys(this.loadedAPIs);
        const keysToRequest = apiName.filter(function ($) {
            return !loadedKeys.includes($);
        });
        if (keysToRequest.length) {
            await this.call(loadAPIsNotificationName, [keysToRequest]);
            keysToRequest.forEach(async (apiName) => {
                this.loadedAPIs[apiName] = getApi(this, apiName);
            });
        }
        return this.loadedAPIs;
    }
    didConnect() {
        const injection = _injectAPIs(this);
        super.didConnect();
        injection
            .then(() => {
            if (this.systemDidEnable && !this.started) {
                this.started = true;
                try {
                    const r = this.systemDidEnable();
                    if (r && isPromiseLike(r)) {
                        r.catch(e => this.emit('error', e));
                    }
                }
                catch (e) {
                    this.emit('error', e);
                }
            }
        })
            .catch(e => this.emit('error', e));
    }
}
Script.inject = inject;
export { Script };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2NyaXB0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2NsaWVudC9TY3JpcHQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLDJCQUEyQixDQUFBO0FBQ2xELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQTtBQUUvQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sOEJBQThCLENBQUE7QUFDNUQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDJCQUEyQixDQUFBO0FBR3hELE1BQU0sd0JBQXdCLEdBQUcsZ0JBQWdCLENBQUE7QUFNakQsTUFBTSxTQUFTLEdBQUcsT0FBTyxNQUFNLEtBQUssVUFBVSxJQUFJLE1BQU0sQ0FBQyxHQUFHLENBQUE7QUFFNUQsTUFBTSxpQkFBaUIsR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFBO0FBWXJFLE1BQU0sVUFBVSxNQUFNLENBQUMsT0FBZ0I7SUFDckMsSUFBSSxPQUFPLEtBQUssU0FBUyxJQUFJLENBQUMsT0FBTyxFQUFFO1FBQ3JDLE1BQU0sSUFBSSxTQUFTLENBQUMsaUNBQWlDLENBQUMsQ0FBQTtLQUN2RDtJQUNELE9BQU8sVUFBMkIsTUFBUyxFQUFFLFdBQW9CO1FBQy9ELElBQUksT0FBTyxXQUFXLEtBQUssUUFBUSxFQUFFO1lBQ25DLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsT0FBTyxJQUFJLFdBQVcsQ0FBQyxDQUFBO1NBQ2xFOztZQUFNLE1BQU0sSUFBSSxTQUFTLENBQUMsMENBQTBDLENBQUMsQ0FBQTtJQUN4RSxDQUFDLENBQUE7QUFDSCxDQUFDO0FBTUQsTUFBTSxVQUFVLGVBQWUsQ0FBbUIsUUFBVztJQUMzRCxNQUFNLE1BQU0sR0FBRyxJQUFJLEdBQUcsRUFBbUIsQ0FBQTtJQUN6QyxJ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cUJBQ3BDO2lCQUNGO2dCQUFDLE9BQU8sQ0FBQyxFQUFFO29CQUNWLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFBO2lCQUN0QjthQUNGO1FBQ0gsQ0FBQyxDQUFDO2FBQ0QsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQTtJQUN0QyxDQUFDOztBQXBGTSxhQUFNLEdBQUcsTUFBTSxDQUFBO0FBdUZ4QixPQUFPLEVBQUUsTUFBTSxFQUFFLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDbGllbnQgfSBmcm9tICcuLi9jb21tb24vanNvbi1ycGMvQ2xpZW50J1xuaW1wb3J0IHsgZ2V0QXBpIH0gZnJvbSAnLi4vY29tbW9uL2pzb24tcnBjL0FQSSdcbmltcG9ydCB7IElMb2dPcHRzLCBTY3JpcHRpbmdUcmFuc3BvcnQgfSBmcm9tICcuLi9jb21tb24vanNvbi1ycGMvdHlwZXMnXG5pbXBvcnQgeyBpc1Byb21pc2VMaWtlIH0gZnJvbSAnLi4vY29tbW9uL2NvcmUvaXNQcm9taXNlTGlrZSdcbmltcG9ydCB7IGhhc093blN5bWJvbCB9IGZyb20gJy4uL2NvbW1vbi9jb3JlL1N5bWJvbFNoaW0nXG5cbi8qKiB0aGlzIGlzIGRlZmluZWQgaW4gdGhlIGNvbnN0cnVjdG9yIFNjcmlwdGluZ0hvc3QoKSAqL1xuY29uc3QgbG9hZEFQSXNOb3RpZmljYXRpb25OYW1lID0gJ0xvYWRDb21wb25lbnRzJ1xuXG4vLyBJZiB0aGVyZSBpcyBubyBuYXRpdmUgU3ltYm9sXG4vLyBub3IgcG9seWZpbGwsIHRoZW4gYSBwbGFpbiBudW1iZXIgaXMgdXNlZCBmb3IgcGVyZm9ybWFuY2UuXG5cbi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZVxuY29uc3QgaGFzU3ltYm9sID0gdHlwZW9mIFN5bWJvbCA9PT0gJ2Z1bmN0aW9uJyAmJiBTeW1ib2wuZm9yXG5cbmNvbnN0IGluamVjdGVkQVBJU3ltYm9sID0gaGFzU3ltYm9sID8gU3ltYm9sKCdpbmplY3RlZEFQSXMnKSA6IDB4ZmVhMFxuXG5pbnRlcmZhY2UgU2NyaXB0IHtcbiAgc3lzdGVtRGlkRW5hYmxlPygpOiBQcm9taXNlPHZvaWQ+IHwgdm9pZFxufVxuXG5leHBvcnQgdHlwZSBBUEkgPSBhbnlcblxuLyoqXG4gKiBUaGlzIGZ1bmN0aW9uIGRlY29yYXRlcyBwYXJhbWV0ZXJzIHRvIGxvYWQgQVBJc1xuICogQHBhcmFtIGFwaU5hbWUgbmFtZSBvZiB0aGUgQVBJIHRvIGxvYWRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGluamVjdChhcGlOYW1lPzogc3RyaW5nKSB7XG4gIGlmIChhcGlOYW1lICE9PSB1bmRlZmluZWQgJiYgIWFwaU5hbWUpIHtcbiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdBUEkgbmFtZSBjYW5ub3QgYmUgbnVsbCAvIGVtcHR5JylcbiAgfVxuICByZXR1cm4gZnVuY3Rpb248VCBleHRlbmRzIFNjcmlwdD4odGFyZ2V0OiBULCBwcm9wZXJ0eUtleToga2V5b2YgVCkge1xuICAgIGlmICh0eXBlb2YgcHJvcGVydHlLZXkgPT09ICdzdHJpbmcnKSB7XG4gICAgICBnZXRJbmplY3RhYmxlTWFwKHRhcmdldCkuc2V0KHByb3BlcnR5S2V5LCBhcGlOYW1lIHx8IHByb3BlcnR5S2V5KVxuICAgIH0gZWxzZSB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgaW5qZWN0IEFQSXMgd2l0aCBub24tc3RyaW5nIG5hbWVzJylcbiAgfVxufVxuXG4vKipcbiAqIEdldHMgYWxsIHRoZSBpbmplY3RlZCBBUElzIG9mIGEgc2NyaXB0XG4gKiBAcGFyYW0gaW5zdGFuY2UgQSBzY3JpcHQgdG8gZ2V0IHRoZSBBUElzXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRJbmplY3RlZEFQSXM8VCBleHRlbmRzIFNjcmlwdD4oaW5zdGFuY2U6IFQpOiBNYXA8a2V5b2YgVCwgc3RyaW5nPiB7XG4gIGNvbnN0IHJlc3VsdCA9IG5ldyBNYXA8a2V5b2YgVCwgc3RyaW5nPigpXG4gIGxldCBjdXJyZW50UHJvdG90eXBlID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKGluc3RhbmNlKVxuXG4gIHdoaWxlICghIWN1cnJlbnRQcm90b3R5cGUpIHtcbiAgICBpZiAoaGFzT3duU3ltYm9sKGN1cnJlbnRQcm90b3R5cGUsIGluamVjdGVkQVBJU3ltYm9sKSkge1xuICAgICAgY29uc3QgY3VycmVudExpc3Q6IE1hcDxrZXlvZiBULCBzdHJpbmc+ID0gY3VycmVudFByb3RvdHlwZVtpbmplY3RlZEFQSVN5bWJvbF1cbiAgICAgIGN1cnJlbnRMaXN0LmZvckVhY2goKHYsIGspID0+IHJlc3VsdC5zZXQoaywgdikpXG4gICAgfVxuICAgIGN1cnJlbnRQcm90b3R5cGUgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YoY3VycmVudFByb3RvdHlwZSlcbiAgfVxuXG4gIHJldHVybiByZXN1bHRcbn1cblxuZnVuY3Rpb24gZ2V0SW5qZWN0YWJsZU1hcCh0YXJnZXQ6IFNjcmlwdCk6IE1hcDxhbnksIHN0cmluZz4ge1xuICBjb25zdCBhbnlUYXJnZXQ6IGFueSA9IHRhcmdldFxuXG4gIGlmICghaGFzT3duU3ltYm9sKHRhcmdldCwgaW5qZWN0ZWRBUElTeW1ib2wpKSB7XG4gICAgYW55VGFyZ2V0W2luamVjdGVkQVBJU3ltYm9sXSA9IG5ldyBNYXAoKVxuICB9XG5cbiAgcmV0dXJuIGFueVRhcmdldFtpbmplY3RlZEFQSVN5bWJvbF1cbn1cblxuYXN5bmMgZnVuY3Rpb24gX2luamVjdEFQSXModGFyZ2V0OiBTY3JpcHQpIHtcbiAgbGV0IGluamVjdGVkTWFwOiBNYXA8a2V5b2YgU2NyaXB0LCBzdHJpbmc+ID0gZ2V0SW5qZWN0ZWRBUElzKHRhcmdldClcblxuICBpZiAoaW5qZWN0ZWRNYXAuc2l6ZSA9PT0gMCkgcmV0dXJuXG5cbiAgYXdhaXQgdGFyZ2V0LmxvYWRBUElzKEFycmF5LmZyb20oaW5qZWN0ZWRNYXAudmFsdWVzKCkpKVxuXG4gIGluamVjdGVkTWFwLmZvckVhY2goZnVuY3Rpb24oYXBpTmFtZTogc3RyaW5nLCBwcm9wZXJ0eSkge1xuICAgIHRhcmdldFtwcm9wZXJ0eV0gPSB0YXJnZXQubG9hZGVkQVBJc1thcGlOYW1lXVxuICB9KVxufVxuXG5jbGFzcyBTY3JpcHQgZXh0ZW5kcyBDbGllbnQge1xuICBzdGF0aWMgaW5qZWN0ID0gaW5qZWN0XG5cbiAgbG9hZGVkQVBJczogeyBba2V5OiBzdHJpbmddOiBBUEkgfSA9IHt9XG5cbiAgcHJvdGVjdGVkIHN0YXJ0ZWQgPSBmYWxzZVxuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgdHJhbnNwb3J0OiBTY3JpcHRpbmdUcmFuc3BvcnQsIG9wdD86IElMb2dPcHRzKSB7XG4gICAgc3VwZXIob3B0KVxuXG4gICAgaWYgKHRyYW5zcG9ydC5vbkVycm9yKSB7XG4gICAgICB0cmFuc3BvcnQub25FcnJvcihlID0+IHtcbiAgICAgICAgdGhpcy5lbWl0KCdlcnJvcicsIGUpXG4gICAgICB9KVxuICAgIH1cblxuICAgIGlmICh0cmFuc3BvcnQub25DbG9zZSkge1xuICAgICAgdHJhbnNwb3J0Lm9uQ2xvc2UoKCkgPT4ge1xuICAgICAgICB0aGlzLmVtaXQoJ3RyYW5zcG9ydENsb3NlZCcpXG4gICAgICB9KVxuICAgIH1cblxuICAgIHRyYW5zcG9ydC5vbk1lc3NhZ2UobWVzc2FnZSA9PiB7XG4gICAgICB0aGlzLnByb2Nlc3NNZXNzYWdlKG1lc3NhZ2UpXG4gICAgfSlcblxuICAgIGlmICh0cmFuc3BvcnQub25Db25uZWN0KSB7XG4gICAgICB0cmFuc3BvcnQub25Db25uZWN0KCgpID0+IHtcbiAgICAgICAgdGhpcy5kaWRDb25uZWN0KClcbiAgICAgIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZGlkQ29ubmVjdCgpXG4gICAgfVxuICB9XG5cbiAgc2VuZE1lc3NhZ2UobWVzc2FnZTogc3RyaW5nKSB7XG4gICAgdGhpcy50cmFuc3BvcnQuc2VuZE1lc3NhZ2UobWVzc2FnZSlcbiAgfVxuXG4gIC8qKlxuICAgKiBQcm92aWRlIGEgZ2xvYmFsIHBvaW50IG9mIGFjY2VzcyB0byBhIHNlcnZpY2Ugd2l0aG91dFxuICAgKiBjb3VwbGluZyB1c2VycyB0byB0aGUgY29uY3JldGUgY2xhc3MgdGhhdCBpbXBsZW1lbnRzIGl0LlxuICAgKlxuICAgKiBAcGFyYW0gYXBpTmFtZSBOYW1lIG9mIHRoZSBwbHVnaW4gd2UgYXJlIHRyeWluZyB0byBvYnRhaW5cbiAgICogQHJldHVybnMge29iamVjdH0gbG9hZGVkQVBJc1xuICAgKi9cbiAgYXN5bmMgbG9hZEFQSXMoYXBpTmFtZTogc3RyaW5nW10pOiBQcm9taXNlPHsgW2tleTogc3RyaW5nXTogYW55IH0+IHtcbiAgICBjb25zdCBsb2FkZWRLZXlzID0gT2JqZWN0LmtleXModGhpcy5sb2FkZWRBUElzKVxuXG4gICAgY29uc3Qga2V5c1RvUmVxdWVzdCA9IGFwaU5hbWUuZmlsdGVyKGZ1bmN0aW9uKCQpIHtcbiAgICAgIHJldHVybiAhbG9hZGVkS2V5cy5pbmNsdWRlcygkKVxuICAgIH0pXG5cbiAgICBpZiAoa2V5c1RvUmVxdWVzdC5sZW5ndGgpIHtcbiAgICAgIGF3YWl0IHRoaXMuY2FsbChsb2FkQVBJc05vdGlmaWNhdGlvbk5hbWUsIFtrZXlzVG9SZXF1ZXN0XSlcblxuICAgICAgLy8gTG9hZCAvIHJlcXVlc3QgdGhlIEFQSVxuICAgICAga2V5c1RvUmVxdWVzdC5mb3JFYWNoKGFzeW5jIGFwaU5hbWUgPT4ge1xuICAgICAgICB0aGlzLmxvYWRlZEFQSXNbYXBpTmFtZV0gPSBnZXRBcGkodGhpcywgYXBpTmFtZSlcbiAgICAgIH0pXG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMubG9hZGVkQVBJc1xuICB9XG5cbiAgcHJvdGVjdGVkIGRpZENvbm5lY3QoKSB7XG4gICAgY29uc3QgaW5qZWN0aW9uID0gX2luamVjdEFQSXModGhpcylcblxuICAgIHN1cGVyLmRpZENvbm5lY3QoKVxuXG4gICAgaW5qZWN0aW9uXG4gICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgIGlmICh0aGlzLnN5c3RlbURpZEVuYWJsZSAmJiAhdGhpcy5zdGFydGVkKSB7XG4gICAgICAgICAgdGhpcy5zdGFydGVkID0gdHJ1ZVxuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCByID0gdGhpcy5zeXN0ZW1EaWRFbmFibGUoKVxuICAgICAgICAgICAgaWYgKHIgJiYgaXNQcm9taXNlTGlrZShyKSkge1xuICAgICAgICAgICAgICByLmNhdGNoKGUgPT4gdGhpcy5lbWl0KCdlcnJvcicsIGUpKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRoaXMuZW1pdCgnZXJyb3InLCBlKVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSlcbiAgICAgIC5jYXRjaChlID0+IHRoaXMuZW1pdCgnZXJyb3InLCBlKSlcbiAgfVxufVxuXG5leHBvcnQgeyBTY3JpcHQgfVxuIl19