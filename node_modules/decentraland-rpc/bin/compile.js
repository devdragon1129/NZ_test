#!/usr/bin/env node
"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const webpack = require("webpack");
const webpack_sources_1 = require("webpack-sources");
const globPkg = require("glob");
const rimraf = require("rimraf");
const fs = require("fs");
const path_1 = require("path");
const TsconfigPathsPlugin = require('tsconfig-paths-webpack-plugin');
const child_process_1 = require("child_process");
const os_1 = require("os");
const ProgressBar = require("progress");
const chalk_1 = require("chalk");
const packageJson = JSON.parse(fs.readFileSync(require.resolve('../package.json')).toString());
const isWatching = process.argv.some($ => $ === '--watch');
const instrumentCoverage = process.argv.some($ => $ === '--coverage') || process.env.NODE_ENV === 'coverage';
const isProduction = process.env.NODE_ENV !== 'development' && !isWatching && !instrumentCoverage;
const webWorkerTransport = path_1.resolve(__dirname, '../lib/common/transports/WebWorker');
const entryPointWebWorker = (filename) => `
import { WebWorkerTransport } from ${JSON.stringify(webWorkerTransport)}
const imported = require(${JSON.stringify(filename)})

if (imported && imported.__esModule && imported['default']) {
  new imported['default'](WebWorkerTransport(self))
}
`;
console.log('decentraland-compiler version: ' + chalk_1.default.green(packageJson.version));
function findConfigFile(baseDir, configFileName) {
    let configFilePath = path_1.resolve(baseDir, configFileName);
    if (fs.existsSync(configFilePath)) {
        return configFilePath;
    }
    if (baseDir.length === path_1.dirname(baseDir).length) {
        return null;
    }
    return findConfigFile(path_1.resolve(baseDir, '../'), configFileName);
}
exports.findConfigFile = findConfigFile;
class ESModulePlugin {
    constructor(options) {
        this.options = options;
    }
    apply(compiler) {
        compiler.hooks.compilation.tap('ESModulePlugin', compilation => {
            compilation.hooks.afterOptimizeChunkAssets.tap('ESModulePlugin', chunks => {
                for (const chunk of chunks) {
                    if (!chunk.canBeInitial()) {
                        continue;
                    }
                    for (const file of chunk.files) {
                        compilation.assets[file] = new webpack_sources_1.ConcatSource(compilation.assets[file], '\n', `export default ${this.options.exportedMember};`);
                    }
                }
            });
        });
    }
}
function compile(opt) {
    return __awaiter(this, void 0, void 0, function* () {
        return new Promise((onSuccess, onError) => {
            let entry = opt.files;
            const extensions = ['.ts', '.tsx', '.js', '.json'];
            if (opt.target === 'webworker') {
                entry = entry.map($ => {
                    const file = path_1.resolve(os_1.tmpdir(), Math.random().toString() + '.WebWorker.js');
                    fs.writeFileSync(file, entryPointWebWorker($));
                    return file;
                });
            }
            entry = entry.reduce((obj, $, $$) => {
                let name = path_1.relative(opt.rootFolder, opt.files[$$]);
                extensions.forEach($ => {
                    if (name.endsWith($)) {
                        name = name.substr(0, name.length - $.length);
                    }
                });
                let target = name;
                if (target.endsWith('.js')) {
                    target = target.substr(0, target.length - 3);
                }
                obj[target] = $;
                return obj;
            }, {});
            console.log([
                `     files:`,
                ...Object.keys(entry).map(($, $$) => `            (root)/${path_1.relative(opt.rootFolder, opt.files[$$])} -> (outDir)/${$}.js`)
            ].join('\n'));
            const libraryName = opt.library || undefined;
            const plugins = [ProgressBarPlugin({})];
            let libraryTarget = 'umd';
            let target = 'web';
            if (opt.target === 'esm') {
                target = 'web';
            }
            else if (opt.target === 'this') {
                target = 'webworker';
            }
            else {
                target = opt.target;
            }
            if (opt.target === 'this') {
                libraryTarget = 'this';
            }
            else if (opt.target === 'webworker') {
                libraryTarget = 'this';
            }
            else if (opt.target === 'esm') {
                libraryTarget = 'var';
                if (libraryName) {
                    plugins.push(new ESModulePlugin({ exportedMember: libraryName }));
                }
            }
            const options = {
                entry,
                mode: isProduction ? 'production' : 'development',
                optimization: {
                    nodeEnv: isProduction ? 'production' : 'development',
                    namedModules: !isProduction,
                    minimize: isProduction
                },
                output: {
                    filename: opt.fileName,
                    path: opt.outDir,
                    libraryTarget
                },
                resolve: {
                    extensions,
                    plugins: [new TsconfigPathsPlugin({ configFile: opt.tsconfig })]
                },
                watch: isWatching,
                module: {
                    rules: [
                        {
                            test: /\.(jpe?g|png|gif|svg)$/i,
                            use: [
                                {
                                    loader: require.resolve('url-loader'),
                                    options: {
                                        limit: 512000
                                    }
                                }
                            ]
                        },
                        {
                            test: /\.tsx?$/,
                            loader: require.resolve('ts-loader'),
                            options: {
                                configFile: opt.tsconfig
                            }
                        }
                    ]
                },
                target,
                plugins
            };
            if (opt.coverage) {
                ;
                options.module.rules.push({
                    test: /\.[jt]sx?$/,
                    use: {
                        loader: 'istanbul-instrumenter-loader',
                        options: { esModules: true, sourceMaps: true }
                    },
                    enforce: 'post',
                    exclude: /node_modules|\.spec\.js$/
                });
            }
            if (libraryName) {
                options.output.library = libraryName;
            }
            if (opt.globalObject) {
                options.output.globalObject = opt.globalObject;
            }
            const compiler = webpack(options);
            if (!isWatching) {
                compiler.run((err, stats) => {
                    if (err) {
                        onError(err);
                    }
                    else {
                        onSuccess(stats);
                    }
                });
            }
            else {
                compiler.watch({ ignored: /node_modules/, aggregateTimeout: 1000 }, (err, stats) => {
                    if (stats.hasErrors() || stats.hasWarnings()) {
                        console.log(stats.toString({
                            colors: true,
                            errors: true,
                            warnings: true
                        }));
                    }
                    else {
                        console.log('OK ' + opt.outDir);
                    }
                    if (!err) {
                        onSuccess(stats);
                    }
                });
            }
        });
    });
}
exports.compile = compile;
function tsc(tsconfig) {
    return __awaiter(this, void 0, void 0, function* () {
        const tscLocation = require.resolve('typescript/lib/tsc');
        console.log(`
    Executing "tsc -p ${path_1.basename(tsconfig)}" in ${path_1.dirname(tsconfig)}
  `.trim());
        const args = [tscLocation, '-p', path_1.basename(tsconfig)];
        if (isWatching) {
            args.push('--watch');
        }
        const childProcess = child_process_1.spawn('node', args, {
            cwd: path_1.dirname(tsconfig)
        });
        if (isWatching) {
            return true;
        }
        let resolve = a => void 0;
        let reject = a => void 0;
        const semaphore = new Promise((ok, err) => {
            resolve = ok;
            reject = err;
        });
        childProcess.stdout.on('data', data => {
            console.log(`tsc stdout: ${data}`);
        });
        childProcess.stderr.on('data', data => {
            console.log(`tsc stderr: ${data}`);
        });
        childProcess.on('close', exitCode => {
            if (exitCode) {
                reject(exitCode);
            }
            else {
                resolve(exitCode);
            }
        });
        yield semaphore;
    });
}
exports.tsc = tsc;
function processFile(opt) {
    return __awaiter(this, void 0, void 0, function* () {
        const baseFiles = (opt.file && [opt.file]) || (opt.files && opt.files[0]) || [];
        if (!baseFiles.length) {
            throw new Error(`Unable to find a file to compile`);
        }
        const baseFile = baseFiles[0];
        if (baseFile.endsWith('.json')) {
            return processJson(baseFile);
        }
        const parsed = path_1.parse(baseFile);
        const configFile = findConfigFile(path_1.dirname(baseFile), 'tsconfig.json');
        if (!configFile) {
            throw new Error(`Unable to find a tsconfig.json file for ${opt.file}`);
        }
        const rootFolder = path_1.dirname(configFile);
        const parsedTsConfig = require(configFile);
        let outFile = opt.outFile
            ? path_1.resolve(process.cwd(), opt.outFile)
            : parsedTsConfig.compilerOptions.outFile
                ? path_1.resolve(path_1.dirname(configFile), parsedTsConfig.compilerOptions.outFile)
                : parsed.name + '.js';
        const outDir = parsedTsConfig.compilerOptions.outDir
            ? path_1.resolve(path_1.dirname(configFile), parsedTsConfig.compilerOptions.outDir)
            : path_1.dirname(outFile);
        if (outFile.startsWith(outDir)) {
            outFile = outFile.replace(outDir + '/', '');
        }
        const coverage = !isWatching && (opt.coverage || instrumentCoverage);
        const options = {
            files: opt.files || [opt.file],
            outDir,
            tsconfig: configFile,
            coverage: coverage,
            target: opt.target || 'web',
            rootFolder,
            fileName: opt.fileName,
            library: opt.library,
            globalObject: opt.globalObject
        };
        console.log(`
      root: ${options.rootFolder}
    outDir: ${options.outDir}
   options: { coverage: ${coverage}, production: ${isProduction}, watch: ${isWatching} }`);
        const result = yield compile(options);
        if (result.hasErrors()) {
            throw new Error(result.toString({
                assets: true,
                colors: true,
                entrypoints: true,
                env: true,
                errors: true,
                publicPath: true
            }));
        }
        if (result.hasWarnings()) {
            console.log(result.toString({
                assets: true,
                colors: true,
                entrypoints: true,
                env: true,
                errors: true,
                publicPath: true
            }));
        }
    });
}
exports.processFile = processFile;
function glob(path) {
    return __awaiter(this, void 0, void 0, function* () {
        return new Promise((onSuccess, onFailure) => {
            globPkg(path, { absolute: true }, (err, values) => {
                if (err) {
                    onFailure(err);
                }
                else {
                    onSuccess(values);
                }
            });
        });
    });
}
exports.glob = glob;
function cli(args) {
    return __awaiter(this, void 0, void 0, function* () {
        const files = yield glob(process.argv[2]);
        yield Promise.all(files.map($ => processFile({ file: $, outFile: args[3] })));
    });
}
exports.cli = cli;
function processJson(file) {
    return __awaiter(this, void 0, void 0, function* () {
        const config = require(file);
        if (!config || !(config instanceof Array)) {
            throw new Error(`Config file ${file} is not a valid sequence of steps`);
        }
        if (config.length === 0) {
            throw new Error(`Config file ${file} describes no compilation steps`);
        }
        for (let i = 0; i < config.length; i++) {
            const $ = config[i];
            if ($.kind === 'RM') {
                if (!isWatching) {
                    console.log(`
          Deleting folder: ${$.path}
        `.trim());
                    rimraf.sync($.path);
                }
            }
            else if ($.kind === 'Webpack') {
                const files = yield glob($.file);
                yield processFile(Object.assign({}, $, { files }));
            }
            else if ($.kind === 'TSC') {
                if (!$.config) {
                    throw new Error(`Missing config in: ${JSON.stringify($, null, 2)}`);
                }
                yield tsc($.config);
            }
            else {
                console.error(`Unknown compilation step ${JSON.stringify($, null, 2)}`);
            }
        }
    });
}
exports.processJson = processJson;
cli(process.argv)
    .then(() => {
    if (isWatching) {
        console.log('The compiler is watching file changes...');
        process.stdin.resume();
    }
})
    .catch(err => {
    console.error(err);
    process.exit(1);
});
process.on('unhandledRejection', e => {
    throw e;
});
function ProgressBarPlugin(options) {
    options = options || {};
    let stream = options.stream || process.stderr;
    let enabled = stream && stream.isTTY;
    if (!enabled) {
        return function () {
        };
    }
    let barLeft = chalk_1.default.bold('[');
    let barRight = chalk_1.default.bold(']');
    let preamble = chalk_1.default.cyan.bold('  build ') + barLeft;
    let barFormat = options.format || preamble + ':bar' + barRight + chalk_1.default.green.bold(' :percent');
    let summary = options.summary !== false;
    let summaryContent = options.summaryContent;
    let customSummary = options.customSummary;
    delete options.format;
    delete options.total;
    delete options.summary;
    delete options.summaryContent;
    delete options.customSummary;
    let barOptions = Object.assign({
        complete: '=',
        incomplete: ' ',
        width: 20,
        total: 100,
        clear: true
    }, options);
    let bar = new ProgressBar(barFormat, barOptions);
    let running = false;
    let startTime = new Date();
    let lastPercent = 0;
    return new webpack.ProgressPlugin(function (percent, msg) {
        if (!running && lastPercent !== 0 && !customSummary) {
            stream.write('\n');
        }
        let newPercent = Math.ceil(percent * barOptions.width);
        if (lastPercent !== newPercent) {
            bar.update(percent, {
                msg: msg
            });
            lastPercent = newPercent;
        }
        if (!running) {
            running = true;
            startTime = new Date();
            lastPercent = 0;
        }
        else if (percent === 1) {
            let now = new Date();
            let buildTime = (now.getTime() - startTime.getTime()) / 1000 + 's';
            bar.terminate();
            if (summary) {
                stream.write(chalk_1.default.green.bold('Build completed in ' + buildTime + '\n\n'));
            }
            else if (summaryContent) {
                stream.write('    ' + summaryContent + '(' + buildTime + ')\n\n');
            }
            if (customSummary) {
                customSummary(buildTime);
            }
            running = false;
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcGlsZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvbXBpbGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFJQSxtQ0FBa0M7QUFDbEMscURBQThDO0FBQzlDLGdDQUErQjtBQUMvQixpQ0FBZ0M7QUFDaEMseUJBQXdCO0FBQ3hCLCtCQUErRTtBQUMvRSxNQUFNLG1CQUFtQixHQUFHLE9BQU8sQ0FBQywrQkFBK0IsQ0FBQyxDQUFBO0FBQ3BFLGlEQUFxQztBQUNyQywyQkFBMkI7QUFDM0Isd0NBQXdDO0FBQ3hDLGlDQUF5QjtBQUV6QixNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQTtBQUM5RixNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsS0FBSyxTQUFTLENBQUMsQ0FBQTtBQUMxRCxNQUFNLGtCQUFrQixHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxLQUFLLFlBQVksQ0FBQyxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxLQUFLLFVBQVUsQ0FBQTtBQUM1RyxNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsS0FBSyxhQUFhLElBQUksQ0FBQyxVQUFVLElBQUksQ0FBQyxrQkFBa0IsQ0FBQTtBQUNqRyxNQUFNLGtCQUFrQixHQUFHLGNBQU8sQ0FBQyxTQUFTLEVBQUUsb0NBQW9DLENBQUMsQ0FBQTtBQUVuRixNQUFNLG1CQUFtQixHQUFHLENBQUMsUUFBZ0IsRUFBRSxFQUFFLENBQUM7cUNBQ2IsSUFBSSxDQUFDLFNBQVMsQ0FBQyxrQkFBa0IsQ0FBQzsyQkFDNUMsSUFBSSxDQUFD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Q2hCO2FBQU0sSUFBSSxPQUFPLEtBQUssQ0FBQyxFQUFFO1lBQ3hCLElBQUksR0FBRyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUE7WUFDcEIsSUFBSSxTQUFTLEdBQUcsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLEdBQUcsU0FBUyxDQUFDLE9BQU8sRUFBRSxDQUFDLEdBQUcsSUFBSSxHQUFHLEdBQUcsQ0FBQTtZQUVsRSxHQUFHLENBQUMsU0FBUyxFQUFFLENBQUE7WUFFZixJQUFJLE9BQU8sRUFBRTtnQkFDWCxNQUFNLENBQUMsS0FBSyxDQUFDLGVBQUssQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLHFCQUFxQixHQUFHLFNBQVMsR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFBO2FBQzNFO2lCQUFNLElBQUksY0FBYyxFQUFFO2dCQUN6QixNQUFNLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxjQUFjLEdBQUcsR0FBRyxHQUFHLFNBQVMsR0FBRyxPQUFPLENBQUMsQ0FBQTthQUNsRTtZQUVELElBQUksYUFBYSxFQUFFO2dCQUNqQixhQUFhLENBQUMsU0FBUyxDQUFDLENBQUE7YUFDekI7WUFFRCxPQUFPLEdBQUcsS0FBSyxDQUFBO1NBQ2hCO0lBQ0gsQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiIyEvdXNyL2Jpbi9lbnYgbm9kZVxuXG4vLyBUaGlzIHN0YXJ0ZWQgYXMgc29tZXRoaW5nIGRpZmZlcmVudCBhcyBpdCBpcyByaWdodCBub3cuIEl0IGJlY2FtZSBndWxwLlxuXG5pbXBvcnQgKiBhcyB3ZWJwYWNrIGZyb20gJ3dlYnBhY2snXG5pbXBvcnQgeyBDb25jYXRTb3VyY2UgfSBmcm9tICd3ZWJwYWNrLXNvdXJjZXMnXG5pbXBvcnQgKiBhcyBnbG9iUGtnIGZyb20gJ2dsb2InXG5pbXBvcnQgKiBhcyByaW1yYWYgZnJvbSAncmltcmFmJ1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnXG5pbXBvcnQgeyByZXNvbHZlLCBwYXJzZSBhcyBwYXJzZVBhdGgsIGRpcm5hbWUsIGJhc2VuYW1lLCByZWxhdGl2ZSB9IGZyb20gJ3BhdGgnXG5jb25zdCBUc2NvbmZpZ1BhdGhzUGx1Z2luID0gcmVxdWlyZSgndHNjb25maWctcGF0aHMtd2VicGFjay1wbHVnaW4nKVxuaW1wb3J0IHsgc3Bhd24gfSBmcm9tICdjaGlsZF9wcm9jZXNzJ1xuaW1wb3J0IHsgdG1wZGlyIH0gZnJvbSAnb3MnXG5pbXBvcnQgUHJvZ3Jlc3NCYXIgPSByZXF1aXJlKCdwcm9ncmVzcycpXG5pbXBvcnQgY2hhbGsgZnJvbSAnY2hhbGsnXG5cbmNvbnN0IHBhY2thZ2VKc29uID0gSlNPTi5wYXJzZShmcy5yZWFkRmlsZVN5bmMocmVxdWlyZS5yZXNvbHZlKCcuLi9wYWNrYWdlLmpzb24nKSkudG9TdHJpbmcoKSlcbmNvbnN0IGlzV2F0Y2hpbmcgPSBwcm9jZXNzLmFyZ3Yuc29tZSgkID0+ICQgPT09ICctLXdhdGNoJylcbmNvbnN0IGluc3RydW1lbnRDb3ZlcmFnZSA9IHByb2Nlc3MuYXJndi5zb21lKCQgPT4gJCA9PT0gJy0tY292ZXJhZ2UnKSB8fCBwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ2NvdmVyYWdlJ1xuY29uc3QgaXNQcm9kdWN0aW9uID0gcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdkZXZlbG9wbWVudCcgJiYgIWlzV2F0Y2hpbmcgJiYgIWluc3RydW1lbnRDb3ZlcmFnZVxuY29uc3Qgd2ViV29ya2VyVHJhbnNwb3J0ID0gcmVzb2x2ZShfX2Rpcm5hbWUsICcuLi9saWIvY29tbW9uL3RyYW5zcG9ydHMvV2ViV29ya2VyJylcblxuY29uc3QgZW50cnlQb2ludFdlYldvcmtlciA9IChmaWxlbmFtZTogc3RyaW5nKSA9PiBgXG5pbXBvcnQgeyBXZWJXb3JrZXJUcmFuc3BvcnQgfSBmcm9tICR7SlNPTi5zdHJpbmdpZnkod2ViV29ya2VyVHJhbnNwb3J0KX1cbmNvbnN0IGltcG9ydGVkID0gcmVxdWlyZSgke0pTT04uc3RyaW5naWZ5KGZpbGVuYW1lKX0pXG5cbmlmIChpbXBvcnRlZCAmJiBpbXBvcnRlZC5fX2VzTW9kdWxlICYmIGltcG9ydGVkWydkZWZhdWx0J10pIHtcbiAgbmV3IGltcG9ydGVkWydkZWZhdWx0J10oV2ViV29ya2VyVHJhbnNwb3J0KHNlbGYpKVxufVxuYFxuXG5jb25zb2xlLmxvZygnZGVjZW50cmFsYW5kLWNvbXBpbGVyIHZlcnNpb246ICcgKyBjaGFsay5ncmVlbihwYWNrYWdlSnNvbi52ZXJzaW9uKSlcblxuZXhwb3J0IGZ1bmN0aW9uIGZpbmRDb25maWdGaWxlKGJhc2VEaXI6IHN0cmluZywgY29uZmlnRmlsZU5hbWU6IHN0cmluZyk6IHN0cmluZyB8IG51bGwge1xuICBsZXQgY29uZmlnRmlsZVBhdGggPSByZXNvbHZlKGJhc2VEaXIsIGNvbmZpZ0ZpbGVOYW1lKVxuXG4gIGlmIChmcy5leGlzdHNTeW5jKGNvbmZpZ0ZpbGVQYXRoKSkge1xuICAgIHJldHVybiBjb25maWdGaWxlUGF0aFxuICB9XG5cbiAgaWYgKGJhc2VEaXIubGVuZ3RoID09PSBkaXJuYW1lKGJhc2VEaXIpLmxlbmd0aCkge1xuICAgIHJldHVybiBudWxsXG4gIH1cblxuICByZXR1cm4gZmluZENvbmZpZ0ZpbGUocmVzb2x2ZShiYXNlRGlyLCAnLi4vJyksIGNvbmZpZ0ZpbGVOYW1lKVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElDb21waWxlck9wdGlvbnMge1xuICBmaWxlczogc3RyaW5nW11cbiAgb3V0RGlyOiBzdHJpbmdcbiAgdHNjb25maWc6IHN0cmluZ1xuICB0YXJnZXQ/OiAnd2ViJyB8ICd3ZWJ3b3JrZXInIHwgJ25vZGUnIHwgJ2VzbScgfCAndGhpcydcbiAgbGlicmFyeT86IHN0cmluZ1xuICBjb3ZlcmFnZT86IGJvb2xlYW5cbiAgcm9vdEZvbGRlcjogc3RyaW5nXG4gIGZpbGVOYW1lPzogc3RyaW5nXG4gIGdsb2JhbE9iamVjdD86IHN0cmluZ1xufVxuXG5jbGFzcyBFU01vZHVsZVBsdWdpbiB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyBvcHRpb25zOiB7XG4gICAgICBleHBvcnRlZE1lbWJlcjogc3RyaW5nXG4gICAgfVxuICApIHt9XG5cbiAgYXBwbHkoY29tcGlsZXI6IHdlYnBhY2suQ29tcGlsZXIpIHtcbiAgICBjb21waWxlci5ob29rcy5jb21waWxhdGlvbi50YXAoJ0VTTW9kdWxlUGx1Z2luJywgY29tcGlsYXRpb24gPT4ge1xuICAgICAgY29tcGlsYXRpb24uaG9va3MuYWZ0ZXJPcHRpbWl6ZUNodW5rQXNzZXRzLnRhcCgnRVNNb2R1bGVQbHVnaW4nLCBjaHVua3MgPT4ge1xuICAgICAgICBmb3IgKGNvbnN0IGNodW5rIG9mIGNodW5rcykge1xuICAgICAgICAgIGlmICghY2h1bmsuY2FuQmVJbml0aWFsKCkpIHtcbiAgICAgICAgICAgIGNvbnRpbnVlXG4gICAgICAgICAgfVxuXG4gICAgICAgICAgZm9yIChjb25zdCBmaWxlIG9mIGNodW5rLmZpbGVzKSB7XG4gICAgICAgICAgICBjb21waWxhdGlvbi5hc3NldHNbZmlsZV0gPSBuZXcgQ29uY2F0U291cmNlKFxuICAgICAgICAgICAgICBjb21waWxhdGlvbi5hc3NldHNbZmlsZV0sXG4gICAgICAgICAgICAgICdcXG4nLFxuICAgICAgICAgICAgICBgZXhwb3J0IGRlZmF1bHQgJHt0aGlzLm9wdGlvbnMuZXhwb3J0ZWRNZW1iZXJ9O2BcbiAgICAgICAgICAgIClcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSlcbiAgfVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY29tcGlsZShvcHQ6IElDb21waWxlck9wdGlvbnMpIHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlPHdlYnBhY2suU3RhdHM+KChvblN1Y2Nlc3MsIG9uRXJyb3IpID0+IHtcbiAgICBsZXQgZW50cnk6IHdlYnBhY2suRW50cnkgfCBzdHJpbmdbXSA9IG9wdC5maWxlc1xuXG4gICAgY29uc3QgZXh0ZW5zaW9ucyA9IFsnLnRzJywgJy50c3gnLCAnLmpzJywgJy5qc29uJ11cblxuICAgIGlmIChvcHQudGFyZ2V0ID09PSAnd2Vid29ya2VyJykge1xuICAgICAgZW50cnkgPSBlbnRyeS5tYXAoJCA9PiB7XG4gICAgICAgIGNvbnN0IGZpbGUgPSByZXNvbHZlKHRtcGRpcigpLCBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKCkgKyAnLldlYldvcmtlci5qcycpXG4gICAgICAgIGZzLndyaXRlRmlsZVN5bmMoZmlsZSwgZW50cnlQb2ludFdlYldvcmtlcigkKSlcbiAgICAgICAgcmV0dXJuIGZpbGVcbiAgICAgIH0pXG4gICAgfVxuXG4gICAgZW50cnkgPSBlbnRyeS5yZWR1Y2UoXG4gICAgICAob2JqLCAkLCAkJCkgPT4ge1xuICAgICAgICBsZXQgbmFtZSA9IHJlbGF0aXZlKG9wdC5yb290Rm9sZGVyLCBvcHQuZmlsZXNbJCRdKVxuICAgICAgICBleHRlbnNpb25zLmZvckVhY2goJCA9PiB7XG4gICAgICAgICAgaWYgKG5hbWUuZW5kc1dpdGgoJCkpIHtcbiAgICAgICAgICAgIG5hbWUgPSBuYW1lLnN1YnN0cigwLCBuYW1lLmxlbmd0aCAtICQubGVuZ3RoKVxuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgICAgbGV0IHRhcmdldCA9IG5hbWVcbiAgICAgICAgaWYgKHRhcmdldC5lbmRzV2l0aCgnLmpzJykpIHtcbiAgICAgICAgICB0YXJnZXQgPSB0YXJnZXQuc3Vic3RyKDAsIHRhcmdldC5sZW5ndGggLSAzKVxuICAgICAgICB9XG4gICAgICAgIG9ialt0YXJnZXRdID0gJFxuICAgICAgICByZXR1cm4gb2JqXG4gICAgICB9LFxuICAgICAge30gYXMgd2VicGFjay5FbnRyeVxuICAgIClcblxuICAgIGNvbnNvbGUubG9nKFxuICAgICAgW1xuICAgICAgICBgICAgICBmaWxlczpgLFxuICAgICAgICAuLi5PYmplY3Qua2V5cyhlbnRyeSkubWFwKFxuICAgICAgICAgICgkLCAkJCkgPT4gYCAgICAgICAgICAgIChyb290KS8ke3JlbGF0aXZlKG9wdC5yb290Rm9sZGVyLCBvcHQuZmlsZXNbJCRdKX0gLT4gKG91dERpcikvJHskfS5qc2BcbiAgICAgICAgKVxuICAgICAgXS5qb2luKCdcXG4nKVxuICAgIClcblxuICAgIGNvbnN0IGxpYnJhcnlOYW1lID0gb3B0LmxpYnJhcnkgfHwgdW5kZWZpbmVkXG4gICAgY29uc3QgcGx1Z2lucyA9IFtQcm9ncmVzc0JhclBsdWdpbih7fSldXG4gICAgbGV0IGxpYnJhcnlUYXJnZXQ6IGFueSA9ICd1bWQnXG4gICAgbGV0IHRhcmdldDogd2VicGFjay5Db25maWd1cmF0aW9uWyd0YXJnZXQnXSA9ICd3ZWInXG5cbiAgICBpZiAob3B0LnRhcmdldCA9PT0gJ2VzbScpIHtcbiAgICAgIHRhcmdldCA9ICd3ZWInXG4gICAgfSBlbHNlIGlmIChvcHQudGFyZ2V0ID09PSAndGhpcycpIHtcbiAgICAgIHRhcmdldCA9ICd3ZWJ3b3JrZXInXG4gICAgfSBlbHNlIHtcbiAgICAgIHRhcmdldCA9IG9wdC50YXJnZXRcbiAgICB9XG5cbiAgICBpZiAob3B0LnRhcmdldCA9PT0gJ3RoaXMnKSB7XG4gICAgICBsaWJyYXJ5VGFyZ2V0ID0gJ3RoaXMnXG4gICAgfSBlbHNlIGlmIChvcHQudGFyZ2V0ID09PSAnd2Vid29ya2VyJykge1xuICAgICAgbGlicmFyeVRhcmdldCA9ICd0aGlzJ1xuICAgIH0gZWxzZSBpZiAob3B0LnRhcmdldCA9PT0gJ2VzbScpIHtcbiAgICAgIGxpYnJhcnlUYXJnZXQgPSAndmFyJ1xuICAgICAgaWYgKGxpYnJhcnlOYW1lKSB7XG4gICAgICAgIHBsdWdpbnMucHVzaChuZXcgRVNNb2R1bGVQbHVnaW4oeyBleHBvcnRlZE1lbWJlcjogbGlicmFyeU5hbWUgfSkpXG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3Qgb3B0aW9uczogd2VicGFjay5Db25maWd1cmF0aW9uID0ge1xuICAgICAgZW50cnksXG4gICAgICBtb2RlOiBpc1Byb2R1Y3Rpb24gPyAncHJvZHVjdGlvbicgOiAnZGV2ZWxvcG1lbnQnLFxuICAgICAgb3B0aW1pemF0aW9uOiB7XG4gICAgICAgIG5vZGVFbnY6IGlzUHJvZHVjdGlvbiA/ICdwcm9kdWN0aW9uJyA6ICdkZXZlbG9wbWVudCcsXG4gICAgICAgIG5hbWVkTW9kdWxlczogIWlzUHJvZHVjdGlvbixcbiAgICAgICAgbWluaW1pemU6IGlzUHJvZHVjdGlvblxuICAgICAgfSxcbiAgICAgIG91dHB1dDoge1xuICAgICAgICBmaWxlbmFtZTogb3B0LmZpbGVOYW1lLFxuICAgICAgICBwYXRoOiBvcHQub3V0RGlyLFxuICAgICAgICBsaWJyYXJ5VGFyZ2V0XG4gICAgICB9LFxuXG4gICAgICByZXNvbHZlOiB7XG4gICAgICAgIC8vIEFkZCAnLnRzJyBhbmQgJy50c3gnIGFzIHJlc29sdmFibGUgZXh0ZW5zaW9ucy5cbiAgICAgICAgZXh0ZW5zaW9ucyxcbiAgICAgICAgcGx1Z2luczogW25ldyBUc2NvbmZpZ1BhdGhzUGx1Z2luKHsgY29uZmlnRmlsZTogb3B0LnRzY29uZmlnIH0pXVxuICAgICAgfSxcbiAgICAgIHdhdGNoOiBpc1dhdGNoaW5nLFxuICAgICAgbW9kdWxlOiB7XG4gICAgICAgIHJ1bGVzOiBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgdGVzdDogL1xcLihqcGU/Z3xwbmd8Z2lmfHN2ZykkL2ksXG4gICAgICAgICAgICB1c2U6IFtcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGxvYWRlcjogcmVxdWlyZS5yZXNvbHZlKCd1cmwtbG9hZGVyJyksXG4gICAgICAgICAgICAgICAgb3B0aW9uczoge1xuICAgICAgICAgICAgICAgICAgbGltaXQ6IDUxMjAwMFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgXVxuICAgICAgICAgIH0sXG4gICAgICAgICAgLy8gQWxsIGZpbGVzIHdpdGggYSAnLnRzJyBvciAnLnRzeCcgZXh0ZW5zaW9uIHdpbGwgYmUgaGFuZGxlZCBieSAnYXdlc29tZS10eXBlc2NyaXB0LWxvYWRlcicuXG4gICAgICAgICAge1xuICAgICAgICAgICAgdGVzdDogL1xcLnRzeD8kLyxcbiAgICAgICAgICAgIGxvYWRlcjogcmVxdWlyZS5yZXNvbHZlKCd0cy1sb2FkZXInKSxcbiAgICAgICAgICAgIG9wdGlvbnM6IHtcbiAgICAgICAgICAgICAgY29uZmlnRmlsZTogb3B0LnRzY29uZmlnXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICBdXG4gICAgICB9LFxuICAgICAgdGFyZ2V0LFxuICAgICAgcGx1Z2luc1xuICAgIH1cblxuICAgIGlmIChvcHQuY292ZXJhZ2UpIHtcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpzZW1pY29sb25cbiAgICAgIDsob3B0aW9ucy5tb2R1bGUgYXMgYW55KS5ydWxlcy5wdXNoKHtcbiAgICAgICAgdGVzdDogL1xcLltqdF1zeD8kLyxcbiAgICAgICAgdXNlOiB7XG4gICAgICAgICAgbG9hZGVyOiAnaXN0YW5idWwtaW5zdHJ1bWVudGVyLWxvYWRlcicsXG4gICAgICAgICAgb3B0aW9uczogeyBlc01vZHVsZXM6IHRydWUsIHNvdXJjZU1hcHM6IHRydWUgfVxuICAgICAgICB9LFxuICAgICAgICBlbmZvcmNlOiAncG9zdCcsXG4gICAgICAgIGV4Y2x1ZGU6IC9ub2RlX21vZHVsZXN8XFwuc3BlY1xcLmpzJC9cbiAgICAgIH0pXG4gICAgfVxuXG4gICAgaWYgKGxpYnJhcnlOYW1lKSB7XG4gICAgICBvcHRpb25zLm91dHB1dCEubGlicmFyeSA9IGxpYnJhcnlOYW1lXG4gICAgfVxuXG4gICAgaWYgKG9wdC5nbG9iYWxPYmplY3QpIHtcbiAgICAgIG9wdGlvbnMub3V0cHV0IS5nbG9iYWxPYmplY3QgPSBvcHQuZ2xvYmFsT2JqZWN0XG4gICAgfVxuXG4gICAgY29uc3QgY29tcGlsZXIgPSB3ZWJwYWNrKG9wdGlvbnMpXG5cbiAgICBpZiAoIWlzV2F0Y2hpbmcpIHtcbiAgICAgIGNvbXBpbGVyLnJ1bigoZXJyLCBzdGF0cykgPT4ge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgb25FcnJvcihlcnIpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgb25TdWNjZXNzKHN0YXRzKVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0gZWxzZSB7XG4gICAgICBjb21waWxlci53YXRjaCh7IGlnbm9yZWQ6IC9ub2RlX21vZHVsZXMvLCBhZ2dyZWdhdGVUaW1lb3V0OiAxMDAwIH0sIChlcnIsIHN0YXRzKSA9PiB7XG4gICAgICAgIGlmIChzdGF0cy5oYXNFcnJvcnMoKSB8fCBzdGF0cy5oYXNXYXJuaW5ncygpKSB7XG4gICAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgICBzdGF0cy50b1N0cmluZyh7XG4gICAgICAgICAgICAgIGNvbG9yczogdHJ1ZSxcbiAgICAgICAgICAgICAgZXJyb3JzOiB0cnVlLFxuICAgICAgICAgICAgICB3YXJuaW5nczogdHJ1ZVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICApXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc29sZS5sb2coJ09LICcgKyBvcHQub3V0RGlyKVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFlcnIpIHtcbiAgICAgICAgICBvblN1Y2Nlc3Moc3RhdHMpXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfVxuICB9KVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdHNjKHRzY29uZmlnOiBzdHJpbmcpIHtcbiAgY29uc3QgdHNjTG9jYXRpb24gPSByZXF1aXJlLnJlc29sdmUoJ3R5cGVzY3JpcHQvbGliL3RzYycpXG5cbiAgY29uc29sZS5sb2coXG4gICAgYFxuICAgIEV4ZWN1dGluZyBcInRzYyAtcCAke2Jhc2VuYW1lKHRzY29uZmlnKX1cIiBpbiAke2Rpcm5hbWUodHNjb25maWcpfVxuICBgLnRyaW0oKVxuICApXG5cbiAgY29uc3QgYXJncyA9IFt0c2NMb2NhdGlvbiwgJy1wJywgYmFzZW5hbWUodHNjb25maWcpXVxuXG4gIGlmIChpc1dhdGNoaW5nKSB7XG4gICAgYXJncy5wdXNoKCctLXdhdGNoJylcbiAgfVxuXG4gIGNvbnN0IGNoaWxkUHJvY2VzcyA9IHNwYXduKCdub2RlJywgYXJncywge1xuICAgIGN3ZDogZGlybmFtZSh0c2NvbmZpZylcbiAgfSlcblxuICBpZiAoaXNXYXRjaGluZykge1xuICAgIHJldHVybiB0cnVlXG4gIH1cblxuICBsZXQgcmVzb2x2ZTogKHg6IGFueSkgPT4gYW55ID0gYSA9PiB2b2lkIDBcbiAgbGV0IHJlamVjdDogKHg6IGFueSkgPT4gYW55ID0gYSA9PiB2b2lkIDBcblxuICBjb25zdCBzZW1hcGhvcmUgPSBuZXcgUHJvbWlzZSgob2ssIGVycikgPT4ge1xuICAgIHJlc29sdmUgPSBva1xuICAgIHJlamVjdCA9IGVyclxuICB9KVxuXG4gIGNoaWxkUHJvY2Vzcy5zdGRvdXQub24oJ2RhdGEnLCBkYXRhID0+IHtcbiAgICBjb25zb2xlLmxvZyhgdHNjIHN0ZG91dDogJHtkYXRhfWApXG4gIH0pXG5cbiAgY2hpbGRQcm9jZXNzLnN0ZGVyci5vbignZGF0YScsIGRhdGEgPT4ge1xuICAgIGNvbnNvbGUubG9nKGB0c2Mgc3RkZXJyOiAke2RhdGF9YClcbiAgfSlcblxuICBjaGlsZFByb2Nlc3Mub24oJ2Nsb3NlJywgZXhpdENvZGUgPT4ge1xuICAgIGlmIChleGl0Q29kZSkge1xuICAgICAgcmVqZWN0KGV4aXRDb2RlKVxuICAgIH0gZWxzZSB7XG4gICAgICByZXNvbHZlKGV4aXRDb2RlKVxuICAgIH1cbiAgfSlcblxuICBhd2FpdCBzZW1hcGhvcmVcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHByb2Nlc3NGaWxlKG9wdDoge1xuICBmaWxlPzogc3RyaW5nXG4gIGZpbGVzPzogc3RyaW5nW11cbiAgb3V0RmlsZT86IHN0cmluZ1xuICB3YXRjaD86IGJvb2xlYW5cbiAgdGFyZ2V0Pzogc3RyaW5nXG4gIGNvdmVyYWdlPzogYm9vbGVhblxuICBsaWJyYXJ5Pzogc3RyaW5nXG4gIGZpbGVOYW1lPzogc3RyaW5nXG4gIGdsb2JhbE9iamVjdD86IHN0cmluZ1xufSkge1xuICBjb25zdCBiYXNlRmlsZXMgPSAob3B0LmZpbGUgJiYgW29wdC5maWxlXSkgfHwgKG9wdC5maWxlcyAmJiBvcHQuZmlsZXNbMF0pIHx8IFtdXG5cbiAgaWYgKCFiYXNlRmlsZXMubGVuZ3RoKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBVbmFibGUgdG8gZmluZCBhIGZpbGUgdG8gY29tcGlsZWApXG4gIH1cblxuICBjb25zdCBiYXNlRmlsZSA9IGJhc2VGaWxlc1swXVxuXG4gIGlmIChiYXNlRmlsZS5lbmRzV2l0aCgnLmpzb24nKSkge1xuICAgIHJldHVybiBwcm9jZXNzSnNvbihiYXNlRmlsZSlcbiAgfVxuXG4gIGNvbnN0IHBhcnNlZCA9IHBhcnNlUGF0aChiYXNlRmlsZSlcblxuICBjb25zdCBjb25maWdGaWxlID0gZmluZENvbmZpZ0ZpbGUoZGlybmFtZShiYXNlRmlsZSksICd0c2NvbmZpZy5qc29uJylcblxuICBpZiAoIWNvbmZpZ0ZpbGUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFVuYWJsZSB0byBmaW5kIGEgdHNjb25maWcuanNvbiBmaWxlIGZvciAke29wdC5maWxlfWApXG4gIH1cblxuICBjb25zdCByb290Rm9sZGVyID0gZGlybmFtZShjb25maWdGaWxlKVxuXG4gIGNvbnN0IHBhcnNlZFRzQ29uZmlnID0gcmVxdWlyZShjb25maWdGaWxlKVxuXG4gIGxldCBvdXRGaWxlID0gb3B0Lm91dEZpbGVcbiAgICA/IHJlc29sdmUocHJvY2Vzcy5jd2QoKSwgb3B0Lm91dEZpbGUpXG4gICAgOiBwYXJzZWRUc0NvbmZpZy5jb21waWxlck9wdGlvbnMub3V0RmlsZVxuICAgID8gcmVzb2x2ZShkaXJuYW1lKGNvbmZpZ0ZpbGUpLCBwYXJzZWRUc0NvbmZpZy5jb21waWxlck9wdGlvbnMub3V0RmlsZSlcbiAgICA6IHBhcnNlZC5uYW1lICsgJy5qcydcblxuICBjb25zdCBvdXREaXIgPSBwYXJzZWRUc0NvbmZpZy5jb21waWxlck9wdGlvbnMub3V0RGlyXG4gICAgPyByZXNvbHZlKGRpcm5hbWUoY29uZmlnRmlsZSksIHBhcnNlZFRzQ29uZmlnLmNvbXBpbGVyT3B0aW9ucy5vdXREaXIpXG4gICAgOiBkaXJuYW1lKG91dEZpbGUpXG5cbiAgaWYgKG91dEZpbGUuc3RhcnRzV2l0aChvdXREaXIpKSB7XG4gICAgb3V0RmlsZSA9IG91dEZpbGUucmVwbGFjZShvdXREaXIgKyAnLycsICcnKVxuICB9XG5cbiAgY29uc3QgY292ZXJhZ2UgPSAhaXNXYXRjaGluZyAmJiAob3B0LmNvdmVyYWdlIHx8IGluc3RydW1lbnRDb3ZlcmFnZSlcblxuICBjb25zdCBvcHRpb25zOiBJQ29tcGlsZXJPcHRpb25zID0ge1xuICAgIGZpbGVzOiBvcHQuZmlsZXMgfHwgW29wdC5maWxlIGFzIHN0cmluZ10sXG4gICAgb3V0RGlyLFxuICAgIHRzY29uZmlnOiBjb25maWdGaWxlLFxuICAgIGNvdmVyYWdlOiBjb3ZlcmFnZSxcbiAgICB0YXJnZXQ6IChvcHQudGFyZ2V0IGFzIGFueSkgfHwgJ3dlYicsXG4gICAgcm9vdEZvbGRlcixcbiAgICBmaWxlTmFtZTogb3B0LmZpbGVOYW1lLFxuICAgIGxpYnJhcnk6IG9wdC5saWJyYXJ5LFxuICAgIGdsb2JhbE9iamVjdDogb3B0Lmdsb2JhbE9iamVjdFxuICB9XG5cbiAgY29uc29sZS5sb2coYFxuICAgICAgcm9vdDogJHtvcHRpb25zLnJvb3RGb2xkZXJ9XG4gICAgb3V0RGlyOiAke29wdGlvbnMub3V0RGlyfVxuICAgb3B0aW9uczogeyBjb3ZlcmFnZTogJHtjb3ZlcmFnZX0sIHByb2R1Y3Rpb246ICR7aXNQcm9kdWN0aW9ufSwgd2F0Y2g6ICR7aXNXYXRjaGluZ30gfWApXG5cbiAgY29uc3QgcmVzdWx0ID0gYXdhaXQgY29tcGlsZShvcHRpb25zKVxuXG4gIGlmIChyZXN1bHQuaGFzRXJyb3JzKCkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICByZXN1bHQudG9TdHJpbmcoe1xuICAgICAgICBhc3NldHM6IHRydWUsXG4gICAgICAgIGNvbG9yczogdHJ1ZSxcbiAgICAgICAgZW50cnlwb2ludHM6IHRydWUsXG4gICAgICAgIGVudjogdHJ1ZSxcbiAgICAgICAgZXJyb3JzOiB0cnVlLFxuICAgICAgICBwdWJsaWNQYXRoOiB0cnVlXG4gICAgICB9KVxuICAgIClcbiAgfVxuXG4gIGlmIChyZXN1bHQuaGFzV2FybmluZ3MoKSkge1xuICAgIGNvbnNvbGUubG9nKFxuICAgICAgcmVzdWx0LnRvU3RyaW5nKHtcbiAgICAgICAgYXNzZXRzOiB0cnVlLFxuICAgICAgICBjb2xvcnM6IHRydWUsXG4gICAgICAgIGVudHJ5cG9pbnRzOiB0cnVlLFxuICAgICAgICBlbnY6IHRydWUsXG4gICAgICAgIGVycm9yczogdHJ1ZSxcbiAgICAgICAgcHVibGljUGF0aDogdHJ1ZVxuICAgICAgfSlcbiAgICApXG4gIH1cbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdsb2IocGF0aDogc3RyaW5nKSB7XG4gIHJldHVybiBuZXcgUHJvbWlzZTxzdHJpbmdbXT4oKG9uU3VjY2Vzcywgb25GYWlsdXJlKSA9PiB7XG4gICAgZ2xvYlBrZyhwYXRoLCB7IGFic29sdXRlOiB0cnVlIH0sIChlcnIsIHZhbHVlcykgPT4ge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICBvbkZhaWx1cmUoZXJyKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgb25TdWNjZXNzKHZhbHVlcylcbiAgICAgIH1cbiAgICB9KVxuICB9KVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY2xpKGFyZ3M6IHN0cmluZ1tdKSB7XG4gIGNvbnN0IGZpbGVzID0gYXdhaXQgZ2xvYihwcm9jZXNzLmFyZ3ZbMl0pXG5cbiAgYXdhaXQgUHJvbWlzZS5hbGwoZmlsZXMubWFwKCQgPT4gcHJvY2Vzc0ZpbGUoeyBmaWxlOiAkLCBvdXRGaWxlOiBhcmdzWzNdIH0pKSlcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHByb2Nlc3NKc29uKGZpbGU6IHN0cmluZykge1xuICBjb25zdCBjb25maWc6IGFueVtdID0gcmVxdWlyZShmaWxlKVxuXG4gIGlmICghY29uZmlnIHx8ICEoY29uZmlnIGluc3RhbmNlb2YgQXJyYXkpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDb25maWcgZmlsZSAke2ZpbGV9IGlzIG5vdCBhIHZhbGlkIHNlcXVlbmNlIG9mIHN0ZXBzYClcbiAgfVxuXG4gIGlmIChjb25maWcubGVuZ3RoID09PSAwKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDb25maWcgZmlsZSAke2ZpbGV9IGRlc2NyaWJlcyBubyBjb21waWxhdGlvbiBzdGVwc2ApXG4gIH1cblxuICBmb3IgKGxldCBpID0gMDsgaSA8IGNvbmZpZy5sZW5ndGg7IGkrKykge1xuICAgIGNvbnN0ICQgPSBjb25maWdbaV1cblxuICAgIGlmICgkLmtpbmQgPT09ICdSTScpIHtcbiAgICAgIGlmICghaXNXYXRjaGluZykge1xuICAgICAgICAvLyBkZWxldGUgYSBmb2xkZXJcbiAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgYFxuICAgICAgICAgIERlbGV0aW5nIGZvbGRlcjogJHskLnBhdGh9XG4gICAgICAgIGAudHJpbSgpXG4gICAgICAgIClcbiAgICAgICAgcmltcmFmLnN5bmMoJC5wYXRoKVxuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoJC5raW5kID09PSAnV2VicGFjaycpIHtcbiAgICAgIC8vIGNvbXBpbGUgVFNcbiAgICAgIGNvbnN0IGZpbGVzID0gYXdhaXQgZ2xvYigkLmZpbGUpXG5cbiAgICAgIGF3YWl0IHByb2Nlc3NGaWxlKHsgLi4uJCwgZmlsZXMgfSlcbiAgICB9IGVsc2UgaWYgKCQua2luZCA9PT0gJ1RTQycpIHtcbiAgICAgIGlmICghJC5jb25maWcpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBNaXNzaW5nIGNvbmZpZyBpbjogJHtKU09OLnN0cmluZ2lmeSgkLCBudWxsLCAyKX1gKVxuICAgICAgfVxuXG4gICAgICBhd2FpdCB0c2MoJC5jb25maWcpXG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoYFVua25vd24gY29tcGlsYXRpb24gc3RlcCAke0pTT04uc3RyaW5naWZ5KCQsIG51bGwsIDIpfWApXG4gICAgfVxuICB9XG59XG5cbmNsaShwcm9jZXNzLmFyZ3YpXG4gIC50aGVuKCgpID0+IHtcbiAgICBpZiAoaXNXYXRjaGluZykge1xuICAgICAgY29uc29sZS5sb2coJ1RoZSBjb21waWxlciBpcyB3YXRjaGluZyBmaWxlIGNoYW5nZXMuLi4nKVxuICAgICAgcHJvY2Vzcy5zdGRpbi5yZXN1bWUoKVxuICAgIH1cbiAgfSlcbiAgLmNhdGNoKGVyciA9PiB7XG4gICAgY29uc29sZS5lcnJvcihlcnIpXG4gICAgcHJvY2Vzcy5leGl0KDEpXG4gIH0pXG5cbnByb2Nlc3Mub24oJ3VuaGFuZGxlZFJlamVjdGlvbicsIGUgPT4ge1xuICB0aHJvdyBlXG59KVxuXG5mdW5jdGlvbiBQcm9ncmVzc0JhclBsdWdpbihvcHRpb25zOiBhbnkpIHtcbiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge31cblxuICBsZXQgc3RyZWFtID0gb3B0aW9ucy5zdHJlYW0gfHwgcHJvY2Vzcy5zdGRlcnJcbiAgbGV0IGVuYWJsZWQgPSBzdHJlYW0gJiYgc3RyZWFtLmlzVFRZXG5cbiAgaWYgKCFlbmFibGVkKSB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uKCkge1xuICAgICAgLy8gc3R1YlxuICAgIH1cbiAgfVxuXG4gIGxldCBiYXJMZWZ0ID0gY2hhbGsuYm9sZCgnWycpXG4gIGxldCBiYXJSaWdodCA9IGNoYWxrLmJvbGQoJ10nKVxuICBsZXQgcHJlYW1ibGUgPSBjaGFsay5jeWFuLmJvbGQoJyAgYnVpbGQgJykgKyBiYXJMZWZ0XG4gIGxldCBiYXJGb3JtYXQgPSBvcHRpb25zLmZvcm1hdCB8fCBwcmVhbWJsZSArICc6YmFyJyArIGJhclJpZ2h0ICsgY2hhbGsuZ3JlZW4uYm9sZCgnIDpwZXJjZW50JylcbiAgbGV0IHN1bW1hcnkgPSBvcHRpb25zLnN1bW1hcnkgIT09IGZhbHNlXG4gIGxldCBzdW1tYXJ5Q29udGVudCA9IG9wdGlvbnMuc3VtbWFyeUNvbnRlbnRcbiAgbGV0IGN1c3RvbVN1bW1hcnkgPSBvcHRpb25zLmN1c3RvbVN1bW1hcnlcblxuICBkZWxldGUgb3B0aW9ucy5mb3JtYXRcbiAgZGVsZXRlIG9wdGlvbnMudG90YWxcbiAgZGVsZXRlIG9wdGlvbnMuc3VtbWFyeVxuICBkZWxldGUgb3B0aW9ucy5zdW1tYXJ5Q29udGVudFxuICBkZWxldGUgb3B0aW9ucy5jdXN0b21TdW1tYXJ5XG5cbiAgbGV0IGJhck9wdGlvbnMgPSBPYmplY3QuYXNzaWduKFxuICAgIHtcbiAgICAgIGNvbXBsZXRlOiAnPScsXG4gICAgICBpbmNvbXBsZXRlOiAnICcsXG4gICAgICB3aWR0aDogMjAsXG4gICAgICB0b3RhbDogMTAwLFxuICAgICAgY2xlYXI6IHRydWVcbiAgICB9LFxuICAgIG9wdGlvbnNcbiAgKVxuXG4gIGxldCBiYXIgPSBuZXcgUHJvZ3Jlc3NCYXIoYmFyRm9ybWF0LCBiYXJPcHRpb25zKVxuXG4gIGxldCBydW5uaW5nID0gZmFsc2VcbiAgbGV0IHN0YXJ0VGltZTogRGF0ZSA9IG5ldyBEYXRlKClcbiAgbGV0IGxhc3RQZXJjZW50ID0gMFxuXG4gIHJldHVybiBuZXcgd2VicGFjay5Qcm9ncmVzc1BsdWdpbihmdW5jdGlvbihwZXJjZW50LCBtc2cpIHtcbiAgICBpZiAoIXJ1bm5pbmcgJiYgbGFzdFBlcmNlbnQgIT09IDAgJiYgIWN1c3RvbVN1bW1hcnkpIHtcbiAgICAgIHN0cmVhbS53cml0ZSgnXFxuJylcbiAgICB9XG5cbiAgICBsZXQgbmV3UGVyY2VudCA9IE1hdGguY2VpbChwZXJjZW50ICogYmFyT3B0aW9ucy53aWR0aClcblxuICAgIGlmIChsYXN0UGVyY2VudCAhPT0gbmV3UGVyY2VudCkge1xuICAgICAgYmFyLnVwZGF0ZShwZXJjZW50LCB7XG4gICAgICAgIG1zZzogbXNnXG4gICAgICB9KVxuICAgICAgbGFzdFBlcmNlbnQgPSBuZXdQZXJjZW50XG4gICAgfVxuXG4gICAgaWYgKCFydW5uaW5nKSB7XG4gICAgICBydW5uaW5nID0gdHJ1ZVxuICAgICAgc3RhcnRUaW1lID0gbmV3IERhdGUoKVxuICAgICAgbGFzdFBlcmNlbnQgPSAwXG4gICAgfSBlbHNlIGlmIChwZXJjZW50ID09PSAxKSB7XG4gICAgICBsZXQgbm93ID0gbmV3IERhdGUoKVxuICAgICAgbGV0IGJ1aWxkVGltZSA9IChub3cuZ2V0VGltZSgpIC0gc3RhcnRUaW1lLmdldFRpbWUoKSkgLyAxMDAwICsgJ3MnXG5cbiAgICAgIGJhci50ZXJtaW5hdGUoKVxuXG4gICAgICBpZiAoc3VtbWFyeSkge1xuICAgICAgICBzdHJlYW0ud3JpdGUoY2hhbGsuZ3JlZW4uYm9sZCgnQnVpbGQgY29tcGxldGVkIGluICcgKyBidWlsZFRpbWUgKyAnXFxuXFxuJykpXG4gICAgICB9IGVsc2UgaWYgKHN1bW1hcnlDb250ZW50KSB7XG4gICAgICAgIHN0cmVhbS53cml0ZSgnICAgICcgKyBzdW1tYXJ5Q29udGVudCArICcoJyArIGJ1aWxkVGltZSArICcpXFxuXFxuJylcbiAgICAgIH1cblxuICAgICAgaWYgKGN1c3RvbVN1bW1hcnkpIHtcbiAgICAgICAgY3VzdG9tU3VtbWFyeShidWlsZFRpbWUpXG4gICAgICB9XG5cbiAgICAgIHJ1bm5pbmcgPSBmYWxzZVxuICAgIH1cbiAgfSlcbn1cbiJdfQ==